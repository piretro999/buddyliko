<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings ‚Äî Buddyliko</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32.png">
    <script src="/lang/i18n.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#f8fafc;--card:#fff;--border:#e2e8f0;--blue:#2196f3;--blue2:#1565c0;--green:#10b981;--purple:#7c3aed;--red:#ef4444;--orange:#f59e0b;--text:#1e293b;--text2:#64748b;--text3:#94a3b8}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
        a{color:var(--blue);text-decoration:none}
        .topbar{background:#fff;border-bottom:1px solid var(--border);padding:0 32px;height:56px;display:flex;align-items:center;justify-content:space-between}
        .topbar img{height:36px}
        .topbar-links{display:flex;gap:20px;align-items:center;font-size:14px}
        .topbar-links a{color:var(--text2);font-weight:500}.topbar-links a:hover{color:var(--text)}
        .topbar-links .active{color:var(--blue);font-weight:600}
        .container{max-width:700px;margin:0 auto;padding:32px 24px}
        h1{font-size:28px;font-weight:700;margin-bottom:8px}
        .page-sub{color:var(--text2);margin-bottom:32px;font-size:15px}
        .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:28px;margin-bottom:20px}
        .card h2{font-size:18px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
        .provider-card{border:2px solid var(--border);border-radius:12px;padding:20px;margin-bottom:12px;transition:all .3s}
        .provider-card.linked{border-color:var(--green);background:#f0fdf4}
        .provider-card:hover{border-color:var(--blue);box-shadow:0 4px 12px rgba(33,150,243,.1)}
        .provider-header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
        .provider-info{display:flex;align-items:center;gap:12px}
        .provider-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;background:#f5f5f5}
        .provider-icon.google{background:#fff;border:2px solid #4285F4}
        .provider-icon.github{background:#24292e;color:white}
        .provider-icon.email{background:#666;color:white}
        .provider-name{font-weight:600;color:var(--text)}
        .provider-email{font-size:13px;color:var(--text2)}
        .provider-meta{font-size:12px;color:var(--text3);margin-top:4px}
        .badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}
        .badge-primary{background:#FFD700;color:#000}
        .badge-linked{background:var(--green);color:white}
        .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
        .btn:hover{transform:translateY(-1px)}
        .btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{background:var(--blue2)}
        .btn-outline{border:2px solid var(--border);color:var(--text2);background:#fff}.btn-outline:hover{border-color:var(--blue);color:var(--blue)}
        .btn-danger{border:2px solid var(--red);color:var(--red);background:#fff}.btn-danger:hover{background:var(--red);color:#fff}
        .btn-sm{padding:6px 12px;font-size:12px}
        .alert{padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:14px;display:flex;align-items:center;gap:10px;animation:fadeIn .3s}
        .alert-success{background:#e8f5e9;color:#2e7d32;border-left:4px solid #4caf50}
        .alert-error{background:#ffebee;color:#c62828;border-left:4px solid #f44336}
        .alert-info{background:#e3f2fd;color:#1565c0;border-left:4px solid #2196f3}
        .user-info{background:#f1f5f9;padding:20px;border-radius:12px;margin-bottom:24px}
        .user-info h3{font-size:18px;margin-bottom:8px}
        .user-info p{color:var(--text2);font-size:14px;margin:4px 0}
        .btn-actions{display:flex;gap:8px;flex-wrap:wrap}
        @keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
        @media(max-width:768px){.topbar{padding:0 16px}.container{padding:20px 16px}.provider-header{flex-direction:column;align-items:flex-start}}
    </style>
</head>
<body>
    <div class="topbar">
        <a href="/"><img src="/assets/logo-new.png" alt="Buddyliko"></a>
        <div class="topbar-links">
            <a href="app.html" data-i18n="nav.mapper">Mapper</a>
            <a href="account.html" data-i18n="nav.account">Account</a>
            <a href="account-settings.html" class="active" data-i18n="nav.settings">Impostazioni</a>
            <span id="lang-switcher"></span>
        </div>
    </div>

    <div class="container">
        <h1 data-i18n="account_settings.title">Impostazioni Account</h1>
        <p class="page-sub" data-i18n="account_settings.subtitle">Gestisci i tuoi metodi di autenticazione</p>

        <div id="alerts"></div>

        <div class="user-info" id="userInfo" style="display:none">
            <h3 id="userName"></h3>
            <p><strong data-i18n="account.email">Email</strong>: <span id="userEmail"></span></p>
            <p><strong data-i18n="account.role">Ruolo</strong>: <span id="userRole"></span></p>
            <p><strong data-i18n="account.status">Stato</strong>: <span id="userStatus"></span></p>
        </div>

        <div class="card">
            <h2>üîë <span data-i18n="account_settings.linked_logins">Metodi di autenticazione collegati</span></h2>
            <div id="providersContainer">
                <div class="alert alert-info">
                    <span data-i18n="account_settings.loading_account">Caricamento account...</span>
                </div>
            </div>
        </div>

        <div class="card" id="availableProviders" style="display:none">
            <h2>‚ûï <span data-i18n="account_settings.available_providers">Provider disponibili</span></h2>
            <div id="availableContainer"></div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let accessToken = localStorage.getItem('buddyliko_token');
        let currentUser = null;
        const T = (key, rep) => typeof i18n !== 'undefined' && i18n.isLoaded() ? i18n.t(key, rep) : key;

        if (!accessToken) { window.location.href = 'login.html'; }

        function showAlert(msg, type = 'success') {
            const div = document.createElement('div');
            div.className = `alert alert-${type}`;
            div.textContent = msg;
            const el = document.getElementById('alerts');
            el.insertBefore(div, el.firstChild);
            setTimeout(() => div.remove(), 3500);
        }

        async function getCurrentUser() {
            try {
                const r = await fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                if (!r.ok) { window.location.href = 'login.html'; return; }
                const data = await r.json();
                currentUser = data.user || data;
                displayUser();
                loadProviders();
            } catch (e) {
                showAlert(T('account_settings.access_denied'), 'error');
                setTimeout(() => window.location.href = 'login.html', 2000);
            }
        }

        function displayUser() {
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userRole').textContent = currentUser.role;
            document.getElementById('userStatus').textContent = currentUser.status;
        }

        async function loadProviders() {
            try {
                const r = await fetch(`${API_URL}/auth/providers`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const providers = await r.json();
                displayProviders(providers);
            } catch (e) {
                showAlert(T('account_settings.failed_load'), 'error');
            }
        }

        function displayProviders(providers) {
            const container = document.getElementById('providersContainer');
            const availableContainer = document.getElementById('availableContainer');
            container.innerHTML = '';
            availableContainer.innerHTML = '';

            const allProviders = ['EMAIL', 'GOOGLE', 'GITHUB'];
            const linkedProviders = providers.map(p => p.provider);

            providers.forEach(p => container.appendChild(createProviderCard(p, true)));

            const available = allProviders.filter(p => !linkedProviders.includes(p));
            if (available.length > 0) {
                document.getElementById('availableProviders').style.display = 'block';
                available.forEach(name => availableContainer.appendChild(createProviderCard({ provider: name }, false)));
            }
        }

        function createProviderCard(provider, isLinked) {
            const card = document.createElement('div');
            card.className = `provider-card ${isLinked ? 'linked' : ''}`;
            const icons = { EMAIL: '‚úâÔ∏è', GOOGLE: 'üîµ', GITHUB: '‚ö´' };
            const names = { EMAIL: 'Email / Password', GOOGLE: 'Google', GITHUB: 'GitHub' };

            let html = `<div class="provider-header"><div class="provider-info">
                <div class="provider-icon ${provider.provider.toLowerCase()}">${icons[provider.provider] || 'üîë'}</div>
                <div><div class="provider-name">${names[provider.provider] || provider.provider}</div>`;

            if (isLinked) {
                if (provider.provider_email) html += `<div class="provider-email">${provider.provider_email}</div>`;
                if (provider.is_primary) html += `<div class="provider-meta"><span class="badge badge-primary">${T('account_settings.primary')}</span></div>`;
                else html += `<div class="provider-meta"><span class="badge badge-linked">${T('account_settings.linked')}</span></div>`;
                if (provider.last_used_at) html += `<div class="provider-meta">${T('account_settings.last_used')}: ${new Date(provider.last_used_at).toLocaleDateString()}</div>`;
            }

            html += `</div></div><div class="btn-actions">`;

            if (isLinked) {
                if (!provider.is_primary) html += `<button class="btn btn-outline btn-sm" onclick="setPrimary('${provider.provider}')">${T('account_settings.set_primary')}</button>`;
                if (provider.provider !== 'EMAIL') html += `<button class="btn btn-danger btn-sm" onclick="unlinkProvider('${provider.provider}')">‚ùå ${T('account_settings.unlink')}</button>`;
            } else {
                html += `<button class="btn btn-primary btn-sm" onclick="linkProvider('${provider.provider}')">${T('account_settings.link_provider', { provider: names[provider.provider] || provider.provider })}</button>`;
            }

            html += `</div></div>`;
            card.innerHTML = html;
            return card;
        }

        async function linkProvider(provider) {
            try {
                const r = await fetch(`${API_URL}/auth/${provider.toLowerCase()}/login`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const data = await r.json();
                window.location.href = data.url || data.auth_url;
            } catch (e) {
                showAlert(T('account_settings.failed_link', { provider }), 'error');
            }
        }

        async function unlinkProvider(provider) {
            if (!confirm(T('account_settings.unlink_confirm', { provider }))) return;
            try {
                const r = await fetch(`${API_URL}/auth/providers/${provider.toLowerCase()}/unlink`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${accessToken}` } });
                if (r.ok) { showAlert(T('account_settings.unlinked_success', { provider })); loadProviders(); }
                else { const e = await r.json(); showAlert(e.detail || T('account_settings.failed_unlink'), 'error'); }
            } catch (e) { showAlert(T('account_settings.failed_unlink'), 'error'); }
        }

        async function setPrimary(provider) {
            try {
                const r = await fetch(`${API_URL}/auth/providers/${provider.toLowerCase()}/set-primary`, { method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}` } });
                if (r.ok) { showAlert(T('account_settings.primary_set', { provider })); loadProviders(); }
                else showAlert(T('account_settings.failed_primary'), 'error');
            } catch (e) { showAlert(T('account_settings.failed_primary'), 'error'); }
        }

        // Handle OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('code') && urlParams.has('state')) {
            window.history.replaceState({}, document.title, window.location.pathname);
            setTimeout(() => getCurrentUser(), 1000);
        }

        // Init
        (async () => {
            await i18n.init();
            i18n.createSwitcher('lang-switcher');
            window.addEventListener('langchange', () => loadProviders());
            getCurrentUser();
        })();
    </script>
<script src="/assets/theme.js"></script>
</body>
</html>
