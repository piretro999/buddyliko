<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Buddyliko</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32.png">
    <link rel="apple-touch-icon" href="/assets/favicon-180.png">
    <script src="/lang/i18n.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#00BCD4 0%,#3F51B5 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .login-container{background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);width:100%;max-width:440px;padding:50px 40px;animation:slideUp .5s ease-out;position:relative}
        @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
        .logo{text-align:center;margin-bottom:40px}
        .logo img{width:100%;max-width:360px;height:auto;margin:0 auto 16px;display:block;border-radius:8px}
        .logo .tagline{color:#666;font-size:14px;font-weight:500;margin-bottom:4px}
        .logo .etymology{color:#999;font-size:12px;font-style:italic}
        .lang-corner{position:absolute;top:16px;right:16px}
        .tabs{display:flex;gap:10px;margin-bottom:30px;border-bottom:2px solid #f0f0f0}
        .tab{flex:1;padding:12px;background:none;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:16px;font-weight:600;color:#999;transition:all .3s}
        .tab.active{color:#00BCD4;border-bottom-color:#00BCD4}
        .tab:hover{color:#00BCD4}
        .tab-content{display:none}.tab-content.active{display:block;animation:fadeIn .3s ease-in}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .form-group{margin-bottom:20px}
        label{display:block;font-size:14px;font-weight:600;color:#333;margin-bottom:8px}
        input{width:100%;padding:14px 16px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;transition:all .3s}
        input:focus{outline:none;border-color:#00BCD4;box-shadow:0 0 0 3px rgba(33,150,243,.1)}
        .btn{width:100%;padding:16px;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:.5px}
        .btn-primary{background:linear-gradient(135deg,#00BCD4 0%,#3F51B5 100%);color:#fff}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(33,150,243,.4)}
        .divider{text-align:center;margin:30px 0;position:relative}
        .divider::before{content:'';position:absolute;left:0;top:50%;width:100%;height:1px;background:#e0e0e0}
        .divider span{background:#fff;padding:0 20px;position:relative;color:#999;font-size:13px;font-weight:600}
        .oauth-buttons{display:flex;flex-direction:column;gap:12px}
        .btn-oauth{display:flex;align-items:center;justify-content:center;gap:12px;padding:14px;border:2px solid #e0e0e0;border-radius:10px;background:#fff;cursor:pointer;font-size:15px;font-weight:600;transition:all .3s}
        .btn-oauth:hover{border-color:#00BCD4;background:#f8f9ff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
        .btn-google{color:#4285f4}.btn-github{color:#333}
        .alert{padding:12px 16px;border-radius:8px;margin-bottom:20px;font-size:14px}
        .alert-error{background:#fee;color:#c33;border:1px solid #fcc}
        .alert-success{background:#efe;color:#3c3;border:1px solid #cfc}
        .loading{text-align:center;color:#00BCD4;font-size:14px;margin:20px 0}
        .hidden{display:none!important}
        .warning-banner{background:linear-gradient(135deg,#ff6b35,#d63031);color:#fff;border-radius:12px;padding:20px;margin-bottom:24px;text-align:center;box-shadow:0 4px 15px rgba(214,48,49,.3)}
        .warning-banner .wb-icon{font-size:28px;margin-bottom:8px}
        .warning-banner .wb-title{font-weight:700;font-size:16px;margin-bottom:6px}
        .warning-banner .wb-text{font-size:13px;line-height:1.5;opacity:.95}
        @media(max-width:480px){body{padding:10px}.login-container{padding:30px 24px;border-radius:16px}.logo img{max-width:280px}.btn{padding:14px;font-size:14px}.btn-oauth{padding:12px;font-size:14px}}
    </style>
</head>
<body>
    <div class="login-container">
        <div class="lang-corner" id="lang-switcher"></div>
        <div class="logo">
            <img src="/assets/logo-new.png" alt="Buddyliko">
            <p class="tagline">Transform Your Data</p>
            <p class="etymology">Badiliko (Swahili: Change)</p>
        </div>
        <div class="warning-banner">
            <div class="wb-icon">üöß</div>
            <div class="wb-title" data-i18n="login.service_title">Servizio non ancora attivo</div>
            <div class="wb-text"><span data-i18n="login.service_desc">Buddyliko √® attualmente in fase di sviluppo.</span><br><span data-i18n-html="login.service_warn">Le registrazioni non autorizzate <strong>non verranno attivate</strong> e gli account verranno cancellati.</span></div>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('login')" data-i18n="login.tab_login">Login</button>
            <button class="tab" onclick="switchTab('register')" data-i18n="login.tab_register">Registrati</button>
        </div>
        <div id="alert" class="alert hidden"></div>
        <div id="login-tab" class="tab-content active">
            <form id="login-form">
                <div class="form-group"><label data-i18n="login.email">Email</label><input type="email" id="login-email" required placeholder="your@email.com"></div>
                <div class="form-group"><label data-i18n="login.password">Password</label><input type="password" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button type="submit" class="btn btn-primary"><span data-i18n="login.btn_login">LOGIN</span></button>
            </form>
            <div class="divider" id="oauth-divider"><span data-i18n="login.or_continue">O CONTINUA CON</span></div>
            <div class="oauth-buttons" id="oauth-buttons"></div>
        </div>
        <div id="register-tab" class="tab-content">
            <form id="register-form">
                <div class="form-group"><label data-i18n="login.full_name">Nome completo</label><input type="text" id="register-name" placeholder="Mario Rossi"></div>
                <div class="form-group"><label data-i18n="login.email">Email</label><input type="email" id="register-email" required placeholder="your@email.com"></div>
                <div class="form-group"><label data-i18n="login.password">Password</label><input type="password" id="register-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6"></div>
                <button type="submit" class="btn btn-primary"><span data-i18n="login.btn_register">REGISTRATI</span></button>
            </form>
            <div class="divider" id="oauth-divider-register"><span data-i18n="login.or_continue">O CONTINUA CON</span></div>
            <div class="oauth-buttons" id="oauth-buttons-register"></div>
        </div>
        <div id="loading" class="loading hidden" data-i18n="common.loading">Caricamento...</div>
    </div>
    <script>
        const API_BASE = '';
        window.addEventListener('load', async () => {
            await i18n.init();
            i18n.createSwitcher('lang-switcher');
            window.addEventListener('langchange', () => loadOAuthProviders());
            const token = localStorage.getItem('buddyliko_token');
            if (token) { try { const r = await fetch(API_BASE+'/api/auth/me',{headers:{'Authorization':'Bearer '+token}}); if(r.ok){window.location.href='app.html';return;} } catch(e){localStorage.removeItem('buddyliko_token');} }
            loadOAuthProviders();
        });
        async function loadOAuthProviders() {
            try {
                const r = await fetch(API_BASE+'/api/auth/status'); const data = await r.json();
                if (!data.enabled) { window.location.href='app.html'; return; }
                const p = data.providers; let html = '';
                if (p.google) { html += '<button class="btn-oauth btn-google" onclick="loginWithGoogle()"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>'+i18n.t('login.continue_google')+'</button>'; }
                if (p.github) { html += '<button class="btn-oauth btn-github" onclick="loginWithGitHub()"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#333" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>'+i18n.t('login.continue_github')+'</button>'; }
                if (html) { document.getElementById('oauth-buttons').innerHTML=html; document.getElementById('oauth-buttons-register').innerHTML=html; }
                else { document.getElementById('oauth-divider').classList.add('hidden'); document.getElementById('oauth-divider-register').classList.add('hidden'); }
            } catch(e) { console.error('OAuth error:', e); }
        }
        function switchTab(tab) { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); if(tab==='login'){document.querySelectorAll('.tab')[0].classList.add('active');document.getElementById('login-tab').classList.add('active');}else{document.querySelectorAll('.tab')[1].classList.add('active');document.getElementById('register-tab').classList.add('active');} hideAlert(); }
        function showAlert(msg,type='error'){const a=document.getElementById('alert');a.innerHTML=msg;a.className='alert alert-'+type;}
        function hideAlert(){document.getElementById('alert').classList.add('hidden');}
        function showLoading(){document.getElementById('loading').classList.remove('hidden');}
        function hideLoading(){document.getElementById('loading').classList.add('hidden');}
        document.getElementById('login-form').addEventListener('submit', async(e) => {
            e.preventDefault();hideAlert();showLoading();
            const email=document.getElementById('login-email').value, password=document.getElementById('login-password').value;
            try { const r=await fetch(API_BASE+'/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}); const data=await r.json();
                if(r.ok){ if(data.mfa_required){showMfaForm(data);}else{localStorage.setItem('buddyliko_token',data.token);localStorage.setItem('buddyliko_user',JSON.stringify(data.user||data));showAlert(i18n.t('login.login_success'),'success');setTimeout(()=>window.location.href='app.html',1000);}}
                else{const detail=data.detail||i18n.t('login.login_failed');if(detail.includes('non verificata')||detail.includes('not verified')){showAlert(detail+'<br><a href="#" onclick="resendVerification(\''+email+'\')" style="color:#2196f3;text-decoration:underline;font-weight:600">'+i18n.t('login.resend_verification')+'</a>');}else{showAlert(detail);}}
            }catch(e){showAlert(i18n.t('login.connection_error'));}finally{hideLoading();}
        });
        let mfaState={};
        function showMfaForm(data){mfaState=data;const m=data.mfa_methods||[],T=i18n.t.bind(i18n);document.getElementById('login-tab').innerHTML='<div style="text-align:center;margin-bottom:20px"><div style="font-size:40px;margin-bottom:8px">üîê</div><h3 style="margin-bottom:4px">'+T('login.mfa_title')+'</h3><p style="color:#64748b;font-size:13px">'+T('login.mfa_subtitle')+'</p></div>'+(m.length>1?'<div style="display:flex;gap:8px;margin-bottom:16px;justify-content:center">'+(m.includes('totp')?'<button class="tab" onclick="switchMfaMethod(\'totp\')" id="mfa-tab-totp" style="padding:6px 16px;font-size:12px">'+T('login.mfa_authenticator')+'</button>':'')+(m.includes('email')?'<button class="tab" onclick="switchMfaMethod(\'email\')" id="mfa-tab-email" style="padding:6px 16px;font-size:12px">'+T('login.mfa_email')+'</button>':'')+'</div>':'')+'<div id="mfa-input-area"><input type="text" id="mfa-code" placeholder="000000" maxlength="6" style="width:100%;text-align:center;font-size:28px;letter-spacing:8px;padding:14px;margin-bottom:16px;border:2px solid #e2e8f0;border-radius:10px;font-weight:700" inputmode="numeric"></div><button onclick="verifyMfa()" style="width:100%;padding:12px;background:linear-gradient(135deg,#2196f3,#7c3aed);color:#fff;border:none;border-radius:8px;font-weight:600;font-size:15px;cursor:pointer">'+T('login.mfa_verify')+'</button><button onclick="location.reload()" style="width:100%;padding:10px;background:transparent;border:1px solid #e2e8f0;border-radius:8px;margin-top:8px;cursor:pointer;color:#64748b;font-size:13px">'+T('login.mfa_back')+'</button>';if(m.includes('totp'))switchMfaMethod('totp');else if(m.includes('email'))switchMfaMethod('email');document.getElementById('mfa-code').focus();}
        function switchMfaMethod(method){mfaState.selectedMethod=method;document.querySelectorAll('[id^="mfa-tab-"]').forEach(t=>t.classList.remove('active'));const tab=document.getElementById('mfa-tab-'+method);if(tab)tab.classList.add('active');const T=i18n.t.bind(i18n);if(method==='email'){document.getElementById('mfa-input-area').innerHTML='<p style="font-size:13px;color:#64748b;margin-bottom:12px;text-align:center">'+T('login.mfa_code_sent')+' '+mfaState.user_email+'</p><input type="text" id="mfa-code" placeholder="000000" maxlength="6" style="width:100%;text-align:center;font-size:28px;letter-spacing:8px;padding:14px;margin-bottom:8px;border:2px solid #e2e8f0;border-radius:10px;font-weight:700" inputmode="numeric"><button onclick="resendMfaCode()" style="background:none;border:none;color:#2196f3;font-size:12px;cursor:pointer;margin-bottom:12px">'+T('login.mfa_resend')+'</button>';}else{document.getElementById('mfa-input-area').innerHTML='<p style="font-size:13px;color:#64748b;margin-bottom:12px;text-align:center">'+T('login.mfa_enter_auth')+'</p><input type="text" id="mfa-code" placeholder="000000" maxlength="6" style="width:100%;text-align:center;font-size:28px;letter-spacing:8px;padding:14px;margin-bottom:16px;border:2px solid #e2e8f0;border-radius:10px;font-weight:700" inputmode="numeric">';}document.getElementById('mfa-code').focus();}
        async function verifyMfa(){const code=document.getElementById('mfa-code').value.trim();if(code.length!==6){showAlert(i18n.t('login.mfa_enter_6'));return;}showLoading();try{const body={mfa_token:mfaState.mfa_token,code,method:mfaState.selectedMethod||'totp'};if(mfaState.mfa_email_token)body.mfa_email_token=mfaState.mfa_email_token;const r=await fetch(API_BASE+'/api/auth/mfa/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});const data=await r.json();if(r.ok){localStorage.setItem('buddyliko_token',data.token);localStorage.setItem('buddyliko_user',JSON.stringify(data.user||data));showAlert(i18n.t('login.mfa_verified'),'success');setTimeout(()=>window.location.href='app.html',800);}else{showAlert(data.detail||i18n.t('login.mfa_invalid'));}}catch(e){showAlert(i18n.t('login.connection_error'));}finally{hideLoading();}}
        async function resendMfaCode(){try{const r=await fetch(API_BASE+'/api/auth/mfa/send-email-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mfa_token:mfaState.mfa_token})});const d=await r.json();if(r.ok&&d.mfa_email_token){mfaState.mfa_email_token=d.mfa_email_token;showAlert(i18n.t('login.mfa_new_sent'),'success');}}catch(e){}}
        async function resendVerification(email){try{await fetch(API_BASE+'/api/auth/resend-verification',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});showAlert('üìß '+(i18n.getLang()==='it'?'Email di verifica reinviata!':'Verification email resent!'),'success');}catch(e){}}
        (function(){const p=new URLSearchParams(window.location.search);const t=p.get('verify');if(t){fetch(API_BASE+'/api/auth/verify-email?token='+encodeURIComponent(t)).then(r=>r.json()).then(d=>{if(d.success)showAlert('‚úÖ '+d.message,'success');else showAlert(d.detail||'Error');}).catch(()=>showAlert('Connection error'));window.history.replaceState({},'','login.html');}})();
        document.getElementById('register-form').addEventListener('submit',async(e)=>{e.preventDefault();hideAlert();showLoading();const name=document.getElementById('register-name').value,email=document.getElementById('register-email').value,password=document.getElementById('register-password').value;try{const r=await fetch(API_BASE+'/api/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email,password})});const data=await r.json();if(r.ok){showAlert('‚úÖ '+i18n.t('login.register_success'),'success');setTimeout(()=>switchTab('login'),5000);}else{showAlert(data.detail||i18n.t('login.login_failed'));}}catch(e){showAlert(i18n.t('login.connection_error'));}finally{hideLoading();}});
        async function loginWithGoogle(){try{const r=await fetch(API_BASE+'/api/auth/google/login');const d=await r.json();window.location.href=d.auth_url;}catch(e){showAlert('Failed to connect to Google');}}
        async function loginWithGitHub(){try{const r=await fetch(API_BASE+'/api/auth/github/login');const d=await r.json();window.location.href=d.auth_url;}catch(e){showAlert('Failed to connect to GitHub');}}
    </script>
<script src="/assets/theme.js"></script>
</body>
</html>
