<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buddyliko - Your Buddy in transformations</title>
    
    <link rel="icon" type="image/svg+xml" href="/assets/logo-icon.svg">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* Responsive Sidebar */
        .sidebar {
            width: 350px;
            min-width: 280px;
            background: white;
            border-right: 2px solid #ddd;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .sidebar.collapsed {
            width: 0 !important;
            min-width: 0 !important;
            overflow: hidden;
            border: none;
        }
        
        /* Toggle button for sidebar */
        .sidebar-toggle {
            position: fixed;
            left: 10px;
            bottom: 10px;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #00BCD4 0%, #3F51B5 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        
        .sidebar-toggle:hover {
            background: linear-gradient(135deg, #00ACC1 0%, #3949AB 100%);
            transform: scale(1.1);
        }
        
        .sidebar-header {
            padding: 0;
            background: #0a1628;
            color: white;
        }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            background: #fafafa;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00BCD4 0%, #3F51B5 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .user-details {
            flex: 1;
            font-size: 13px;
        }
        
        .user-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .user-email {
            color: #666;
            font-size: 11px;
        }
        
        .btn-logout {
            width: 100%;
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            border-color: #00BCD4;
            color: #00BCD4;
            background: #f8f9ff;
        }
        .main-canvas {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Important for flex shrinking */
        }
        
        /* Responsive Toolbar */
        .toolbar {
            background: white;
            border-bottom: 2px solid #ddd;
            padding: 12px 15px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            overflow-x: auto;
        }
        
        .canvas-area {
            flex: 1;
            background: #fafafa;
            overflow: auto;
            padding: 20px;
            position: relative;
        }
        
        /* Responsive Properties Panel */
        .properties-panel {
            width: 350px;
            min-width: 280px;
            background: white;
            border-left: 2px solid #ddd;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* UNIFORM BUTTON SIZES */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            min-width: 140px;        /* ALL BUTTONS SAME WIDTH */
            height: 42px;            /* ALL BUTTONS SAME HEIGHT */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;          /* Don't shrink */
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary { 
            background: #00BCD4; 
            color: white; 
        }
        .btn-primary:hover:not(:disabled) { 
            background: #5568d3; 
        }
        
        .btn-secondary { 
            background: #e0e0e0; 
            color: #333; 
        }
        .btn-secondary:hover:not(:disabled) { 
            background: #d0d0d0; 
        }
        
        .btn-success { 
            background: #4caf50; 
            color: white; 
        }
        .btn-success:hover:not(:disabled) { 
            background: #43a047; 
        }
        
        .btn-danger { 
            background: #f44336; 
            color: white; 
        }
        .btn-danger:hover:not(:disabled) { 
            background: #e53935; 
        }
        
        /* Full width buttons (sidebar) */
        .btn-full {
            width: 100%;
            min-width: 100%;
            margin-bottom: 10px;
        }
        
        /* Uniform input fields */
        input[type="text"], select, textarea {
            height: 42px;            /* SAME AS BUTTONS */
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 13px;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00BCD4;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        /* Search input specific */
        .search-input {
            width: 280px;
            font-family: 'Courier New', monospace;
        }
        
        .field-box {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
            /* Word wrap and dynamic height */
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            min-height: auto;
            height: auto;
        }

        /* Node action buttons ‚Äî hidden by default, visible on hover */
        .field-box-actions {
            position: absolute;
            top: 4px;
            right: 4px;
            display: none;
            gap: 3px;
            z-index: 10;
        }
        .field-box:hover .field-box-actions {
            display: flex;
        }
        .field-action-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.85;
            transition: all 0.15s;
        }
        .field-action-btn:hover { opacity: 1; transform: scale(1.15); }
        .field-action-btn.edit  { background: #e3f2fd; color: #1565c0; }
        .field-action-btn.delete { background: #ffebee; color: #c62828; }
        
        /* Removed resize handle from cells */
        .field-box:hover {
            border-color: #00BCD4;
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(102,126,234,0.2);
        }
        .field-box.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .field-box.selected {
            border-color: #4caf50;
            background: #e8f5e9;
            border-width: 3px;
        }
        .field-box.required {
            border-left: 4px solid #4caf50;
        }
        .field-box.calculated {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .field-box.highlighted {
            background: #fffacd !important;  /* Light yellow */
            border-color: #ffd700 !important;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            animation: pulse-highlight 1s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.3); }
        }
        @keyframes shimmer {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        @keyframes pulse-highlight {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
        }
        
        .field-name {
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }
        .field-business {
            font-size: 11px;
            color: #666;
            font-style: italic;
            margin-bottom: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .field-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .field-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #e0e0e0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        
        .canvas-columns {
            display: flex;
            gap: 40px;
            position: relative;
            height: 100%;
            justify-content: space-between;
        }
        .canvas-column {
            flex: 1;
            min-width: 300px;
            max-height: 100%;
            overflow-y: auto;
            overflow-x: visible;      /* VISIBLE per mostrare handles! */
            position: relative;
        }
        
        /* Input handle - RIGHT side, slightly UP - MORE VISIBLE */
        .resize-handle-input {
            position: absolute;
            right: -16px;              /* Closer to edge */
            top: calc(50% - 50px);     /* Slightly UP */
            width: 16px;               /* Wider */
            height: 60px;              /* Taller */
            background: #00BCD4;       /* Blue by default */
            border: 2px solid white;
            border-radius: 4px;
            cursor: ew-resize;
            z-index: 500;              /* Higher z-index */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            user-select: none;
            transition: all 0.15s;
        }
        
        .resize-handle-input:hover {
            background: #5568d3;
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.5);
        }
        
        /* Output handle - LEFT side, slightly DOWN - MORE VISIBLE */
        .resize-handle-output {
            position: absolute;
            left: -16px;               /* Closer to edge */
            top: calc(50% + 50px);     /* Slightly DOWN */
            width: 16px;               /* Wider */
            height: 60px;              /* Taller */
            background: #00BCD4;       /* Blue by default */
            border: 2px solid white;
            border-radius: 4px;
            cursor: ew-resize;
            z-index: 500;              /* Higher z-index */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            user-select: none;
            transition: all 0.15s;
        }
        
        .resize-handle-output:hover {
            background: #5568d3;
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.5);
        }
        .canvas-column h3 {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: default;
            user-select: none;
        }
        
        /* Draggable area on right edge of headers */
        .canvas-column h3::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 20px;
            cursor: ew-resize;
            background: linear-gradient(to left, rgba(102, 126, 234, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .canvas-column h3:hover::after {
            opacity: 1;
        }
        
        svg.connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: visible;
        }
        svg.connections path {
            pointer-events: stroke;
            cursor: pointer;
        }
        .connection-line {
            fill: none;
            stroke: #00BCD4;
            stroke-width: 3;
            transition: none; /* Remove transition to avoid lag during scroll */
        }
        .connection-line:hover {
            stroke: #4caf50;
            stroke-width: 4;
        }
        .connection-line.selected {
            stroke: #f44336;
            stroke-width: 4;
            stroke-dasharray: 5,5;
            animation: dash 0.5s linear infinite;
        }
        @keyframes dash {
            to { stroke-dashoffset: -10; }
        }
        .connection-arrow {
            fill: #00BCD4;
        }
        
        /* Hover Popup */
        .hover-popup {
            position: fixed;
            background: white;
            border: 2px solid black;
            padding: 12px;
            border-radius: 4px;
            z-index: 2000;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: fadeInPopup 0.2s;
        }
        @keyframes fadeInPopup {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .hover-popup-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .hover-popup-code {
            background: black;
            color: white;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
            border-radius: 3px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .hover-popup-highlight {
            background: white;
            color: black;
            padding: 2px 4px;
            font-weight: bold;
            border-radius: 2px;
            display: inline;
        }
        
        /* Formula Editor */
        .formula-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        .formula-editor {
            background: white;
            border-radius: 8px;
            width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .formula-editor-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
        }
        .formula-editor-header h3 {
            margin: 0;
            color: #333;
        }
        .formula-editor-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        .formula-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        .formula-textarea:focus {
            outline: none;
            border-color: #00BCD4;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        .operator-buttons {
            margin-top: 15px;
        }
        .operator-buttons-label {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
        }
        .operator-buttons-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .operator-btn {
            padding: 6px 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            transition: all 0.2s;
        }
        .operator-btn:hover {
            background: #00BCD4;
            color: white;
            border-color: #00BCD4;
        }
        .formula-editor-footer {
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .modal {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #00BCD4;
            background: #f5f5ff;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
        }
        .tab.active {
            border-bottom-color: #00BCD4;
            color: #00BCD4;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .connection-list-item {
            padding: 10px;
            margin: 5px 0;
            background: #f9f9f9;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .connection-list-item:hover {
            background: #f0f0f0;
        }
        .connection-list-item.selected {
            border-color: #00BCD4;
            background: #e3f2fd;
        }
        
        /* ========================================
           RESPONSIVE DESIGN
           ======================================== */
        
        /* Large tablets and smaller desktops */
        @media (max-width: 1200px) {
            .btn {
                min-width: 130px;
                font-size: 12px;
            }
            .search-input {
                width: 220px;
            }
        }
        
        /* Tablets */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
                min-width: 250px;
            }
            .properties-panel {
                width: 280px;
                min-width: 250px;
            }
            .btn {
                min-width: 110px;
                font-size: 12px;
                padding: 8px 12px;
                height: 38px;
            }
            input[type="text"], select {
                height: 38px;
            }
            .toolbar {
                gap: 6px;
                padding: 10px 12px;
            }
            .search-input {
                width: 180px;
            }
        }
        
        /* Mobile landscape and smaller tablets */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-height: 35vh;
                border-right: none;
                border-bottom: 2px solid #ddd;
            }
            .properties-panel {
                width: 100%;
                max-height: 35vh;
                border-left: none;
                border-top: 2px solid #ddd;
            }
            .toolbar {
                flex-wrap: wrap;
                justify-content: flex-start;
                padding: 8px;
            }
            .btn {
                flex: 1 1 calc(50% - 4px); /* 2 buttons per row */
                min-width: calc(50% - 4px);
                max-width: calc(50% - 4px);
                height: 40px;
            }
            .search-input {
                flex: 1 1 100%;
                width: 100%;
                margin-bottom: 4px;
            }
            input[type="text"]:not(.search-input) {
                flex: 1 1 100%;
                width: 100%;
                margin-bottom: 4px;
            }
            .canvas-area {
                padding: 10px;
            }
        }
        
        /* Mobile portrait */
        @media (max-width: 480px) {
            .sidebar-header h2 {
                font-size: 18px;
            }
            .btn {
                flex: 1 1 100%; /* 1 button per row */
                min-width: 100%;
                max-width: 100%;
            }
            .field-box {
                font-size: 12px;
                padding: 8px;
            }
            .toolbar {
                padding: 6px;
            }
        }
        
        /* Extra small phones */
        @media (max-width: 360px) {
            .sidebar-header {
                padding: 0;
            }
            .sidebar-header h2 {
                font-size: 16px;
            }
            .btn {
                font-size: 11px;
                padding: 6px 10px;
            }
        }
        
        /* High DPI screens (Retina) */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .field-box {
                border-width: 1.5px;
            }
            .btn {
                border-width: 0;
            }
        }
        
        /* Landscape orientation on mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .sidebar, .properties-panel {
                max-height: none;
                height: auto;
            }
            .sidebar-content {
                max-height: 60vh;
            }
        }

        /* ===== NODE IMPORT / EDIT / DELETE FEATURES ===== */
        
        /* "+" button in column headers */
        .col-import-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: #ff9800;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
            flex-shrink: 0;
        }
        .col-import-btn:hover {
            background: #f57c00;
            transform: scale(1.12);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Node import modal */
        .node-import-modal {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 480px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .node-import-modal h3 {
            margin: 0;
            font-size: 16px;
        }

        /* Draggable node-bundle */
        .node-bundle {
            position: fixed;
            z-index: 9000;
            background: white;
            border: 2px dashed #00BCD4;
            border-radius: 8px;
            padding: 10px 14px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            cursor: grab;
            user-select: none;
            max-width: 280px;
            min-width: 180px;
        }
        .node-bundle:active { cursor: grabbing; }
        .node-bundle-title {
            font-size: 12px;
            font-weight: 700;
            color: #00BCD4;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .node-bundle-count {
            background: #00BCD4;
            color: white;
            border-radius: 10px;
            padding: 1px 7px;
            font-size: 11px;
        }
        .node-bundle-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 11px;
            max-height: 120px;
            overflow-y: auto;
        }
        .node-bundle-list li {
            padding: 2px 0;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }
        .node-bundle-drop-hint {
            margin-top: 8px;
            font-size: 10px;
            color: #888;
            text-align: center;
            font-style: italic;
        }

        /* Drop zone highlight on field-box */
        .field-box.bundle-drop-target {
            border-color: #00BCD4 !important;
            border-style: dashed !important;
            background: #e0f7fa !important;
            box-shadow: 0 0 12px rgba(0,188,212,0.4);
        }
        
        /* Field context menu */
        .field-context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.18);
            z-index: 8000;
            min-width: 160px;
            overflow: hidden;
        }
        .field-context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
        }
        .field-context-menu-item:hover {
            background: #f5f5f5;
        }
        .field-context-menu-item.danger {
            color: #f44336;
        }
        .field-context-menu-item.danger:hover {
            background: #ffebee;
        }
        .field-context-menu-separator {
            height: 1px;
            background: #eee;
            margin: 2px 0;
        }

        /* Node edit modal */
        .node-edit-modal {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 420px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .node-edit-modal h3 {
            margin: 0;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- Authentication Check - BLOCKING VERSION -->
    <div id="auth-check" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #00BCD4 0%, #3F51B5 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999999;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    ">
        <div style="text-align: center;">
            <div style="
                width: 50px;
                height: 50px;
                border: 4px solid rgba(255,255,255,0.3);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            "></div>
            <style>
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            </style>
            <h2 style="font-size: 24px; margin-bottom: 10px;">Verifying Authentication...</h2>
            <p style="font-size: 14px; opacity: 0.9;">Please wait</p>
        </div>
    </div>
    
    <script>
        // BLOCKING authentication check
        (async function() {
            const API_BASE = '';
            const authCheckDiv = document.getElementById('auth-check');

            // Accetta token da URL (OAuth callback o redirect dal workspace)
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            if (urlToken) {
                localStorage.setItem('buddyliko_token', urlToken);
                window.history.replaceState({}, '', window.location.pathname);
            }

            // Handle OAuth link results (federation)
            const linkSuccess = urlParams.get('link_success');
            const linkError = urlParams.get('link_error');
            if (linkSuccess) {
                window.history.replaceState({}, '', window.location.pathname);
                setTimeout(() => alert('‚úÖ Account ' + linkSuccess + ' collegato con successo!'), 500);
            }
            if (linkError) {
                window.history.replaceState({}, '', window.location.pathname);
                setTimeout(() => alert('‚ùå Errore collegamento: ' + decodeURIComponent(linkError)), 500);
            }

            try {
                const statusResponse = await fetch(`${API_BASE}/api/auth/status`);
                if (!statusResponse.ok) { authCheckDiv.remove(); return; }
                const status = await statusResponse.json();

                if (status.enabled) {
                    const token = localStorage.getItem('buddyliko_token');
                    if (!token) { window.location.href = 'login.html'; return; }

                    const meResponse = await fetch(`${API_BASE}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!meResponse.ok) {
                        localStorage.removeItem('buddyliko_token');
                        localStorage.removeItem('buddyliko_user');
                        window.location.href = 'login.html';
                        return;
                    }
                    const meData = await meResponse.json();
                    const userData = meData.user || meData;
                    localStorage.setItem('buddyliko_user', JSON.stringify(userData));
                    authCheckDiv.remove();
                } else {
                    authCheckDiv.remove();
                }
            } catch (e) {
                console.error('‚ö†Ô∏è Auth check failed:', e);
                authCheckDiv.remove();
            }
        })();

        function logout() {
            localStorage.removeItem('buddyliko_token');
            localStorage.removeItem('buddyliko_user');
            window.location.href = 'login.html';
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('buddyliko_token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }
    </script>
    
    <div id="root"></div>
    
    <script>
        const { useState, useEffect, useRef } = React;
        const API_URL = '/api';
        
        // Hover Popup Component
        function HoverPopup({ popup, setPopupPinned, setHoverPopup }) {
            if (!popup) return null;
            
            // Render line with character-level highlighting
            const renderInputLine = (line, idx) => {
                const isHighlighted = idx === popup.highlightIndex;
                
                if (isHighlighted && popup.highlightChar) {
                    // Character-level highlighting for IDOC flat files
                    const { start, end } = popup.highlightChar;
                    const before = line.substring(0, start);
                    const highlighted = line.substring(start, end);
                    const after = line.substring(end);
                    
                    return React.createElement('div', { 
                        key: idx,
                        style: { 
                            background: '#e0e0e0',  // GRIGIO CHIARO
                            color: 'black',          // TESTO NERO
                            padding: '2px 4px',
                            fontFamily: 'monospace',
                            whiteSpace: 'pre',
                            fontSize: '11px'
                        }
                    },
                        React.createElement('span', { style: { color: 'black' } }, before),
                        React.createElement('span', { 
                            style: { 
                                background: 'black',  // VALORE: NERO
                                color: 'white',       // TESTO BIANCO
                                fontWeight: 'bold',
                                padding: '0 2px'
                            }
                        }, highlighted),
                        React.createElement('span', { style: { color: 'black' } }, after)
                    );
                } else if (isHighlighted) {
                    // LINE-LEVEL HIGHLIGHTING for XML with advanced coloring
                    // Check if line contains XML tags
                    const isXMLLine = line.trim().includes('<') && line.trim().includes('>');
                    
                    if (isXMLLine) {
                        // Parse XML line with colorization:
                        // 1. Opening/Closing tags: dark gray background, white text
                        // 2. Final values: black background, green text
                        // 3. Subtags: black background, yellow text
                        
                        const parts = [];
                        let remaining = line;
                        let key = 0;
                        
                        // Regex to match XML tags and content
                        const xmlRegex = /(<[^>]+>)|([^<>]+)/g;
                        let match;
                        
                        while ((match = xmlRegex.exec(line)) !== null) {
                            if (match[1]) {
                                // It's a tag: <tag> or </tag>
                                const tagContent = match[1];
                                
                                parts.push(
                                    React.createElement('span', {
                                        key: key++,
                                        style: {
                                            background: '#555',  // DARK GRAY for tags
                                            color: 'white',      // WHITE text
                                            padding: '0 2px',
                                            fontWeight: 'normal'
                                        }
                                    }, tagContent)
                                );
                            } else if (match[2]) {
                                // It's content between tags
                                const content = match[2];
                                
                                // Check if content contains nested tags (subtag) or is final value
                                const hasNestedTags = content.includes('<');
                                const trimmedContent = content.trim();
                                
                                if (trimmedContent.length > 0) {
                                    if (hasNestedTags) {
                                        // Content with subtags - YELLOW
                                        parts.push(
                                            React.createElement('span', {
                                                key: key++,
                                                style: {
                                                    background: 'black',
                                                    color: 'yellow',
                                                    fontWeight: 'bold'
                                                }
                                            }, content)
                                        );
                                    } else {
                                        // Final value - GREEN
                                        parts.push(
                                            React.createElement('span', {
                                                key: key++,
                                                style: {
                                                    background: 'black',
                                                    color: '#0f0',  // BRIGHT GREEN for value
                                                    fontWeight: 'bold',
                                                    padding: '0 2px'
                                                }
                                            }, content)
                                        );
                                    }
                                } else {
                                    // Whitespace
                                    parts.push(content);
                                }
                            }
                        }
                        
                        return React.createElement('div', {
                            key: idx,
                            style: {
                                background: 'black',
                                padding: '2px 4px',
                                fontFamily: 'monospace',
                                whiteSpace: 'pre',
                                fontSize: '11px'
                            }
                        }, ...parts);
                        
                    } else {
                        // Non-XML line - simple white on black
                        return React.createElement('div', { 
                            key: idx,
                            style: { 
                                background: 'black',
                                color: 'white',
                                padding: '2px 4px',
                                fontFamily: 'monospace',
                                whiteSpace: 'pre',
                                fontSize: '11px',
                                fontWeight: 'bold'
                            }
                        }, line);
                    }
                } else {
                    // Normal line (light gray background)
                    return React.createElement('div', { 
                        key: idx,
                        style: { 
                            background: '#e0e0e0',  // GRIGIO CHIARO
                            color: 'black',          // TESTO NERO
                            padding: '2px 4px',
                            fontFamily: 'monospace',
                            whiteSpace: 'pre',
                            fontSize: '11px'
                        }
                    }, line);
                }
            };
            
            return React.createElement('div', {
                className: 'hover-popup',
                style: {
                    left: popup.x + 'px',
                    top: popup.y + 'px',
                    maxWidth: popup.type === 'output' ? '500px' : '600px'
                },
                onDoubleClick: () => {
                    setPopupPinned(false);
                    setHoverPopup(null);
                }
            },
                React.createElement('div', { className: 'hover-popup-title' },
                    popup.type === 'input' ? 'üì• Input Context' : 'üì§ Generated XML Code'
                ),
                React.createElement('div', { 
                    className: 'hover-popup-code',
                    style: {
                        background: popup.type === 'input' ? '#f5f5f5' : 'black',
                        padding: '8px',
                        border: '1px solid #ccc'
                    }
                },
                    popup.type === 'input' 
                        ? (popup.lines || popup.contextLines || []).map((line, idx) => renderInputLine(line, idx))
                        : React.createElement('pre', { 
                            style: { 
                                margin: 0,
                                color: '#0f0',
                                fontFamily: 'monospace',
                                fontSize: '12px',
                                whiteSpace: 'pre-wrap'
                            }
                        }, popup.code)
                )
            );
        }
        
        // Formula Editor Component
        function FormulaEditor({ connection, onSave, onClose }) {
            const [expression, setExpression] = useState(
                connection.transformation?.expression || ''
            );
            const textareaRef = useRef(null);

            const snippets = [
                { label: 'Upper',        code: 'value.upper()' },
                { label: 'Lower',        code: 'value.lower()' },
                { label: 'Trim',         code: 'value.strip()' },
                { label: 'Replace',      code: 'value.replace("old", "new")' },
                { label: 'Split [0]',    code: 'value.split("/")[0]' },
                { label: '√ó 100',        code: 'float(value) * 100' },
                { label: '√∑ 100',        code: 'float(value) / 100' },
                { label: 'Round 2',      code: 'round(float(value), 2)' },
                { label: 'Substring',    code: 'value[0:8]' },
                { label: 'Pad 0 √ó10',   code: 'value.zfill(10)' },
                { label: 'Date ISO',     code: 'value[0:10]' },
                { label: 'Default EUR',  code: 'value if value else "EUR"' },
                { label: 'Strip alpha',  code: 'import re; re.sub(r"[^0-9.]", "", value)' },
                { label: 'Negate',       code: 'str(-float(value))' },
            ];

            const insertSnippet = (code) => {
                const ta = textareaRef.current;
                if (!ta) return;
                const s = ta.selectionStart, e = ta.selectionEnd;
                const next = expression.slice(0,s) + code + expression.slice(e);
                setExpression(next);
                setTimeout(() => { ta.focus(); ta.selectionStart = ta.selectionEnd = s + code.length; }, 0);
            };

            const panelStyle = { background: '#1e1e2e', color: '#cdd6f4', borderRadius: '8px', width: '680px', maxHeight: '85vh', display: 'flex', flexDirection: 'column', boxShadow: '0 10px 40px rgba(0,0,0,0.6)' };
            const headerStyle = { padding: '16px 20px', borderBottom: '1px solid #313244', display: 'flex', alignItems: 'center', justifyContent: 'space-between' };
            const bodyStyle = { padding: '16px 20px', flex: 1, overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '12px' };
            const labelStyle = { fontSize: '11px', fontWeight: '700', color: '#a6adc8', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px' };
            const taStyle = { width: '100%', minHeight: '120px', padding: '12px', fontFamily: '"Fira Code", "Courier New", monospace', fontSize: '13px', background: '#181825', color: '#cdd6f4', border: '1px solid #45475a', borderRadius: '6px', resize: 'vertical', outline: 'none' };
            const snippetBtn = { padding: '4px 10px', background: '#313244', color: '#cdd6f4', border: '1px solid #45475a', borderRadius: '4px', cursor: 'pointer', fontSize: '11px', fontFamily: 'monospace', transition: 'all 0.15s' };
            const hintBox = { background: '#181825', border: '1px solid #45475a', borderRadius: '6px', padding: '10px 14px', fontSize: '11px', color: '#a6adc8', lineHeight: '1.7' };

            return React.createElement('div', { className: 'formula-editor-modal', onClick: onClose },
                React.createElement('div', { style: panelStyle, onClick: e => e.stopPropagation() },
                    React.createElement('div', { style: headerStyle },
                        React.createElement('div', null,
                            React.createElement('div', { style: { fontWeight: '700', fontSize: '15px', color: '#cdd6f4' } }, i18n.t('app.custom_formula'))),
                            React.createElement('div', { style: { fontSize: '11px', color: '#6c7086', marginTop: '2px' } },
                                connection.sourceName + '  ‚Üí  ' + connection.targetName)
                        ),
                        React.createElement('button', { onClick: onClose, style: { background: 'none', border: 'none', color: '#6c7086', fontSize: '20px', cursor: 'pointer' } }, '‚úï')
                    ),
                    React.createElement('div', { style: bodyStyle },
                        React.createElement('div', null,
                            React.createElement('div', { style: labelStyle }, i18n.t('app.expression_help')),
                            React.createElement('textarea', {
                                ref: textareaRef,
                                style: taStyle,
                                value: expression,
                                onChange: e => setExpression(e.target.value),
                                placeholder: 'es: value.upper()  oppure  float(value) * 100  oppure  value.split("/")[0]',
                                spellCheck: false
                            })
                        ),
                        React.createElement('div', null,
                            React.createElement('div', { style: labelStyle }, i18n.t('app.snippets')),
                            React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '6px' } },
                                snippets.map(s => React.createElement('button', {
                                    key: s.label,
                                    style: snippetBtn,
                                    onClick: () => insertSnippet(s.code),
                                    onMouseEnter: e => { e.target.style.background = '#45475a'; e.target.style.color = '#cba6f7'; },
                                    onMouseLeave: e => { e.target.style.background = '#313244'; e.target.style.color = '#cdd6f4'; }
                                }, s.label))
                            )
                        ),
                        React.createElement('div', { style: hintBox },
                            React.createElement('strong', { style: { color: '#cba6f7' } }, i18n.t('app.suggestions') + ' ')),
                            React.createElement('span', null, '"value" contiene sempre il valore del campo sorgente come stringa. '),
                            React.createElement('span', null, 'Puoi usare qualsiasi espressione Python su una riga. '),
                            React.createElement('br', null),
                            React.createElement('strong', { style: { color: '#89dceb' } }, i18n.t('app.examples') + ' ')),
                            React.createElement('code', { style: { color: '#a6e3a1' } }, 'value.strip().upper()'),
                            React.createElement('span', null, ' ¬∑ '),
                            React.createElement('code', { style: { color: '#a6e3a1' } }, 'value[0:4] + "-" + value[4:6]'),
                            React.createElement('span', null, ' ¬∑ '),
                            React.createElement('code', { style: { color: '#a6e3a1' } }, '"IT" + value if not value.startswith("IT") else value')
                        )
                    ),
                    React.createElement('div', { style: { padding: '12px 20px', borderTop: '1px solid #313244', display: 'flex', gap: '10px', justifyContent: 'flex-end' } },
                        React.createElement('button', { className: 'btn btn-secondary', onClick: onClose }, i18n.t('common.cancel')),
                        React.createElement('button', { className: 'btn btn-success', onClick: () => onSave({ type: 'CUSTOM', expression }) }, i18n.t('app.save_formula'))
                    )
                )
            );
        }
        
        // Settings Modal Component
        function SettingsModal({ onClose }) {
            return React.createElement('div', {
                className: 'formula-editor-modal',
                onClick: onClose
            },
                React.createElement('div', {
                    className: 'formula-editor',
                    onClick: (e) => e.stopPropagation()
                },
                    React.createElement('div', { className: 'formula-editor-header' },
                        React.createElement('h3', null, '‚öôÔ∏è AI Configuration')
                    ),
                    React.createElement('div', { className: 'formula-editor-body' },
                        React.createElement('div', { style: { padding: '15px', background: '#f0f0f0', borderRadius: '6px', fontSize: '13px', marginBottom: '15px' } },
                            React.createElement('strong', null, i18n.t('app.ai_how_works')),
                            React.createElement('ul', { style: { marginTop: '8px', paddingLeft: '20px', lineHeight: '1.6' } },
                                React.createElement('li', null, i18n.t('app.ai_step1')),
                                React.createElement('li', null, i18n.t('app.ai_step2')),
                                React.createElement('li', null, i18n.t('app.ai_step3')),
                                React.createElement('li', null, i18n.t('app.ai_step4'))
                            )
                        ),
                        React.createElement('div', { style: { padding: '15px', background: '#fff3cd', borderRadius: '6px', fontSize: '12px', marginBottom: '15px' } },
                            React.createElement('strong', { style: { display: 'block', marginBottom: '8px' } }, i18n.t('app.api_keys'))),
                            React.createElement('div', { style: { lineHeight: '1.6' } },
                                'API keys are configured in the backend ',
                                React.createElement('code', { style: { background: '#fff', padding: '2px 6px', borderRadius: '3px' } }, '.env'),
                                ' file. Add your keys there:',
                                React.createElement('pre', { style: { background: '#000', color: '#0f0', padding: '10px', borderRadius: '4px', marginTop: '8px', fontSize: '11px', overflow: 'auto' } },
'ANTHROPIC_API_KEY=sk-ant-api03-...\nOPENAI_API_KEY=sk-...'
                                )
                            )
                        ),
                        React.createElement('div', { style: { fontSize: '12px' } },
                            React.createElement('div', { style: { marginBottom: '10px' } },
                                React.createElement('strong', null, i18n.t('app.get_claude_key')),
                                React.createElement('br'),
                                React.createElement('a', { 
                                    href: 'https://console.anthropic.com/settings/keys', 
                                    target: '_blank',
                                    style: { color: '#00BCD4' }
                                }, 'https://console.anthropic.com/settings/keys')
                            ),
                            React.createElement('div', null,
                                React.createElement('strong', null, i18n.t('app.get_openai_key')),
                                React.createElement('br'),
                                React.createElement('a', { 
                                    href: 'https://platform.openai.com/api-keys', 
                                    target: '_blank',
                                    style: { color: '#00BCD4' }
                                }, 'https://platform.openai.com/api-keys')
                            )
                        )
                    ),
                    React.createElement('div', { className: 'formula-editor-footer' },
                        React.createElement('button', {
                            className: 'btn btn-primary',
                            onClick: onClose
                        }, i18n.t('app.got_it')))
                    )
                )
            );
        }
        
        // ===========================================================================
        // SCHEMA EDITOR MODAL COMPONENT
        // ===========================================================================
        
        function SchemaEditorModal({ show, onClose, onSchemaSelect }) {
            const [schemaId, setSchemaId] = useState(null);
            const [schemaName, setSchemaName] = useState('');
            const [schemaFormat, setSchemaFormat] = useState('xml');
            const [schemaTree, setSchemaTree] = useState([]);
            const [selectedField, setSelectedField] = useState(null);
            const [status, setStatus] = useState('');
            const [savedSchemas, setSavedSchemas] = useState([]);
            const [showLoadPanel, setShowLoadPanel] = useState(false);
            
            // Load list of saved schemas on mount
            useEffect(() => {
                loadSavedSchemasList();
            }, []);
            
            // Load list of saved schemas
            const loadSavedSchemasList = async () => {
                try {
                    const res = await fetch(`${API_URL}/schema/list`);
                    const data = await res.json();
                    setSavedSchemas(data.schemas || []);
                } catch (err) {
                    console.error('Failed to load schemas list:', err);
                }
            };
            
            // Save current schema
            const saveCurrentSchema = async () => {
                if (!schemaId) {
                    setStatus('‚ùå No schema to save');
                    return;
                }
                
                const name = prompt('Schema name:', schemaName);
                if (!name) return;
                
                const description = prompt('Description (optional):');
                
                try {
                    await fetch(`${API_URL}/schema/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            schema_id: schemaId,
                            name,
                            description: description || ''
                        })
                    });
                    setStatus(`‚úÖ Schema "${name}" saved!`);
                    loadSavedSchemasList();
                } catch (err) {
                    setStatus(`‚ùå Save error: ${err.message}`);
                }
            };
            
            // Load saved schema
            const loadSavedSchema = async (storedId) => {
                try {
                    const res = await fetch(`${API_URL}/schema/load/${storedId}`);
                    const data = await res.json();
                    setSchemaId(data.schema_id);
                    setSchemaName(data.schema.name);
                    setSchemaTree(data.tree);
                    setStatus(`‚úÖ Schema loaded!`);
                    setShowLoadPanel(false);
                } catch (err) {
                    setStatus(`‚ùå Load error: ${err.message}`);
                }
            };
            
            // Delete saved schema
            const deleteSavedSchema = async (storedId) => {
                if (!confirm('Delete this saved schema?')) return;
                
                try {
                    await fetch(`${API_URL}/schema/stored/${storedId}`, {
                        method: 'DELETE'
                    });
                    setStatus('‚úÖ Schema deleted');
                    loadSavedSchemasList();
                } catch (err) {
                    setStatus(`‚ùå Delete error: ${err.message}`);
                }
            };
            
            // Create new schema
            const createSchema = async () => {
                try {
                    const res = await fetch(`${API_URL}/schema/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: schemaName,
                            format: schemaFormat
                        })
                    });
                    const data = await res.json();
                    setSchemaId(data.schema_id);
                    setStatus(`‚úÖ Schema "${schemaName}" created!`);
                    loadSchema(data.schema_id);
                } catch (err) {
                    setStatus(`‚ùå Error: ${err.message}`);
                }
            };
            
            // Load schema tree
            const loadSchema = async (id) => {
                try {
                    const res = await fetch(`${API_URL}/schema/${id}`);
                    const data = await res.json();
                    setSchemaTree(data.tree);
                } catch (err) {
                    setStatus(`‚ùå Load error: ${err.message}`);
                }
            };
            
            // Add field
            const addField = async () => {
                const name = prompt('Field name:');
                if (!name) return;
                
                const type = prompt('Type (string/number/date/boolean/object/array):', 'string');
                if (!type) return;
                
                const description = prompt('Description (optional):');
                
                try {
                    await fetch(`${API_URL}/schema/${schemaId}/field/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name,
                            field_type: type,
                            parent_path: selectedField?.path,
                            description: description || '',
                            required: false
                        })
                    });
                    setStatus(`‚úÖ Field "${name}" added`);
                    loadSchema(schemaId);
                } catch (err) {
                    setStatus(`‚ùå Add field error: ${err.message}`);
                }
            };
            
            // Remove field
            const removeField = async (fieldId) => {
                if (!confirm('Remove this field and all its children?')) return;
                
                try {
                    await fetch(`${API_URL}/schema/${schemaId}/field/${fieldId}`, {
                        method: 'DELETE'
                    });
                    setStatus(`‚úÖ Field removed`);
                    setSelectedField(null);
                    loadSchema(schemaId);
                } catch (err) {
                    setStatus(`‚ùå Remove error: ${err.message}`);
                }
            };
            
            // Update field
            const updateField = async (fieldId, updates) => {
                try {
                    await fetch(`${API_URL}/schema/${schemaId}/field/update`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            field_id: fieldId,
                            updates
                        })
                    });
                    setStatus(`‚úÖ Field updated`);
                    loadSchema(schemaId);
                } catch (err) {
                    setStatus(`‚ùå Update error: ${err.message}`);
                }
            };
            
            // Export as CSV
            const exportCSV = () => {
                window.open(`${API_URL}/schema/${schemaId}/export/csv`);
                setStatus('‚úÖ Exporting CSV schema...');
            };
            
            // Export sample
            const exportSample = (format) => {
                window.open(`${API_URL}/schema/${schemaId}/export/sample/${format}`);
                setStatus(`‚úÖ Exporting sample ${format.toUpperCase()}...`);
            };
            
            // Import from CSV header
            const importCSV = async () => {
                const header = prompt('Enter CSV header (comma-separated):');
                if (!header) return;
                
                try {
                    await fetch(`${API_URL}/schema/${schemaId}/import`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            format: 'csv_header',
                            content: header
                        })
                    });
                    setStatus('‚úÖ Imported from CSV header');
                    loadSchema(schemaId);
                } catch (err) {
                    setStatus(`‚ùå Import error: ${err.message}`);
                }
            };
            
            // Render tree node
            const renderTreeNode = (node, level = 0) => {
                const indent = level * 20;
                const isSelected = selectedField?.id === node.id;
                
                const getTypeIcon = (type) => {
                    const icons = {
                        string: 'üìù',
                        number: 'üî¢',
                        date: 'üìÖ',
                        boolean: '‚òëÔ∏è',
                        array: 'üìã',
                        object: 'üì¶'
                    };
                    return icons[type] || 'üìÑ';
                };
                
                return React.createElement('div', { key: node.id },
                    React.createElement('div', {
                        style: {
                            paddingLeft: `${indent + 8}px`,
                            padding: '8px',
                            cursor: 'pointer',
                            background: isSelected ? '#e3f2fd' : 'transparent',
                            borderLeft: isSelected ? '3px solid #1976d2' : 'none',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            borderRadius: '4px'
                        },
                        onClick: () => setSelectedField(node)
                    },
                        React.createElement('span', null, getTypeIcon(node.type)),
                        React.createElement('span', { 
                            style: { fontWeight: 'bold', flex: 1 } 
                        }, node.name),
                        React.createElement('span', { 
                            style: { fontSize: '11px', color: '#666' }
                        }, node.type),
                        node.required && React.createElement('span', {
                            style: { color: 'red', fontSize: '11px', marginLeft: '4px' }
                        }, '*'),
                        React.createElement('button', {
                            onClick: (e) => {
                                e.stopPropagation();
                                removeField(node.id);
                            },
                            style: { 
                                marginLeft: '8px', 
                                fontSize: '16px',
                                background: 'none',
                                border: 'none',
                                cursor: 'pointer'
                            }
                        }, 'üóëÔ∏è')
                    ),
                    node.children?.map(child => renderTreeNode(child, level + 1))
                );
            };
            
            if (!show) return null;
            
            return React.createElement('div', {
                className: 'modal-overlay',
                onClick: onClose
            },
                React.createElement('div', {
                    className: 'modal',
                    style: { maxWidth: '1200px', width: '90%', maxHeight: '90vh' },
                    onClick: (e) => e.stopPropagation()
                },
                    React.createElement('h2', null, 'üèóÔ∏è Schema Editor'),
                    
                    // Status bar
                    status && React.createElement('div', {
                        style: {
                            padding: '10px',
                            marginTop: '10px',
                            marginBottom: '10px',
                            background: status.startsWith('‚úÖ') ? '#d4edda' : '#f8d7da',
                            color: status.startsWith('‚úÖ') ? '#155724' : '#721c24',
                            borderRadius: '6px'
                        }
                    }, status),
                    
                    // Header section - Create or Load schema
                    !schemaId && React.createElement('div', { style: { marginBottom: '20px' } },
                        React.createElement('div', { 
                            style: { 
                                display: 'flex', 
                                gap: '10px', 
                                alignItems: 'center',
                                marginBottom: '15px'
                            }
                        },
                            React.createElement('input', {
                                type: 'text',
                                placeholder: 'Schema name (e.g., Invoice, Customer)...',
                                value: schemaName,
                                onChange: (e) => setSchemaName(e.target.value),
                                style: { width: '300px' }
                            }),
                            React.createElement('select', {
                                value: schemaFormat,
                                onChange: (e) => setSchemaFormat(e.target.value)
                            },
                                React.createElement('option', { value: 'csv' }, 'CSV'),
                                React.createElement('option', { value: 'xml' }, 'XML'),
                                React.createElement('option', { value: 'json' }, 'JSON'),
                                React.createElement('option', { value: 'excel' }, 'Excel'),
                                React.createElement('option', { value: 'flat' }, 'Fixed-width (IDOC)')
                            ),
                            React.createElement('button', {
                                className: 'btn btn-primary',
                                onClick: createSchema,
                                disabled: !schemaName
                            }, i18n.t('app.create_new'))),
                            React.createElement('button', {
                                className: 'btn btn-secondary',
                                onClick: () => setShowLoadPanel(!showLoadPanel)
                            }, showLoadPanel ? '‚úñ Close' : 'üìÇ Load Saved')
                        ),
                        
                        // Load panel
                        showLoadPanel && React.createElement('div', {
                            style: {
                                border: '2px solid #00BCD4',
                                borderRadius: '8px',
                                padding: '15px',
                                background: '#f8f9ff',
                                maxHeight: '300px',
                                overflowY: 'auto'
                            }
                        },
                            React.createElement('h4', { 
                                style: { marginTop: 0, marginBottom: '10px' }
                            }, i18n.t('app.saved_schemas'))),
                            savedSchemas.length === 0 ? React.createElement('p', {
                                style: { color: '#999', textAlign: 'center', padding: '20px' }
                            }, i18n.t('app.no_schemas'))) : null,
                            savedSchemas.map(schema => 
                                React.createElement('div', {
                                    key: schema.id,
                                    style: {
                                        padding: '10px',
                                        marginBottom: '8px',
                                        background: 'white',
                                        borderRadius: '6px',
                                        border: '1px solid #ddd',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '10px'
                                    }
                                },
                                    React.createElement('div', { style: { flex: 1 } },
                                        React.createElement('div', { 
                                            style: { fontWeight: 'bold', marginBottom: '4px' }
                                        }, schema.name),
                                        React.createElement('div', { 
                                            style: { fontSize: '12px', color: '#666' }
                                        }, `${schema.format.toUpperCase()} ‚Ä¢ ${schema.field_count} fields`),
                                        schema.description && React.createElement('div', {
                                            style: { fontSize: '11px', color: '#999', marginTop: '4px' }
                                        }, schema.description)
                                    ),
                                    React.createElement('button', {
                                        className: 'btn btn-sm btn-primary',
                                        onClick: () => loadSavedSchema(schema.id)
                                    }, i18n.t('app.load'))),
                                    React.createElement('button', {
                                        className: 'btn btn-sm btn-danger',
                                        onClick: () => deleteSavedSchema(schema.id)
                                    }, 'üóëÔ∏è')
                                )
                            )
                        )
                    ),
                    
                    // Main editor area
                    schemaId && React.createElement('div', {
                        style: { display: 'flex', gap: '20px', height: '500px' }
                    },
                        // Left - Tree view
                        React.createElement('div', {
                            style: {
                                flex: 1,
                                border: '1px solid #ddd',
                                borderRadius: '6px',
                                padding: '10px',
                                overflowY: 'auto',
                                background: '#fafafa'
                            }
                        },
                            React.createElement('div', {
                                style: { 
                                    marginBottom: '10px',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    paddingBottom: '10px',
                                    borderBottom: '2px solid #ddd'
                                }
                            },
                                React.createElement('h3', { 
                                    style: { margin: 0 }
                                }, `üìÇ ${schemaName}`),
                                React.createElement('div', { 
                                    style: { display: 'flex', gap: '5px' } 
                                },
                                    React.createElement('button', {
                                        className: 'btn btn-sm btn-primary',
                                        onClick: addField
                                    }, i18n.t('app.add'))),
                                    React.createElement('button', {
                                        className: 'btn btn-sm btn-secondary',
                                        onClick: importCSV
                                    }, i18n.t('app.import')))
                                )
                            ),
                            schemaTree.length === 0 ? React.createElement('div', {
                                style: { 
                                    textAlign: 'center', 
                                    padding: '40px', 
                                    color: '#999' 
                                }
                            }, i18n.t('app.no_fields'))) : null,
                            schemaTree.map(node => renderTreeNode(node))
                        ),
                        
                        // Right - Properties panel
                        React.createElement('div', {
                            style: {
                                width: '350px',
                                border: '1px solid #ddd',
                                borderRadius: '6px',
                                padding: '15px',
                                overflowY: 'auto'
                            }
                        },
                            React.createElement('h3', null, '‚öôÔ∏è Properties'),
                            selectedField ? React.createElement('div', null,
                                React.createElement('div', { 
                                    style: { marginBottom: '15px' } 
                                },
                                    React.createElement('label', { 
                                        style: { 
                                            display: 'block', 
                                            fontWeight: 'bold', 
                                            marginBottom: '5px',
                                            fontSize: '11px',
                                            color: '#666',
                                            textTransform: 'uppercase'
                                        } 
                                    }, i18n.t('app.name'))),
                                    React.createElement('div', { 
                                        style: { 
                                            fontWeight: 'bold', 
                                            fontSize: '18px' 
                                        } 
                                    }, selectedField.name)
                                ),
                                React.createElement('div', { 
                                    style: { marginBottom: '15px' } 
                                },
                                    React.createElement('label', {
                                        style: { 
                                            display: 'block', 
                                            fontWeight: 'bold', 
                                            marginBottom: '5px',
                                            fontSize: '11px',
                                            color: '#666',
                                            textTransform: 'uppercase'
                                        }
                                    }, i18n.t('app.type'))),
                                    React.createElement('div', { 
                                        style: { 
                                            padding: '8px',
                                            background: '#f5f5f5',
                                            borderRadius: '4px',
                                            fontFamily: 'monospace'
                                        }
                                    }, selectedField.type)
                                ),
                                React.createElement('div', { 
                                    style: { marginBottom: '15px' } 
                                },
                                    React.createElement('label', {
                                        style: { 
                                            display: 'block', 
                                            fontWeight: 'bold', 
                                            marginBottom: '5px',
                                            fontSize: '11px',
                                            color: '#666',
                                            textTransform: 'uppercase'
                                        }
                                    }, i18n.t('app.path'))),
                                    React.createElement('div', { 
                                        style: { 
                                            fontSize: '12px', 
                                            color: '#666',
                                            fontFamily: 'monospace',
                                            wordBreak: 'break-all'
                                        }
                                    }, selectedField.path)
                                ),
                                React.createElement('div', { 
                                    style: { marginBottom: '15px' } 
                                },
                                    React.createElement('label', {
                                        style: { 
                                            display: 'block', 
                                            fontWeight: 'bold', 
                                            marginBottom: '5px',
                                            fontSize: '11px',
                                            color: '#666',
                                            textTransform: 'uppercase'
                                        }
                                    }, i18n.t('app.description'))),
                                    React.createElement('textarea', {
                                        value: selectedField.description || '',
                                        onChange: (e) => updateField(selectedField.id, { 
                                            description: e.target.value 
                                        }),
                                        style: { 
                                            width: '100%', 
                                            height: '80px',
                                            padding: '8px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px'
                                        },
                                        placeholder: 'Enter field description...'
                                    })
                                ),
                                React.createElement('div', { 
                                    style: { marginBottom: '15px' } 
                                },
                                    React.createElement('label', {
                                        style: { 
                                            display: 'flex',
                                            alignItems: 'center',
                                            cursor: 'pointer'
                                        }
                                    },
                                        React.createElement('input', {
                                            type: 'checkbox',
                                            checked: selectedField.required || false,
                                            onChange: (e) => updateField(selectedField.id, {
                                                required: e.target.checked
                                            }),
                                            style: { marginRight: '8px' }
                                        }),
                                        React.createElement('span', {
                                            style: { fontWeight: 'bold' }
                                        }, i18n.t('app.required_field')))
                                    )
                                )
                            ) : React.createElement('p', { 
                                style: { 
                                    color: '#999', 
                                    textAlign: 'center',
                                    padding: '40px 20px'
                                } 
                            }, i18n.t('app.select_field')))
                        )
                    ),
                    
                    // Footer - Export buttons
                    schemaId && React.createElement('div', {
                        style: {
                            marginTop: '20px',
                            paddingTop: '20px',
                            borderTop: '2px solid #ddd',
                            display: 'flex',
                            gap: '10px',
                            flexWrap: 'wrap'
                        }
                    },
                        React.createElement('button', {
                            className: 'btn btn-success',
                            onClick: saveCurrentSchema,
                            title: i18n.t('app.save_schema')
                        }, i18n.t('app.save_schema'))),
                        React.createElement('button', {
                            className: 'btn btn-success',
                            onClick: exportCSV
                        }, i18n.t('app.export_csv_schema'))),
                        React.createElement('button', {
                            className: 'btn btn-secondary',
                            onClick: () => exportSample('xml')
                        }, i18n.t('app.sample_xml'))),
                        React.createElement('button', {
                            className: 'btn btn-secondary',
                            onClick: () => exportSample('json')
                        }, i18n.t('app.sample_json'))),
                        React.createElement('button', {
                            className: 'btn btn-secondary',
                            onClick: () => exportSample('csv')
                        }, i18n.t('app.sample_csv'))),
                        React.createElement('div', { 
                            style: { flex: 1, borderRight: '2px solid #ddd', marginLeft: '10px' } 
                        }),
                        onSchemaSelect && React.createElement('button', {
                            className: 'btn btn-success',
                            onClick: async () => {
                                // Export CSV and set as input schema
                                try {
                                    const res = await fetch(`${API_URL}/schema/${schemaId}/export/csv`);
                                    const csvText = await res.text();
                                    
                                    // Parse CSV as schema
                                    const formData = new FormData();
                                    const blob = new Blob([csvText], { type: 'text/csv' });
                                    formData.append('file', blob, 'schema.csv');
                                    formData.append('type', 'csv');
                                    
                                    const uploadRes = await fetch(`${API_URL}/schemas/upload`, {
                                        method: 'POST',
                                        body: formData
                                    });
                                    const schema = await uploadRes.json();
                                    onSchemaSelect(schema, 'input', { schema: schemaTree, schemaId });
                                    onClose();
                                } catch (err) {
                                    setStatus(`‚ùå Error: ${err.message}`);
                                }
                            }
                        }, i18n.t('app.use_as_input'))),
                        onSchemaSelect && React.createElement('button', {
                            className: 'btn btn-success',
                            onClick: async () => {
                                // Export CSV and set as output schema
                                try {
                                    const res = await fetch(`${API_URL}/schema/${schemaId}/export/csv`);
                                    const csvText = await res.text();
                                    
                                    // Parse CSV as schema
                                    const formData = new FormData();
                                    const blob = new Blob([csvText], { type: 'text/csv' });
                                    formData.append('file', blob, 'schema.csv');
                                    formData.append('type', 'csv');
                                    
                                    const uploadRes = await fetch(`${API_URL}/schemas/upload`, {
                                        method: 'POST',
                                        body: formData
                                    });
                                    const schema = await uploadRes.json();
                                    onSchemaSelect(schema, 'output', { schema: schemaTree, schemaId });
                                    onClose();
                                } catch (err) {
                                    setStatus(`‚ùå Error: ${err.message}`);
                                }
                            }
                        }, i18n.t('app.use_as_output'))),
                        React.createElement('button', {
                            className: 'btn btn-primary',
                            onClick: () => {
                                onClose();
                            },
                            style: { marginLeft: 'auto' }
                        }, i18n.t('app.done')))
                    ),
                    
                    React.createElement('button', {
                        className: 'btn btn-secondary',
                        onClick: onClose,
                        style: { marginTop: '10px', width: '100%' }
                    }, i18n.t('app.close')))
                )
            );
        }
        
        // AI Work Panel ‚Äî live log modal shown while AI automap runs
        function AIWorkPanel({ log, onClose, processing }) {
            const bottomRef = React.useRef(null);
            React.useEffect(() => {
                if (bottomRef.current) bottomRef.current.scrollIntoView({ behavior: 'smooth' });
            }, [log]);

            const renderLine = (evt, i) => {
                if (!evt) return null;
                const type = evt.type;
                const msg  = evt.msg || '';

                // Color + prefix logic matching backend log format
                let color = '#cdd6f4';
                let prefix = '';
                if (type === 'error')      { color = '#f38ba8'; prefix = '‚ùå '; }
                else if (type === 'done')  { color = '#a6e3a1'; prefix = 'üéØ '; }
                else if (type === 'chunk_done') { color = '#94e2d5'; prefix = '  '; }
                else if (msg.startsWith('üöÄ')) { color = '#89dceb'; }
                else if (msg.startsWith('üîë')) { color = '#89b4fa'; }
                else if (msg.startsWith('üì¶')) { color = '#cba6f7'; }
                else if (msg.startsWith('ü§ñ')) { color = '#f9e2af'; }
                else if (msg.startsWith('üìù')) { color = '#a6adc8'; }
                else if (msg.startsWith('‚úÖ') && msg.includes('HTTP')) { color = '#a6e3a1'; }
                else if (msg.startsWith('üìÑ')) { color = '#a6adc8'; }
                else if (msg.startsWith('üî¢')) { color = '#89dceb'; }
                else if (msg.startsWith('‚ùå')) { color = '#f38ba8'; }
                else if (msg.startsWith('üîÑ')) { color = '#cba6f7'; }
                else if (msg.startsWith('‚è≠Ô∏è')) { color = '#a6adc8'; }

                const lines = [prefix + msg];

                // For chunk_done, render accepted/skipped detail lines
                if (type === 'chunk_done' && evt.accepted && evt.accepted.length > 0) {
                    evt.accepted.forEach(a => {
                        const conf = a.conf || 0;
                        const confColor = conf >= 0.9 ? '#a6e3a1' : conf >= 0.75 ? '#89dceb' : conf >= 0.6 ? '#f9e2af' : '#f38ba8';
                        lines.push(
                            React.createElement('span', { key: `acc-${i}-${a.tgt}`, style: { display: 'block', paddingLeft: '16px', color: confColor } },
                                `    '${a.src}' ‚Üí '${a.tgt}' | conf=${conf.toFixed(2)} | ${a.reason || ''}`
                            )
                        );
                    });
                }

                return React.createElement('div', {
                    key: i,
                    style: { color, fontFamily: 'monospace', fontSize: '12px', lineHeight: '1.6', whiteSpace: 'pre-wrap', wordBreak: 'break-all', marginBottom: '1px' }
                }, ...lines.map((l, j) => typeof l === 'string'
                    ? React.createElement('span', { key: j, style: { display: 'block' } }, l)
                    : l
                ));
            };

            const doneEvt = log.find(e => e.type === 'done');
            const totalMatches = doneEvt ? (doneEvt.suggestions || []).length : null;
            const green  = doneEvt ? doneEvt.green  : null;
            const yellow = doneEvt ? doneEvt.yellow : null;

            return React.createElement('div', {
                style: {
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    background: 'rgba(0,0,0,0.75)', zIndex: 9999,
                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                },
                onClick: (e) => { if (e.target === e.currentTarget) onClose(); }
            },
                React.createElement('div', {
                    style: {
                        background: '#1e1e2e', borderRadius: '12px', width: '820px', maxWidth: '95vw',
                        height: '80vh', display: 'flex', flexDirection: 'column',
                        boxShadow: '0 25px 60px rgba(0,0,0,0.7)', border: '1px solid #313244', overflow: 'hidden'
                    }
                },
                    // Header
                    React.createElement('div', {
                        style: {
                            background: 'linear-gradient(135deg, #313244, #45475a)',
                            padding: '14px 20px', display: 'flex', alignItems: 'center',
                            justifyContent: 'space-between', borderBottom: '1px solid #45475a', flexShrink: 0
                        }
                    },
                        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px' } },
                            React.createElement('span', { style: { fontSize: '20px' } }, 'ü§ñ'),
                            React.createElement('div', null,
                                React.createElement('div', { style: { color: '#cdd6f4', fontWeight: 'bold', fontSize: '15px' } }, i18n.t('app.ai_at_work'))),
                                React.createElement('div', { style: { color: '#a6adc8', fontSize: '11px' } },
                                    processing
                                        ? `Processing‚Ä¶ ${log.filter(e => e.type === 'chunk_done').length} calls done`
                                        : totalMatches !== null
                                            ? `‚úÖ Completed ‚Äî ${totalMatches} suggestions (${green} üü¢ confident, ${yellow} üü° uncertain)`
                                            : 'Ready'
                                )
                            )
                        ),
                        React.createElement('div', { style: { display: 'flex', gap: '8px', alignItems: 'center' } },
                            processing && React.createElement('div', {
                                style: { width: '10px', height: '10px', borderRadius: '50%', background: '#a6e3a1',
                                    animation: 'pulse 1s infinite', flexShrink: 0 }
                            }),
                            React.createElement('button', {
                                onClick: onClose,
                                style: { background: processing ? '#45475a' : '#f38ba8', border: 'none', borderRadius: '6px', 
                                    color: processing ? '#cdd6f4' : '#1e1e2e',
                                    padding: '4px 12px', cursor: 'pointer', fontWeight: 'bold', fontSize: '12px' },
                                title: processing ? 'Close (AI still running in background)' : 'Close'
                            }, i18n.t('app.close')))
                        )
                    ),
                    // Progress bar
                    processing && React.createElement('div', { style: { height: '3px', background: '#313244', flexShrink: 0 } },
                        React.createElement('div', {
                            style: {
                                height: '100%', background: 'linear-gradient(90deg, #89b4fa, #cba6f7)',
                                width: log.length > 0 ? '60%' : '10%',
                                transition: 'width 0.5s ease', animation: 'shimmer 2s infinite'
                            }
                        })
                    ),
                    // Log body
                    React.createElement('div', {
                        style: { flex: 1, overflowY: 'auto', padding: '16px 20px', scrollbarColor: '#45475a #1e1e2e' }
                    },
                        log.length === 0
                            ? React.createElement('div', { style: { color: '#6c7086', fontFamily: 'monospace', fontSize: '12px' } }, i18n.t('app.ai_waiting')))
                            : log.map((evt, i) => renderLine(evt, i)),
                        React.createElement('div', { ref: bottomRef })
                    ),
                    // Footer stats
                    !processing && doneEvt && React.createElement('div', {
                        style: { background: '#181825', borderTop: '1px solid #313244', padding: '12px 20px',
                            display: 'flex', gap: '24px', flexShrink: 0 }
                    },
                        React.createElement('span', { style: { color: '#a6e3a1', fontSize: '13px', fontWeight: 'bold' } },
                            `üü¢ ${green} confident (‚â•0.75)`),
                        React.createElement('span', { style: { color: '#f9e2af', fontSize: '13px', fontWeight: 'bold' } },
                            `üü° ${yellow} uncertain (0.5‚Äì0.74)`),
                        React.createElement('span', { style: { color: '#89b4fa', fontSize: '13px', fontWeight: 'bold' } },
                            `üìã ${totalMatches} total suggestions`),
                        React.createElement('span', { style: { color: '#a6adc8', fontSize: '12px', marginLeft: 'auto' } },
                            `${log.filter(e => e.type === 'chunk_done').length} API calls made`)
                    )
                )
            );
        }

        // AI Suggestions Panel Component
        function AISuggestionsPanel({ suggestions, onApprove, onReject, onClose, processing }) {
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [selectAll, setSelectAll] = useState(false);
            
            const toggleSelection = (suggestion) => {
                const key = `${suggestion.source_field}-${suggestion.target_field}`;
                const newSelectedIds = new Set(selectedIds);
                
                if (newSelectedIds.has(key)) {
                    newSelectedIds.delete(key);
                } else {
                    newSelectedIds.add(key);
                }
                
                setSelectedIds(newSelectedIds);
                setSelectAll(newSelectedIds.size === suggestions.length);
            };
            
            const toggleSelectAll = () => {
                if (selectAll) {
                    setSelectedIds(new Set());
                    setSelectAll(false);
                } else {
                    const allIds = new Set(
                        suggestions.map(s => `${s.source_field}-${s.target_field}`)
                    );
                    setSelectedIds(allIds);
                    setSelectAll(true);
                }
            };
            
            const isSelected = (suggestion) => {
                const key = `${suggestion.source_field}-${suggestion.target_field}`;
                return selectedIds.has(key);
            };
            
            const approveSelected = () => {
                console.log('üü¢ APPROVE SELECTED clicked');
                console.log('  Selected IDs:', selectedIds);
                
                const toApprove = suggestions.filter(s => isSelected(s));
                console.log('  To approve count:', toApprove.length);
                console.log('  To approve items:', toApprove.map(s => s.source_field + ' ‚Üí ' + s.target_field));
                
                // Approve with small delay between each to ensure unique IDs
                toApprove.forEach((s, index) => {
                    setTimeout(() => {
                        console.log(`  [${index}] Approving:`, s.source_field, '‚Üí', s.target_field);
                        onApprove(s);
                    }, index * 50);
                });
                
                setSelectedIds(new Set());
                setSelectAll(false);
            };
            
            const approveAll = () => {
                console.log('üü£ APPROVE ALL clicked');
                console.log('  Total suggestions:', suggestions.length);
                console.log('  Suggestions:', suggestions.map(s => s.source_field + ' ‚Üí ' + s.target_field));
                
                // Approve with small delay between each to ensure unique IDs
                suggestions.forEach((s, index) => {
                    setTimeout(() => {
                        console.log(`  [${index}] Approving:`, s.source_field, '‚Üí', s.target_field);
                        onApprove(s);
                    }, index * 50);
                });
                
                setSelectedIds(new Set());
                setSelectAll(false);
            };
            
            return React.createElement('div', {
                style: {
                    position: 'fixed',
                    right: '20px',
                    top: '80px',
                    width: '450px',
                    maxHeight: 'calc(100vh - 100px)',
                    background: 'white',
                    borderRadius: '12px',
                    boxShadow: '0 10px 40px rgba(0,0,0,0.2)',
                    border: '2px solid #00BCD4',
                    zIndex: 1000,
                    display: 'flex',
                    flexDirection: 'column'
                }
            },
                React.createElement('div', {
                    style: {
                        padding: '20px',
                        borderBottom: '1px solid #ddd',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        background: 'linear-gradient(135deg, #00BCD4 0%, #3F51B5 100%)',
                        color: 'white',
                        borderRadius: '10px 10px 0 0'
                    }
                },
                    React.createElement('h3', { style: { margin: 0, fontSize: '16px' } }, 
                        processing ? '‚è≥ AI Analyzing...' : `ü§ñ Suggestions (${suggestions.length})`
                    ),
                    React.createElement('button', {
                        onClick: onClose,
                        style: {
                            background: 'none',
                            border: 'none',
                            color: 'white',
                            fontSize: '20px',
                            cursor: 'pointer',
                            padding: '0 5px'
                        }
                    }, '√ó')
                ),
                !processing && suggestions.length > 0 && React.createElement('div', {
                    style: {
                        padding: '10px 15px',
                        background: '#f5f5f5',
                        borderBottom: '1px solid #ddd',
                        display: 'flex',
                        gap: '10px',
                        alignItems: 'center'
                    }
                },
                    React.createElement('input', {
                        type: 'checkbox',
                        checked: selectAll,
                        onChange: toggleSelectAll,
                        style: { cursor: 'pointer' }
                    }),
                    React.createElement('span', { 
                        style: { fontSize: '12px', fontWeight: 'bold', flex: 1 }
                    }, `Select All (${selectedIds.size}/${suggestions.length})`),
                    React.createElement('button', {
                        className: 'btn btn-success',
                        onClick: approveSelected,
                        disabled: selectedIds.size === 0,
                        style: { fontSize: '11px', padding: '5px 10px' }
                    }, `‚úÖ Approve Selected (${selectedIds.size})`),
                    React.createElement('button', {
                        className: 'btn btn-primary',
                        onClick: approveAll,
                        style: { fontSize: '11px', padding: '5px 10px' }
                    }, i18n.t('app.approve_all')))
                ),
                React.createElement('div', {
                    style: {
                        flex: 1,
                        overflowY: 'auto',
                        padding: '15px'
                    }
                },
                    processing ? React.createElement('div', {
                        style: { textAlign: 'center', padding: '40px', color: '#666' }
                    },
                        React.createElement('div', { style: { fontSize: '48px', marginBottom: '10px' } }, 'ü§ñ'),
                        React.createElement('div', null, i18n.t('app.ai_analyzing')),
                        React.createElement('div', { style: { fontSize: '12px', marginTop: '5px' } }, i18n.t('app.ai_wait')))
                    ) : suggestions.length === 0 ? React.createElement('div', {
                        style: { textAlign: 'center', padding: '40px', color: '#666' }
                    },
                        React.createElement('div', { style: { fontSize: '48px', marginBottom: '10px' } }, 'üéâ'),
                        React.createElement('div', null, i18n.t('app.no_suggestions')),
                        React.createElement('div', { style: { fontSize: '12px', marginTop: '5px' } }, i18n.t('app.all_reviewed')))
                    ) : suggestions.map((suggestion, idx) =>
                        React.createElement('div', {
                            key: idx,
                            style: {
                                padding: '15px',
                                background: isSelected(suggestion) ? '#e8f4ff' : '#f9f9f9',
                                borderRadius: '8px',
                                marginBottom: '10px',
                                border: isSelected(suggestion) ? '2px solid #00BCD4' : '1px solid #ddd'
                            }
                        },
                            React.createElement('div', {
                                style: { display: 'flex', gap: '10px', alignItems: 'flex-start' }
                            },
                                React.createElement('input', {
                                    type: 'checkbox',
                                    checked: isSelected(suggestion),
                                    onChange: () => toggleSelection(suggestion),
                                    style: { 
                                        cursor: 'pointer',
                                        marginTop: '3px',
                                        width: '16px',
                                        height: '16px'
                                    }
                                }),
                                React.createElement('div', { style: { flex: 1 } },
                                    React.createElement('div', {
                                        style: {
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            marginBottom: '10px'
                                        }
                                    },
                                        React.createElement('span', {
                                            style: {
                                                fontSize: '11px',
                                                padding: '4px 8px',
                                                borderRadius: '12px',
                                                fontWeight: 'bold',
                                                background: suggestion.confidence > 0.8 ? '#d4edda' : 
                                                           suggestion.confidence > 0.6 ? '#fff3cd' : '#f8d7da',
                                                color: suggestion.confidence > 0.8 ? '#155724' :
                                                       suggestion.confidence > 0.6 ? '#856404' : '#721c24'
                                            }
                                        }, `${Math.round(suggestion.confidence * 100)}% confident`)
                                    ),
                                    React.createElement('div', {
                                        style: {
                                            fontSize: '12px',
                                            fontFamily: 'monospace',
                                            marginBottom: '8px',
                                            fontWeight: 'bold'
                                        }
                                    }, 
                                        `üì• ${suggestion.source_field}`,
                                        React.createElement('div', { style: { color: '#00BCD4', margin: '5px 0' } }, '‚Üì'),
                                        `üì§ ${suggestion.target_field}`
                                    ),
                                    suggestion.suggested_formula && React.createElement('div', {
                                        style: {
                                            fontSize: '11px',
                                            padding: '8px',
                                            background: '#fff',
                                            borderRadius: '4px',
                                            fontFamily: 'monospace',
                                            marginBottom: '8px',
                                            border: '1px solid #ddd'
                                        }
                                    }, `‚úèÔ∏è ${suggestion.suggested_formula}`),
                                    React.createElement('div', {
                                        style: {
                                            fontSize: '11px',
                                            color: '#666',
                                            fontStyle: 'italic',
                                            marginBottom: '10px',
                                            lineHeight: '1.4'
                                        }
                                    }, `üí° ${suggestion.reasoning}`),
                                    React.createElement('div', {
                                        style: { display: 'flex', gap: '8px' }
                                    },
                                        React.createElement('button', {
                                            className: 'btn btn-success',
                                            style: { flex: 1, fontSize: '11px', padding: '8px' },
                                            onClick: () => onApprove(suggestion)
                                        }, i18n.t('app.apply'))),
                                        React.createElement('button', {
                                            className: 'btn btn-danger',
                                            style: { flex: 1, fontSize: '11px', padding: '8px' },
                                            onClick: () => onReject(suggestion)
                                        }, i18n.t('app.reject')))
                                    )
                                )
                            )
                        )
                    )
                )
            );
        }
        
        function App() {
            const [inputSchema, setInputSchema] = useState(null);
            const [outputSchema, setOutputSchema] = useState(null);
            const [inputSchemaDefinition, setInputSchemaDefinition] = useState(null); // Schema Editor definition
            const [outputSchemaDefinition, setOutputSchemaDefinition] = useState(null); // Schema Editor definition
            const [connections, setConnections] = useState([]);
            const [selectedConnection, setSelectedConnection] = useState(null);
            const [draggedField, setDraggedField] = useState(null);
            const [mappingName, setMappingName] = useState('');
            const [statusMessage, setStatusMessage] = useState(null);
            const [showUploadModal, setShowUploadModal] = useState(false);
            const [uploadDirection, setUploadDirection] = useState('input');
            const [activeTab, setActiveTab] = useState('input');
            const [fieldPositions, setFieldPositions] = useState({});
            const [sessionLoaded, setSessionLoaded] = useState(false);
            const [inputExample, setInputExample] = useState('');
            const [outputExample, setOutputExample] = useState('');
            const [hoverPopup, setHoverPopup] = useState(null);
            const [showFormulaEditor, setShowFormulaEditor] = useState(false);
            const [availableFormulas, setAvailableFormulas] = useState([]);
            const [editingConnection, setEditingConnection] = useState(null);
            
            // i18n force-update on language change
            const [, setLangTick] = useState(0);
            React.useEffect(() => {
                window.__buddylikoForceUpdate = () => setLangTick(t => t + 1);
                return () => { window.__buddylikoForceUpdate = null; };
            }, []);
            
            // AI Integration
            const [aiSuggestions, setAiSuggestions] = useState([]);
            const [showAiPanel, setShowAiPanel] = useState(false);
            const [aiProcessing, setAiProcessing] = useState(false);
            const [showAiWork, setShowAiWork] = useState(false);
            const [aiWorkLog, setAiWorkLog] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [selectedOutputField, setSelectedOutputField] = useState(null);

            // Billing & Usage
            const [billingStatus, setBillingStatus] = useState(null);
            const [usageAlerts, setUsageAlerts] = useState([]);
            const [showBillingModal, setShowBillingModal] = useState(false);

            // Account / Security / Federated Login
            const [showAccountModal, setShowAccountModal] = useState(false);
            const [linkedProviders, setLinkedProviders] = useState(null);
            const [accountTab, setAccountTab] = useState('providers');

            // DB Connector
            const [dbConnections, setDbConnections] = useState([]);
            const [showDbConnPanel, setShowDbConnPanel] = useState(false);
            const [dbPanelView, setDbPanelView] = useState('list'); // list | create | tables | preview | write
            const [dbSelectedConn, setDbSelectedConn] = useState(null);
            const [dbTables, setDbTables] = useState([]);
            const [dbSelectedTable, setDbSelectedTable] = useState('');
            const [dbPreviewData, setDbPreviewData] = useState(null);
            const [dbTableSide, setDbTableSide] = useState('input');
            const [dbNewConn, setDbNewConn] = useState({ name:'', db_type:'postgresql', host:'localhost', port:'', database:'', user:'', password:'', schema:'public' });
            const [dbWriteMode, setDbWriteMode] = useState('insert');
            const [dbWritePk, setDbWritePk] = useState('');
            const [dbLoading, setDbLoading] = useState(false);

            // EDI / HL7 detected format
            const [showEdiHl7Panel, setShowEdiHl7Panel] = useState(false);
            
            // Schema Editor
            const [showSchemaEditor, setShowSchemaEditor] = useState(false);
            
            // Sidebar visibility
            const [showSidebar, setShowSidebar] = useState(true);
            
            // Search functionality
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [currentSearchIndex, setCurrentSearchIndex] = useState(-1);
            const [highlightedField, setHighlightedField] = useState(null);
            
            // Persistent popup
            const [popupPinned, setPopupPinned] = useState(false);
            
            // Hide/show connected fields
            const [hideConnected, setHideConnected] = useState(false);
            
            // Available schemas from backend
            const [availableInputSchemas, setAvailableInputSchemas] = useState([]);
            const [availableOutputSchemas, setAvailableOutputSchemas] = useState([]);
            
            // Selected schema IDs (for persistence and reverse mapping)
            const [inputSchemaId, setInputSchemaId] = useState('');
            const [outputSchemaId, setOutputSchemaId] = useState('');
            
            // Node import / bundle / edit features
            const [showNodeImportModal, setShowNodeImportModal] = useState(false);
            const [nodeImportDirection, setNodeImportDirection] = useState('input');
            const [nodeBundles, setNodeBundles] = useState([]);
            const [contextMenu, setContextMenu] = useState(null); // { x, y, field, colType }
            const [editingNode, setEditingNode] = useState(null);  // { field, colType }

            const canvasRef = useRef(null);
            const hoverTimeoutRef = useRef(null);
            
            const showStatus = (message, type) => {
                setStatusMessage({ message, type });
                setTimeout(() => setStatusMessage(null), 5000);
            };
            
            // Load session on mount
            useEffect(() => {
                loadSession();
                loadAvailableSchemas();
                fetchBillingStatus();
                fetchDbConnections();
            }, []);
            
            // Load available schemas from /api/schemas/list
            const loadAvailableSchemas = async () => {
                try {
                    const res = await fetch(`${API_URL}/schemas/list`);
                    if (!res.ok) {
                        console.error('Failed to load schemas');
                        return;
                    }
                    const data = await res.json();
                    
                    // Update state instead of manipulating DOM
                    setAvailableInputSchemas(data.input || []);
                    setAvailableOutputSchemas(data.output || []);
                    
                    console.log('‚úÖ Loaded schemas:', data);
                } catch (err) {
                    console.error('Failed to load available schemas:', err);
                }
            };
            
            // Auto-save to localStorage every 30 seconds
            useEffect(() => {
                if (!sessionLoaded) return;
                
                const autoSave = setInterval(() => {
                    saveToLocalStorage();
                }, 30000); // 30 seconds
                
                return () => clearInterval(autoSave);
            }, [inputSchema, outputSchema, connections, mappingName, sessionLoaded]);
            
            // Save on window close
            useEffect(() => {
                const handleBeforeUnload = (e) => {
                    saveToLocalStorage();
                };
                
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [inputSchema, outputSchema, connections, mappingName]);
            
            const saveToLocalStorage = () => {
                try {
                    const session = {
                        inputSchema,
                        outputSchema,
                        inputSchemaId,
                        outputSchemaId,
                        connections,
                        mappingName,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('mappingSession', JSON.stringify(session));
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
            };
            
            const loadSession = async () => {
                try {
                    // Try localStorage first (instant recovery)
                    const localSession = localStorage.getItem('mappingSession');
                    if (localSession) {
                        const session = JSON.parse(localSession);
                        if (session.inputSchema) setInputSchema(session.inputSchema);
                        if (session.outputSchema) setOutputSchema(session.outputSchema);
                        if (session.inputSchemaId) setInputSchemaId(session.inputSchemaId);
                        if (session.outputSchemaId) setOutputSchemaId(session.outputSchemaId);
                        if (session.connections) setConnections(session.connections);
                        if (session.mappingName) setMappingName(session.mappingName);
                        
                        showStatus(`‚úÖ Session recovered (${new Date(session.timestamp).toLocaleTimeString()})`, 'success');
                        setSessionLoaded(true);
                        setTimeout(updateFieldPositions, 500);
                        return;
                    }
                    
                    // Try backend session
                    const response = await fetch(`${API_URL}/session/load`);
                    const result = await response.json();
                    
                    if (result.success && result.session) {
                        const session = result.session;
                        if (session.inputSchema) setInputSchema(session.inputSchema);
                        if (session.outputSchema) setOutputSchema(session.outputSchema);
                        if (session.connections) setConnections(session.connections);
                        if (session.mappingName) setMappingName(session.mappingName);
                        
                        showStatus('‚úÖ Previous session loaded', 'success');
                        setTimeout(updateFieldPositions, 500);
                    }
                    
                    setSessionLoaded(true);
                } catch (error) {
                    console.error('Error loading session:', error);
                    setSessionLoaded(true);
                }
            };
            
            const saveSessionToBackend = async () => {
                try {
                    const session = {
                        inputSchema,
                        outputSchema,
                        connections,
                        mappingName
                    };
                    
                    const response = await fetch(`${API_URL}/session/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(session)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showStatus('üíæ Session saved to server', 'success');
                    }
                } catch (error) {
                    showStatus('‚ùå Error saving session', 'error');
                }
            };
            
            const clearSession = async () => {
                if (!confirm('Clear current session? This will remove all schemas and connections.')) {
                    return;
                }
                
                setInputSchema(null);
                setOutputSchema(null);
                setConnections([]);
                setMappingName('');
                setSelectedConnection(null);
                
                localStorage.removeItem('mappingSession');
                
                try {
                    await fetch(`${API_URL}/session`, { method: 'DELETE' });
                } catch (error) {
                    console.error('Error clearing backend session:', error);
                }
                
                showStatus('üóëÔ∏è Session cleared', 'success');
            };
            
            const uploadSchema = async (file, direction, type) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('name', file.name);
                formData.append('schema_type', type);
                formData.append('direction', direction);
                
                // Save example file content
                const fileContent = await file.text();
                if (direction === 'input') {
                    setInputExample(fileContent);
                } else {
                    setOutputExample(fileContent);
                }
                
                try {
                    const response = await fetch(`${API_URL}/schemas/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        if (direction === 'input') {
                            setInputSchema(result.schema);
                        } else {
                            setOutputSchema(result.schema);
                        }
                        showStatus(`‚úÖ ${direction} schema uploaded: ${result.schema.field_count} fields`, 'success');
                        setShowUploadModal(false);
                        
                        // Calculate positions after schemas load
                        setTimeout(updateFieldPositions, 100);
                    }
                } catch (error) {
                    showStatus('‚ùå Error: ' + error.message, 'error');
                }
            };
            
            const uploadExampleFile = async (file, direction) => {
                const fileContent = await file.text();
                if (direction === 'input') {
                    setInputExample(fileContent);
                    showStatus(`‚úÖ Input example file loaded (${file.name})`, 'success');
                } else {
                    setOutputExample(fileContent);
                    showStatus(`‚úÖ Output example file loaded (${file.name})`, 'success');
                }
            };
            
            const updateFieldPositions = () => {
                const positions = {};
                const canvasEl = canvasRef.current;
                if (!canvasEl) return;
                
                const canvasRect = canvasEl.getBoundingClientRect();
                const scrollTop = canvasEl.scrollTop;
                const scrollLeft = canvasEl.scrollLeft;
                
                document.querySelectorAll('[data-field-id]').forEach(el => {
                    const rect = el.getBoundingClientRect();
                    const fieldId = el.dataset.fieldId;
                    const isInput = fieldId.startsWith('input-');
                    
                    positions[fieldId] = {
                        x: (isInput 
                            ? rect.right - canvasRect.left  // Input: dalla fine (destra) del box
                            : rect.left - canvasRect.left) + scrollLeft,   // Output: dall'inizio (sinistra) del box
                        y: rect.top - canvasRect.top + rect.height / 2 + scrollTop
                    };
                });
                setFieldPositions(positions);
            };
            
            useEffect(() => {
                let animationFrameId;
                
                const handleScroll = () => {
                    // Use requestAnimationFrame for smooth updates
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                    }
                    animationFrameId = requestAnimationFrame(updateFieldPositions);
                };
                
                window.addEventListener('resize', updateFieldPositions);
                const canvasEl = canvasRef.current;
                if (canvasEl) {
                    canvasEl.addEventListener('scroll', handleScroll, true);
                }
                return () => {
                    window.removeEventListener('resize', updateFieldPositions);
                    if (canvasEl) {
                        canvasEl.removeEventListener('scroll', handleScroll, true);
                    }
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                    }
                };
            }, []);
            
            useEffect(() => {
                if (inputSchema || outputSchema) {
                    setTimeout(updateFieldPositions, 100);
                }
            }, [inputSchema, outputSchema]);
            
            // Update positions when connections change (new arrows added)
            useEffect(() => {
                if (connections.length > 0) {
                    setTimeout(updateFieldPositions, 50);
                }
            }, [connections]);
            
            // Update positions when formula editor opens/closes (layout shifts)
            // Re-draw arrows whenever formula editor opens/closes
            useEffect(() => {
                setTimeout(updateFieldPositions, 50);
                setTimeout(updateFieldPositions, 200);
                setTimeout(updateFieldPositions, 400);
            }, [showFormulaEditor]);

            // Re-draw arrows when properties panel opens/closes (changes canvas width)
            useEffect(() => {
                setTimeout(updateFieldPositions, 50);
                setTimeout(updateFieldPositions, 200);
                setTimeout(updateFieldPositions, 400);
            }, [selectedConnection]);

            // ResizeObserver: re-draw arrows on ANY canvas size change (most robust)
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ro = new ResizeObserver(() => { updateFieldPositions(); });
                ro.observe(canvas);
                return () => ro.disconnect();
            }, []);
            
            // Update positions when sidebar is toggled (layout shifts)
            useEffect(() => {
                // Wait for the CSS transition to complete (0.3s)
                setTimeout(updateFieldPositions, 350);
            }, [showSidebar]);

            // Load available formulas from backend on mount
            useEffect(() => {
                fetch('/api/formulas')
                    .then(r => r.json())
                    .then(data => {
                        if (data.formulas && data.formulas.length > 0) {
                            setAvailableFormulas(data.formulas);
                        }
                    })
                    .catch(() => {}); // silently ignore if backend not available
            }, []);
            
            // Search function with RegExp
            const performSearch = () => {
                if (!searchQuery.trim()) {
                    setSearchResults([]);
                    setCurrentSearchIndex(-1);
                    setHighlightedField(null);
                    return;
                }
                
                const results = [];
                let regex;
                
                try {
                    // Try to create regex from search query
                    regex = new RegExp(searchQuery, 'i'); // case insensitive
                } catch (e) {
                    // If invalid regex, treat as literal string
                    regex = new RegExp(searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
                }
                
                // Search in INPUT schema
                if (inputSchema && inputSchema.fields) {
                    Object.values(inputSchema.fields).forEach(field => {
                        if (regex.test(field.name) || 
                            regex.test(field.path) || 
                            regex.test(field.business_term || '') ||
                            regex.test(field.description || '')) {
                            results.push({ field, type: 'input' });
                        }
                    });
                }
                
                // Search in OUTPUT schema
                if (outputSchema && outputSchema.fields) {
                    Object.values(outputSchema.fields).forEach(field => {
                        if (regex.test(field.name) || 
                            regex.test(field.path) || 
                            regex.test(field.business_term || '') ||
                            regex.test(field.description || '')) {
                            results.push({ field, type: 'output' });
                        }
                    });
                }
                
                setSearchResults(results);
                if (results.length > 0) {
                    setCurrentSearchIndex(0);
                    scrollToField(results[0]);
                } else {
                    setCurrentSearchIndex(-1);
                    setHighlightedField(null);
                    showStatus('üîç No results found', 'error');
                }
            };
            
            const nextSearchResult = () => {
                if (searchResults.length === 0) return;
                
                const nextIndex = (currentSearchIndex + 1) % searchResults.length;
                setCurrentSearchIndex(nextIndex);
                scrollToField(searchResults[nextIndex]);
            };
            
            const scrollToField = (result) => {
                setHighlightedField(result);
                
                // Find the field element and scroll to it
                const fieldId = `${result.type}-${result.field.id}`;
                const element = document.querySelector(`[data-field-id="${fieldId}"]`);
                
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Flash highlight animation
                    element.style.transition = 'box-shadow 0.3s';
                    element.style.boxShadow = '0 0 20px 5px #ffd700';
                    setTimeout(() => {
                        element.style.boxShadow = '';
                    }, 1000);
                }
            };
            
            const addConnection = (sourceField, targetField) => {
                // Check if connection already exists
                const exists = connections.find(c => 
                    c.source === sourceField.path && c.target === targetField.path
                );
                if (exists) {
                    showStatus('‚ö†Ô∏è Connection already exists', 'error');
                    return;
                }
                
                const conn = {
                    id: `conn_${Date.now()}`,
                    source: sourceField.id || sourceField.path,
                    target: targetField.id || targetField.path,
                    sourcePath: sourceField.xml_path || sourceField.path,
                    targetPath: targetField.xml_path || targetField.path,
                    sourceName: sourceField.name,
                    targetName: targetField.name,
                    transformation: { type: 'direct' }
                };
                setConnections([...connections, conn]);
                showStatus(`‚úÖ Connected: ${sourceField.name} ‚Üí ${targetField.name}`, 'success');
                updateFieldPositions();
            };
            
            const deleteConnection = (connId) => {
                setConnections(connections.filter(c => c.id !== connId));
                setSelectedConnection(null);
                showStatus('üóëÔ∏è Connection deleted', 'success');
            };

            // ===== NODE FEATURES =====

            // Import a set of rows as a draggable bundle
            const handleNodeBundleImport = (rows, direction) => {
                // Normalize rows: ensure they have at least 'name' field
                const nodes = rows.map(r => ({
                    name: r.name || r.field_name || r.Field_Name || r.Name || Object.values(r)[0] || 'Unknown',
                    type: r.type || r.Type || 'string',
                    cardinality: r.cardinality || r.Cardinality || '0..1',
                    business_term: r.business_term || r.Business_Term || '',
                    description: r.description || r.Description || '',
                    required: false,
                    _raw: r
                }));
                const bundle = {
                    id: 'bundle_' + Date.now(),
                    direction,
                    nodes
                };
                setNodeBundles(prev => [...prev, bundle]);
                showStatus(`üì¶ Pacchetto creato con ${nodes.length} nodi ‚Äî trascinalo sullo schema`, 'success');
            };

            // Drop bundle after a specific field
            const handleBundleDrop = (bundle, fieldId, colType) => {
                const schema = colType === 'input' ? inputSchema : outputSchema;
                const setSchema = colType === 'input' ? setInputSchema : setOutputSchema;
                if (!schema) return;

                const fieldKey = fieldId.replace(`${colType}-`, '').replace(/_/g, '.');
                const fieldEntries = Object.entries(schema.fields);
                const dropIdx = fieldEntries.findIndex(([k]) => k === fieldKey || k.replace(/\./g,'_') === fieldKey.replace(/\./g,'_'));

                // Build new field objects
                const newFields = {};
                bundle.nodes.forEach((n, i) => {
                    const id = `imported_${Date.now()}_${i}`;
                    const path = `imported.${n.name.replace(/\s+/g,'_')}`;
                    newFields[path] = {
                        id, name: n.name, path, type: n.type,
                        cardinality: n.cardinality, business_term: n.business_term,
                        description: n.description, required: n.required,
                        xml_path: `/${schema.name || 'root'}/${n.name}`
                    };
                });

                // Insert after dropIdx
                const before = fieldEntries.slice(0, dropIdx + 1);
                const after = fieldEntries.slice(dropIdx + 1);
                const allFields = Object.fromEntries([...before, ...Object.entries(newFields), ...after]);

                setSchema({ ...schema, fields: allFields });
                setNodeBundles(prev => prev.filter(b => b.id !== bundle.id));
                showStatus(`‚úÖ ${bundle.nodes.length} nodi inseriti dopo il campo selezionato`, 'success');
                setTimeout(updateFieldPositions, 100);
            };

            // Dismiss a bundle without dropping
            const dismissBundle = (bundleId) => {
                setNodeBundles(prev => prev.filter(b => b.id !== bundleId));
            };

            // Delete a node (field) from schema + remove all connections
            const deleteNode = (field, colType) => {
                if (!window.confirm(`Eliminare il nodo "${field.name}"?\nVerranno rimossi anche tutti i collegamenti associati.`)) return;

                const schema = colType === 'input' ? inputSchema : outputSchema;
                const setSchema = colType === 'input' ? setInputSchema : setOutputSchema;
                if (!schema) return;

                // Build new fields object excluding any key that matches this field
                const newFields = {};
                Object.entries(schema.fields).forEach(([k, f]) => {
                    const isThisField = 
                        f.id === field.id ||
                        f.path === field.path ||
                        k === field.path ||
                        k === field.id;
                    if (!isThisField) {
                        newFields[k] = f;
                    }
                });

                setSchema({ ...schema, fields: newFields });

                // Remove connections involving this field
                setConnections(prev => prev.filter(c => {
                    if (colType === 'input') {
                        return c.source !== field.path && c.source !== field.id && c.source !== field.name;
                    } else {
                        return c.target !== field.path && c.target !== field.id && c.target !== field.name;
                    }
                }));

                showStatus(`üóëÔ∏è Nodo "${field.name}" eliminato con i suoi collegamenti`, 'success');
                setTimeout(updateFieldPositions, 100);
            };

            // Edit / update a node
            const saveNodeEdit = (updatedField, colType) => {
                const schema = colType === 'input' ? inputSchema : outputSchema;
                const setSchema = colType === 'input' ? setInputSchema : setOutputSchema;
                if (!schema) return;

                const newFields = {};
                Object.entries(schema.fields).forEach(([k, f]) => {
                    const isThisField =
                        f.id === updatedField.id ||
                        f.path === updatedField.path ||
                        k === updatedField.path ||
                        k === updatedField.id;
                    newFields[k] = isThisField ? { ...f, ...updatedField } : f;
                });

                setSchema({ ...schema, fields: newFields });
                showStatus(`‚úÖ Nodo "${updatedField.name}" aggiornato`, 'success');
                setTimeout(updateFieldPositions, 100);
            };

            // Open context menu on right-click of a field
            const handleFieldContextMenu = (e, field, colType) => {
                e.preventDefault();
                e.stopPropagation();
                setContextMenu({ x: e.clientX, y: e.clientY, field, colType });
            };
            
            // Expose delete callback for double-click on connections
            useEffect(() => {
                window.deleteConnectionCallback = deleteConnection;
                
                // Export functions
                window.exportMappingCSV = () => {
                    let csv = 'Source Field,Source Path,Target Field,Target Path,Transformation,Source Type,Target Type,Business Term Source,Business Term Target,Source Offset,Source Length,Source XMLPath,Target Offset,Target Length,Target XMLPath\n';
                    connections.forEach(conn => {
                        const sourceField = inputSchema?.fields?.[conn.source] || {};
                        const targetField = outputSchema?.fields?.[conn.target] || {};
                        const transformation = conn.transformation?.type || 'direct';
                        
                        csv += `"${conn.sourceName || conn.source}","${conn.source}","${conn.targetName || conn.target}","${conn.target}","${transformation}","${sourceField.type || ''}","${targetField.type || ''}","${sourceField.business_term || ''}","${targetField.business_term || ''}","${sourceField.offset || ''}","${sourceField.length || ''}","${sourceField.xml_path || ''}","${targetField.offset || ''}","${targetField.length || ''}","${targetField.xml_path || ''}"\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${mappingName || 'mapping'}_export.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showStatus('üìä Mapping exported as CSV', 'success');
                };
                
                window.exportMappingJSON = () => {
                    const mappingData = {
                        name: mappingName,
                        created: new Date().toISOString(),
                        inputSchema: inputSchema?.name || 'input',
                        outputSchema: outputSchema?.name || 'output',
                        connections: connections.map(conn => ({
                            id: conn.id,
                            source: {
                                field: conn.source,
                                name: conn.sourceName,
                                path: conn.source,
                                type: inputSchema?.fields?.[conn.source]?.type,
                                businessTerm: inputSchema?.fields?.[conn.source]?.business_term,
                                offset: inputSchema?.fields?.[conn.source]?.offset,
                                length: inputSchema?.fields?.[conn.source]?.length,
                                xmlPath: inputSchema?.fields?.[conn.source]?.xml_path
                            },
                            target: {
                                field: conn.target,
                                name: conn.targetName,
                                path: conn.target,
                                type: outputSchema?.fields?.[conn.target]?.type,
                                businessTerm: outputSchema?.fields?.[conn.target]?.business_term,
                                calculation: outputSchema?.fields?.[conn.target]?.calculation,
                                offset: outputSchema?.fields?.[conn.target]?.offset,
                                length: outputSchema?.fields?.[conn.target]?.length,
                                xmlPath: outputSchema?.fields?.[conn.target]?.xml_path
                            },
                            transformation: conn.transformation
                        }))
                    };
                    
                    const blob = new Blob([JSON.stringify(mappingData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${mappingName || 'mapping'}_export.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showStatus('üìÑ Mapping exported as JSON', 'success');
                };
                
                return () => {
                    delete window.deleteConnectionCallback;
                    delete window.exportMappingCSV;
                    delete window.exportMappingJSON;
                };
            }, [connections, mappingName, inputSchema, outputSchema]);
            
            // Project Management: Save Project
            const saveProject = async () => {
                const name = mappingName || 'Buddyliko_Project';
                const project = {
                    projectName: name,
                    version: '2.0',
                    created: new Date().toISOString(),
                    inputSchema: inputSchema,
                    outputSchema: outputSchema,
                    inputSchemaId: inputSchemaId,
                    outputSchemaId: outputSchemaId,
                    inputSchemaDefinition: inputSchemaDefinition,
                    outputSchemaDefinition: outputSchemaDefinition,
                    inputExample: inputExample,
                    outputExample: outputExample,
                    connections: connections
                };

                // Salva sempre localmente come file JSON
                const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${name}_project.json`;
                a.click();
                URL.revokeObjectURL(url);

                // Salva anche nel Workspace se autenticati
                const token = localStorage.getItem('buddyliko_token');
                if (token) {
                    try {
                        const resp = await fetch(`${API_URL}/workspace/projects/save`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ name, description: '', project_data: project })
                        });
                        if (resp.ok) {
                            showStatus('üì¶ Progetto salvato localmente e nel Workspace!', 'success');
                        } else {
                            showStatus('üì¶ Progetto salvato localmente!', 'success');
                        }
                    } catch(e) {
                        showStatus('üì¶ Progetto salvato localmente!', 'success');
                    }
                } else {
                    showStatus('üì¶ Project saved with schema definitions!', 'success');
                }
            };
            
            // Funzione condivisa per applicare i dati di un progetto
            const applyProject = (project) => {
                if (!project.projectName || !project.inputSchema || !project.outputSchema) {
                    showStatus('‚ö†Ô∏è File progetto non valido', 'error');
                    return false;
                }
                setMappingName(project.projectName);
                setInputSchema(project.inputSchema);
                setOutputSchema(project.outputSchema);
                setInputSchemaId(project.inputSchemaId || '');
                setOutputSchemaId(project.outputSchemaId || '');
                setInputSchemaDefinition(project.inputSchemaDefinition || null);
                setOutputSchemaDefinition(project.outputSchemaDefinition || null);
                setInputExample(project.inputExample || '');
                setOutputExample(project.outputExample || '');
                setConnections(project.connections || []);
                setTimeout(() => {
                    updateFieldPositions();
                    showStatus(`üì¶ Progetto "${project.projectName}" caricato!`, 'success');
                }, 500);
                return true;
            };

            // Carica progetto dal Workspace tramite file_id
            const loadProjectFromWorkspace = async (fileId) => {
                const token = localStorage.getItem('buddyliko_token');
                if (!token) return;
                try {
                    showStatus('‚è≥ Caricamento dal Workspace...', 'info');
                    const resp = await fetch(`${API_URL}/workspace/projects/${fileId}/load`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!resp.ok) { showStatus('‚ùå Impossibile caricare il progetto', 'error'); return; }
                    const data = await resp.json();
                    applyProject(data.project);
                } catch(e) {
                    showStatus('‚ùå Errore: ' + e.message, 'error');
                }
            };

            // Controlla se c'√® un file da aprire dal Workspace (impostato da openInMapper)
            React.useEffect(() => {
                const openFile = sessionStorage.getItem('buddyliko_open_file');
                if (openFile) {
                    sessionStorage.removeItem('buddyliko_open_file');
                    try {
                        const ref = JSON.parse(openFile);
                        if (ref.fileId) loadProjectFromWorkspace(ref.fileId);
                    } catch(e) { console.error('open_file parse error', e); }
                }
            }, []);

            // Project Management: Load Project (da file locale)
            const loadProject = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        const text = await file.text();
                        const project = JSON.parse(text);
                        applyProject(project);
                    } catch (err) {
                        console.error('Load project error:', err);
                        showStatus('‚ùå Failed to load project: ' + err.message, 'error');
                    }
                };
                input.click();
            };
            
            // ================================================================
            // BILLING & USAGE
            // ================================================================
            const fetchBillingStatus = async () => {
                const token = localStorage.getItem('buddyliko_token');
                if (!token) return;
                try {
                    const res = await fetch(`${API_URL}/billing/status`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setBillingStatus(data);

                    // Load linked OAuth providers
                    try {
                        const provRes = await fetch(`${API_URL}/auth/providers`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (provRes.ok) setLinkedProviders(await provRes.json());
                    } catch(e) {}
                        // Fetch alerts separately
                        const aRes = await fetch(`${API_URL}/billing/usage/alerts`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (aRes.ok) {
                            const aData = await aRes.json();
                            setUsageAlerts(aData.alerts || []);
                        }
                    }
                } catch (_e) {}
            };

            // ================================================================
            // DB CONNECTOR
            // ================================================================
            const fetchDbConnections = async () => {
                const token = localStorage.getItem('buddyliko_token');
                if (!token) return;
                try {
                    const res = await fetch(`${API_URL}/dbconn/list`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (res.ok) { const data = await res.json(); setDbConnections(data.connections || []); }
                } catch (_e) {}
            };

            const loadDbTableAsSchema = async (connId, tableName, side) => {
                const token = localStorage.getItem('buddyliko_token');
                try {
                    const res = await fetch(`${API_URL}/dbconn/${connId}/schema/${tableName}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error(await res.text());
                    const schema = await res.json();
                    if (side === 'input') {
                        setInputSchema(schema);
                        showStatus(`‚úÖ Schema "${tableName}" caricato come input`, 'success');
                    } else {
                        setOutputSchema(schema);
                        showStatus(`‚úÖ Schema "${tableName}" caricato come output`, 'success');
                    }
                } catch (e) {
                    showStatus(`‚ùå ${e.message}`, 'error');
                }
            };

            // DB Connector ‚Äî create connection
            const dbCreateConnection = async () => {
                const token = localStorage.getItem('buddyliko_token');
                setDbLoading(true);
                try {
                    const params = { host: dbNewConn.host, port: dbNewConn.port || undefined, database: dbNewConn.database, user: dbNewConn.user, password: dbNewConn.password, schema: dbNewConn.schema };
                    const res = await fetch(`${API_URL}/dbconn/save`, {
                        method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: dbNewConn.name, db_type: dbNewConn.db_type, connection_params: params })
                    });
                    if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.detail || 'Errore'); }
                    showStatus('‚úÖ Connessione creata!', 'success');
                    setDbNewConn({ name:'', db_type:'postgresql', host:'localhost', port:'', database:'', user:'', password:'', schema:'public' });
                    setDbPanelView('list');
                    loadDbConnections_();
                } catch (e) { showStatus(`‚ùå ${e.message}`, 'error'); }
                setDbLoading(false);
            };

            // DB Connector ‚Äî load connections (alias)
            const loadDbConnections_ = fetchDbConnections;

            // DB Connector ‚Äî load tables for a connection
            const dbLoadTables = async (conn) => {
                const token = localStorage.getItem('buddyliko_token');
                setDbLoading(true);
                setDbSelectedConn(conn);
                try {
                    const res = await fetch(`${API_URL}/dbconn/${conn.id}/tables`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!res.ok) throw new Error(i18n.t('common.error'));
                    const d = await res.json();
                    setDbTables(d.tables || []);
                    setDbPanelView('tables');
                } catch (e) { showStatus(`‚ùå ${e.message}`, 'error'); }
                setDbLoading(false);
            };

            // DB Connector ‚Äî preview table data
            const dbLoadPreview = async (connId, tableName) => {
                const token = localStorage.getItem('buddyliko_token');
                setDbLoading(true);
                try {
                    const res = await fetch(`${API_URL}/dbconn/${connId}/preview`, {
                        method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ table_name: tableName, limit: 20 })
                    });
                    if (!res.ok) throw new Error(i18n.t('common.error'));
                    const d = await res.json();
                    setDbPreviewData(d);
                    setDbPanelView('preview');
                } catch (e) { showStatus(`‚ùå ${e.message}`, 'error'); }
                setDbLoading(false);
            };

            // DB Connector ‚Äî test connection
            const dbTestConnection = async (connId) => {
                const token = localStorage.getItem('buddyliko_token');
                setDbLoading(true);
                try {
                    const res = await fetch(`${API_URL}/dbconn/${connId}/test`, {
                        method: 'POST', headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const d = await res.json();
                    if (d.success) showStatus('‚úÖ Connessione OK!', 'success');
                    else showStatus(`‚ùå ${d.message || i18n.t('common.failed')}`, 'error');
                    loadDbConnections_();
                } catch (e) { showStatus(`‚ùå ${e.message}`, 'error'); }
                setDbLoading(false);
            };

            // DB Connector ‚Äî delete connection
            const dbDeleteConnection = async (connId) => {
                if (!confirm('Eliminare questa connessione?')) return;
                const token = localStorage.getItem('buddyliko_token');
                try {
                    await fetch(`${API_URL}/dbconn/${connId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                    showStatus(i18n.t('admin.connection_deleted'), 'success');
                    loadDbConnections_();
                } catch (e) { showStatus(`‚ùå ${e.message}`, 'error'); }
            };

            // DB Connector ‚Äî write transformed data to DB
            const dbWriteData = async (connId, tableName, mode, pkCols) => {
                const token = localStorage.getItem('buddyliko_token');
                // Get output data from the current transform result
                if (!outputExample) { showStatus('‚ö†Ô∏è Nessun dato da scrivere ‚Äî esegui prima una trasformazione', 'error'); return; }
                setDbLoading(true);
                try {
                    let rows = [];
                    if (typeof outputExample === 'string') {
                        try { rows = JSON.parse(outputExample); } catch(_) {}
                    } else if (Array.isArray(outputExample)) {
                        rows = outputExample;
                    } else if (typeof outputExample === 'object') {
                        rows = [outputExample];
                    }
                    if (!rows.length) { showStatus('‚ö†Ô∏è Nessun dato valido per la scrittura', 'error'); setDbLoading(false); return; }
                    const res = await fetch(`${API_URL}/dbconn/${connId}/execute-write`, {
                        method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ table_name: tableName, rows, mode, pk_columns: pkCols.split(',').map(s=>s.trim()).filter(Boolean) })
                    });
                    const d = await res.json();
                    if (d.success !== false) {
                        showStatus(`‚úÖ Scritto su ${tableName}: ${d.inserted||0} inseriti, ${d.updated||0} aggiornati${d.errors?.length ? `, ${d.errors.length} errori` : ''}`, 'success');
                    } else {
                        showStatus(`‚ùå ${d.detail || i18n.t('common.error')}`, 'error');
                    }
                } catch (e) { showStatus(`‚ùå ${e.message}`, 'error'); }
                setDbLoading(false);
            };

            // ================================================================
            // EDI / HL7 ‚Äî importa file come schema
            // ================================================================
            const importEdiAsSchema = async (side) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.edi,.x12,.edifact,.hl7,.json,.xml';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const token = localStorage.getItem('buddyliko_token');

                    // Detect format
                    const detectRes = await fetch(`${API_URL}/edi/detect`, {
                        method: 'POST',
                        headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                        body: (() => { const f = new FormData(); f.append('file', file); return f; })()
                    });
                    const detectData = detectRes.ok ? await detectRes.json() : {};
                    const fmt = detectData.format || 'UNKNOWN';

                    // Route to correct parser
                    let endpoint = '/edi/schema-from-file';
                    if (fmt === 'HL7v2' || fmt === 'FHIR_JSON' || fmt === 'FHIR_XML') {
                        endpoint = '/hl7/schema-from-file';
                    } else if (fmt === 'UNKNOWN') {
                        // Try HL7 detect
                        const hlDetect = await fetch(`${API_URL}/hl7/detect`, {
                            method: 'POST',
                            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                            body: (() => { const f = new FormData(); f.append('file', file); return f; })()
                        });
                        if (hlDetect.ok) {
                            const hlData = await hlDetect.json();
                            if (hlData.format !== 'UNKNOWN') endpoint = '/hl7/schema-from-file';
                        }
                    }

                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('schema_name', file.name.split('.')[0]);

                    try {
                        const res = await fetch(`${API_URL}${endpoint}`, {
                            method: 'POST',
                            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                            body: formData
                        });
                        if (!res.ok) throw new Error(await res.text());
                        const schema = await res.json();
                        if (side === 'input') {
                            setInputSchema(schema);
                            showStatus(`‚úÖ Schema EDI/HL7 "${file.name}" caricato come input`, 'success');
                        } else {
                            setOutputSchema(schema);
                            showStatus(`‚úÖ Schema EDI/HL7 "${file.name}" caricato come output`, 'success');
                        }
                    } catch (err) {
                        showStatus(`‚ùå Errore import EDI/HL7: ${err.message}`, 'error');
                    }
                };
                input.click();
            };

            // ================================================================
            // ASYNC TRANSFORM ENGINE ‚Äî polling every 2 seconds
            // ================================================================
            const executeTransformAsync = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xml,.json,.csv';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const token = localStorage.getItem('buddyliko_token');
                    const mappingRules = {
                        connections: connections.map(conn => {
                            const srcField = inputSchema?.fields?.[conn.source] || {};
                            const tgtField = outputSchema?.fields?.[conn.target] || {};
                            return {
                                source: conn.source,
                                target: conn.target,
                                sourceName: conn.sourceName || srcField.name,
                                targetName: conn.targetName || tgtField.name,
                                sourcePath: conn.sourcePath || srcField.xml_path || srcField.path || conn.source,
                                targetPath: conn.targetPath || tgtField.xml_path || tgtField.path || conn.target,
                                transformation: conn.transformation || { type: 'DIRECT', formula: null }
                            };
                        }),
                        inputSchema,
                        outputSchema
                    };

                    // Show job status modal
                    const modal = _showJobModal('üîÑ Avvio trasformazione...');

                    try {
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('output_format', 'xml');
                        formData.append('validate', 'false');
                        formData.append('mapping_rules', JSON.stringify(mappingRules));

                        const submitRes = await fetch(`${API_URL}/transform/execute-async`, {
                            method: 'POST',
                            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                            body: formData
                        });

                        if (!submitRes.ok) {
                            // Fallback to sync if async not available
                            modal.update('‚ö†Ô∏è Async non disponibile, eseguo in modalit√† sincrona...');
                            formData.set('output_format', 'xml');
                            const syncRes = await fetch(`${API_URL}/transform/execute`, {
                                method: 'POST',
                                body: formData
                            });
                            if (syncRes.ok) {
                                const blob = await syncRes.blob();
                                _downloadBlob(blob, 'transformed_output.xml');
                                modal.success('‚úÖ Trasformazione completata!');
                            } else {
                                const err = await syncRes.json().catch(() => ({}));
                                modal.error('‚ùå ' + (err.detail || err.errors?.join(', ') || i18n.t('common.error')));
                            }
                            return;
                        }

                        const { job_id } = await submitRes.json();
                        modal.update(`‚è≥ Job ${job_id.substring(0,8)}... in coda`);

                        // Poll every 2 seconds
                        let attempts = 0;
                        const maxAttempts = 150; // 5 minutes max
                        const poll = setInterval(async () => {
                            attempts++;
                            if (attempts > maxAttempts) {
                                clearInterval(poll);
                                modal.error('‚è±Ô∏è Timeout: il job ha impiegato troppo tempo');
                                return;
                            }
                            try {
                                const statusRes = await fetch(`${API_URL}/jobs/${job_id}`, {
                                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                                });
                                if (!statusRes.ok) return;
                                const job = await statusRes.json();

                                const pct = job.progress || 0;
                                const statusLabel = {
                                    PENDING: '‚è≥ In coda',
                                    RUNNING: `‚öôÔ∏è In esecuzione (${pct}%)`,
                                    COMPLETED: '‚úÖ Completato',
                                    FAILED: '‚ùå Fallito',
                                    CANCELLED: 'üö´ Cancellato'
                                }[job.status] || job.status;

                                modal.update(statusLabel, pct);

                                if (job.status === 'COMPLETED') {
                                    clearInterval(poll);
                                    // Download result
                                    const dlRes = await fetch(`${API_URL}/jobs/${job_id}/download`, {
                                        headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                                    });
                                    if (dlRes.ok) {
                                        const blob = await dlRes.blob();
                                        _downloadBlob(blob, job.output_file_name || 'output.xml');
                                        modal.success(`‚úÖ Trasformazione completata! File scaricato.`);
                                    } else {
                                        modal.error('‚ùå Output non scaricabile');
                                    }
                                } else if (job.status === 'FAILED') {
                                    clearInterval(poll);
                                    modal.error('‚ùå ' + (job.error_message || 'Errore durante la trasformazione'));
                                } else if (job.status === 'CANCELLED') {
                                    clearInterval(poll);
                                    modal.error('üö´ Job cancellato');
                                }
                            } catch (_e) {
                                // Network error during polling ‚Äî keep trying
                            }
                        }, 2000);

                        modal.onCancel = async () => {
                            clearInterval(poll);
                            try {
                                await fetch(`${API_URL}/jobs/${job_id}`, {
                                    method: 'DELETE',
                                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                                });
                            } catch (_e) {}
                        };

                    } catch (err) {
                        modal.error('‚ùå ' + err.message);
                    }
                };
                input.click();
            };

            // Job Status Modal helpers
            function _showJobModal(initialMsg) {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center';
                const box = document.createElement('div');
                box.style.cssText = 'background:white;border-radius:16px;padding:32px;min-width:360px;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center';
                const title = document.createElement('div');
                title.style.cssText = 'font-size:16px;font-weight:600;margin-bottom:16px;color:#1a1a2e';
                title.textContent = '‚öôÔ∏è Trasformazione Asincrona';
                const msg = document.createElement('div');
                msg.style.cssText = 'font-size:14px;color:#555;margin-bottom:16px';
                msg.textContent = initialMsg;
                const bar = document.createElement('div');
                bar.style.cssText = 'background:#f0f0f0;border-radius:8px;height:8px;margin-bottom:20px;overflow:hidden';
                const fill = document.createElement('div');
                fill.style.cssText = 'background:linear-gradient(90deg,#6366f1,#8b5cf6);height:100%;width:0%;border-radius:8px;transition:width 0.3s';
                bar.appendChild(fill);
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '‚úï Annulla';
                cancelBtn.style.cssText = 'border:1px solid #ddd;background:white;padding:8px 20px;border-radius:8px;cursor:pointer;font-size:13px';
                cancelBtn.onclick = () => { if (state.onCancel) state.onCancel(); overlay.remove(); };
                box.appendChild(title);
                box.appendChild(msg);
                box.appendChild(bar);
                box.appendChild(cancelBtn);
                overlay.appendChild(box);
                document.body.appendChild(overlay);
                const state = {
                    onCancel: null,
                    update: (text, pct) => {
                        msg.textContent = text;
                        if (pct != null) fill.style.width = pct + '%';
                    },
                    success: (text) => {
                        msg.textContent = text;
                        msg.style.color = '#2e7d32';
                        fill.style.width = '100%';
                        fill.style.background = '#4caf50';
                        cancelBtn.textContent = '‚úì Chiudi';
                        setTimeout(() => overlay.remove(), 3000);
                    },
                    error: (text) => {
                        msg.textContent = text;
                        msg.style.color = '#c62828';
                        fill.style.width = '100%';
                        fill.style.background = '#f44336';
                        cancelBtn.textContent = '‚úï Chiudi';
                    }
                };
                return state;
            }

            function _downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            // Code Generation
            const generateCode = async () => {
                if (!inputSchema || !outputSchema || connections.length === 0) {
                    showStatus('‚ö†Ô∏è Load schemas and create mappings first', 'error');
                    return;
                }
                const name = mappingName || 'Buddyliko_Transformer';
                showStatus('‚ö° Generating code...', 'info');
                try {
                    const token = localStorage.getItem('buddyliko_token');
                    const mappingRules = {
                        projectName: name,
                        inputSchema,
                        outputSchema,
                        connections,
                        inputSchemaId,
                        outputSchemaId,
                    };
                    const resp = await fetch(`${API_URL}/codegen/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                        },
                        body: JSON.stringify({ project_name: name, mapping_rules: mappingRules, save_engine: true })
                    });
                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        throw new Error(err.detail || i18n.t('common.failed'));
                    }
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${name.replace(/[^a-zA-Z0-9_-]/g,'_')}_transformer.zip`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showStatus(`‚ö° Code generated! ZIP downloaded with Python + C# transformer.`, 'success');
                } catch(e) {
                    console.error('Code gen error:', e);
                    showStatus(`‚ùå Code generation failed: ${e.message}`, 'error');
                }
            };

            // Reverse Mapping Function
            const reverseMapping = async () => {
                if (!inputSchema || !outputSchema || connections.length === 0) {
                    showStatus('‚ö†Ô∏è Load schemas and create mappings first', 'error');
                    return;
                }
                
                const confirm = window.confirm(
                    'üîÑ REVERSE MAPPING\n\n' +
                    '\n' +
                    '‚Ä¢ Swap Input ‚Üî Output schemas\n' +
                    '‚Ä¢ Reverse all connections\n' +
                    '‚Ä¢ Invert transformations where possible\n\n' +
                    'Non-invertible transformations (TRIM, CASE, SUBSTR) will be converted to direct mappings.\n\n' +
                    'Continue?'
                );
                
                if (!confirm) return;
                
                try {
                    showStatus('üîÑ Reversing mapping...', 'info');
                    
                    // Prepare project data
                    const project = {
                        projectName: mappingName || 'Untitled',
                        version: '1.0',
                        created: new Date().toISOString(),
                        inputSchema: inputSchema,
                        outputSchema: outputSchema,
                        inputExample: inputExample,
                        outputExample: outputExample,
                        connections: connections
                    };
                    
                    // Call backend
                    const response = await fetch(`${API_URL}/mapping/reverse`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ project })
                    });
                    
                    if (!response.ok) {
                        throw new Error(i18n.t('common.failed'));
                    }
                    
                    const data = await response.json();
                    const reversed = data.reversed_project;
                    const report = data.report;
                    
                    // Apply reversed mapping
                    setInputSchema(reversed.inputSchema);
                    setOutputSchema(reversed.outputSchema);
                    // SWAP schema IDs when reversing!
                    setInputSchemaId(outputSchemaId);  // Input becomes Output's ID
                    setOutputSchemaId(inputSchemaId);  // Output becomes Input's ID
                    setInputExample(reversed.inputExample || '');
                    setOutputExample(reversed.outputExample || '');
                    setConnections(reversed.connections || []);
                    setMappingName(reversed.projectName);
                    
                    // Update UI
                    setTimeout(() => {
                        updateFieldPositions();
                    }, 500);
                    
                    // Show report
                    if (report.total_warnings > 0) {
                        let warningMsg = `‚ö†Ô∏è Reversed with ${report.total_warnings} warning(s):\n\n`;
                        report.warnings.slice(0, 5).forEach(w => {
                            warningMsg += `‚Ä¢ ${w.source} ‚Üí ${w.target}\n  ${w.reason}\n\n`;
                        });
                        if (report.warnings.length > 5) {
                            warningMsg += `... and ${report.warnings.length - 5} more`;
                        }
                        alert(warningMsg);
                    }
                    
                    showStatus(`üîÑ Mapping reversed! ${reversed.connections.length} connections inverted`, 'success');
                    
                } catch (err) {
                    console.error('Reverse error:', err);
                    showStatus('‚ùå Failed to reverse mapping: ' + err.message, 'error');
                }
            };
            
            const updateConnectionTransformation = (connId, transformation) => {
                setConnections(connections.map(c => 
                    c.id === connId ? { ...c, transformation } : c
                ));
                showStatus('‚úÖ Transformation updated', 'success');
            };
            
            const saveMapping = async () => {
                if (!mappingName || connections.length === 0) {
                    showStatus('‚ö†Ô∏è Enter name and add connections', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/mappings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: mappingName,
                            input_schema: inputSchema?.name || 'input',
                            output_schema: outputSchema?.name || 'output',
                            rules: connections.map(c => ({
                                id: c.id,
                                source: c.source,
                                target: c.target,
                                transformation: c.transformation,
                                enabled: true
                            }))
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showStatus('‚úÖ Mapping saved!', 'success');
                    }
                } catch (error) {
                    showStatus('‚ùå Save error', 'error');
                }
            };
            

            // Export current fields as CSV (always from live state, not backend)
            const exportFieldsCSV = (direction) => {
                const schema = direction === 'input' ? inputSchema : outputSchema;
                if (!schema || !schema.fields) {
                    showStatus('‚ö†Ô∏è Nessuno schema caricato', 'error');
                    return;
                }
                const fields = Object.values(schema.fields);
                if (fields.length === 0) {
                    showStatus('‚ö†Ô∏è Nessun campo da esportare', 'error');
                    return;
                }

                // Detect columns dynamically from all fields
                const allKeys = new Set(['campo', 'business_term', 'spiegazione', 'obbligatorio', 'numerosit√†', 'condizionalit√†']);
                fields.forEach(f => {
                    if (f.type)          allKeys.add('type');
                    if (f.xml_path)      allKeys.add('xml_path');
                    if (f.json_path)     allKeys.add('json_path');
                    if (f.offset)        allKeys.add('offset');
                    if (f.length)        allKeys.add('length');
                    if (f.calculation)   allKeys.add('calculation');
                    if (f.condition)     allKeys.add('condizionalit√†');
                });
                const headers = Array.from(allKeys);

                const rows = fields.map(f => headers.map(h => {
                    switch(h) {
                        case 'campo':          return f.path || f.name || '';
                        case 'business_term':  return f.business_term || '';
                        case 'spiegazione':    return f.description || '';
                        case 'obbligatorio':   return f.required ? 'SI' : 'NO';
                        case 'numerosit√†':     return f.cardinality || '0..1';
                        case 'condizionalit√†': return f.condition || '';
                        case 'type':           return f.type || '';
                        case 'xml_path':       return f.xml_path || '';
                        case 'json_path':      return f.json_path || '';
                        case 'offset':         return f.offset || '';
                        case 'length':         return f.length || '';
                        case 'calculation':    return f.calculation || '';
                        default:               return f[h] || '';
                    }
                }));

                const escape = v => '"' + String(v).replace(/"/g, '""') + '"';
                const csv = [headers.map(escape), ...rows.map(r => r.map(escape))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = (schema.name || direction + '_schema') + '_fields.csv';
                a.click();
                URL.revokeObjectURL(url);
                showStatus('‚úÖ Export completato: ' + fields.length + ' campi', 'success');
            };

            const exportDiagram = async () => {
                if (!connections || connections.length === 0) {
                    showStatus('‚ö†Ô∏è Nessuna connessione da esportare', 'error');
                    return;
                }
                try {
                    showStatus('üé® Generazione diagramma...', 'info');
                    const res = await fetch(`${API_URL}/mapping/diagram`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                        body: JSON.stringify({
                            connections: connections,
                            projectName: mappingName || 'Mappatura',
                            inputSchemaName: inputSchemaId || 'Input',
                            outputSchemaName: outputSchemaId || 'Output'
                        })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'mapping_diagram.svg';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showStatus('‚úÖ Diagramma esportato!', 'success');
                } catch(e) {
                    showStatus('‚ùå Errore: ' + e.message, 'error');
                }
            };

            const downloadSampleCSV = async (type) => {
                try {
                    const response = await fetch(`${API_URL}/csv/sample/${type}`);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `sample_${type}.csv`;
                    a.click();
                    showStatus(`‚úÖ Downloaded sample ${type} CSV`, 'success');
                } catch (error) {
                    showStatus('‚ùå Download error', 'error');
                }
            };
            
            // AI Auto-Map Function
            const runAIAutoMap = async () => {
                if (!inputSchema || !outputSchema) {
                    showStatus('‚ö†Ô∏è Load input and output schemas first', 'error');
                    return;
                }
                
                setAiProcessing(true);
                setShowAiPanel(true);
                showStatus('ü§ñ AI analyzing schemas...', 'success');
                
                try {
                    // Prepare schema data ‚Äî include all fields that help matching
                    const inputFields = Object.values(inputSchema.fields || {}).map(f => ({
                        name: f.name,
                        path: f.path || f.id,
                        id: f.id,
                        type: f.type,
                        business_term: f.business_term,
                        description: f.description,
                        cardinality: f.cardinality,
                        offset: f.offset,
                        xml_path: f.xml_path
                    }));
                    
                    const outputFields = Object.values(outputSchema.fields || {}).map(f => ({
                        name: f.name,
                        path: f.path || f.id,
                        id: f.id,
                        type: f.type,
                        business_term: f.business_term,
                        description: f.description,
                        cardinality: f.cardinality,
                        calculation: f.calculation,
                        offset: f.offset,
                        xml_path: f.xml_path
                    }));
                    
                    const inputSample = inputExample ? inputExample.split('\n').slice(0, 15).join('\n') : '';
                    
                    // Estimate chunks info for status message
                    const nInp = inputFields.length;
                    const nOut = outputFields.length;
                    showStatus(`ü§ñ AI analyzing ${nInp} input √ó ${nOut} output fields in chunks...`, 'success');
                    
                    // Use streaming endpoint ‚Äî accumulate log in background, don't auto-open panel
                    setAiWorkLog([]);
                    // setShowAiWork(true); ‚Äî user must click "AI at Work" button to open

                    const response = await fetch(`${API_URL}/ai/auto-map-stream`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                        body: JSON.stringify({
                            input_fields: inputFields,
                            output_fields: outputFields,
                            input_sample: inputSample,
                            output_sample: ''
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || i18n.t('common.error'));
                    }

                    // Parse SSE stream
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let suggestions = [];

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // keep incomplete line
                        for (const line of lines) {
                            if (!line.startsWith('data: ')) continue;
                            try {
                                const evt = JSON.parse(line.slice(6));
                                setAiWorkLog(prev => [...prev, evt]);
                                if (evt.type === 'done') {
                                    suggestions = evt.suggestions || [];
                                } else if (evt.type === 'error') {
                                    throw new Error(evt.msg);
                                }
                            } catch(e) { /* skip malformed */ }
                        }
                    }

                    const green = suggestions.filter(s => s.confidence >= 0.75).length;
                    const yellow = suggestions.filter(s => s.confidence >= 0.5 && s.confidence < 0.75).length;
                    setAiSuggestions(suggestions);
                    showStatus(`‚úÖ AI: ${suggestions.length} suggestions (${green} üü¢ confident, ${yellow} üü° uncertain)`, 'success');
                    
                } catch (error) {
                    console.error('AI Error:', error);
                    showStatus('‚ùå AI error: ' + error.message, 'error');
                } finally {
                    setAiProcessing(false);
                }
            };
            
            
            // AI Assist for single field
            const runAIAssist = async (outputField) => {
                setSelectedOutputField(outputField);
                setAiProcessing(true);
                setShowAiPanel(true);
                
                // This would call AI for just this one field
                // For now, trigger auto-map and filter
                await runAIAutoMap();
            };
            
            // Business Rules Automap - Match by identical business_term
            const runBusinessRulesAutomap = () => {
                if (!inputSchema || !outputSchema) {
                    showStatus('‚ö†Ô∏è Load input and output schemas first', 'error');
                    return;
                }
                
                const suggestions = [];
                const inputFields = Object.values(inputSchema.fields || {});
                const outputFields = Object.values(outputSchema.fields || {});
                
                // Find matches based on business_term
                outputFields.forEach(outField => {
                    const outBusinessTerm = (outField.business_term || '').trim().toLowerCase();
                    
                    // Skip if no business term
                    if (!outBusinessTerm) return;
                    
                    // Find input fields with matching business term
                    inputFields.forEach(inField => {
                        const inBusinessTerm = (inField.business_term || '').trim().toLowerCase();
                        
                        if (inBusinessTerm && inBusinessTerm === outBusinessTerm) {
                            // Check if connection already exists
                            const exists = connections.find(c => 
                                c.source === inField.path && c.target === outField.path
                            );
                            
                            if (!exists) {
                                suggestions.push({
                                    source_field: inField.path,
                                    target_field: outField.path,
                                    confidence: 100, // Perfect match!
                                    reasoning: `Exact match on business term: "${outField.business_term}"`,
                                    suggested_formula: null
                                });
                            }
                        }
                    });
                });
                
                if (suggestions.length > 0) {
                    setAiSuggestions(suggestions);
                    setShowAiPanel(true);
                    showStatus(`üìã Found ${suggestions.length} business rule match(es)!`, 'success');
                } else {
                    showStatus('‚ÑπÔ∏è No matching business terms found', 'info');
                }
            };
            
            // Approve AI suggestion
            const approveAISuggestion = (suggestion) => {
                console.log('üîµ APPROVE CALLED:', suggestion.source_field, '‚Üí', suggestion.target_field);
                console.log('  inputSchema:', !!inputSchema, 'fields count:', Object.keys(inputSchema?.fields || {}).length);
                console.log('  outputSchema:', !!outputSchema, 'fields count:', Object.keys(outputSchema?.fields || {}).length);
                
                if (!inputSchema?.fields || !outputSchema?.fields) {
                    console.error('‚ùå Schema not loaded!');
                    showStatus('‚ùå Schema not loaded, cannot apply suggestion', 'error');
                    return;
                }

                // Multi-criteria lookup: match by path, id, name, or partial match
                const findField = (fields, val) => {
                    if (!val) return null;
                    const entries = Object.values(fields);
                    // 1. Exact match on path, id, name
                    let found = entries.find(f =>
                        f.path === val || f.id === val || f.name === val
                    );
                    if (found) return found;
                    // 2. Case-insensitive
                    const valLow = val.toLowerCase();
                    found = entries.find(f =>
                        (f.path || '').toLowerCase() === valLow ||
                        (f.id || '').toLowerCase() === valLow ||
                        (f.name || '').toLowerCase() === valLow
                    );
                    if (found) return found;
                    // 3. Suffix match (Claude may return last segment)
                    found = entries.find(f =>
                        (f.path || '').endsWith(val) || val.endsWith(f.path || '') ||
                        (f.name || '').endsWith(val) || val.endsWith(f.name || '')
                    );
                    if (found) return found;
                    // 4. Contains
                    found = entries.find(f =>
                        valLow.includes((f.name || '').toLowerCase()) ||
                        (f.name || '').toLowerCase().includes(valLow)
                    );
                    return found || null;
                };

                const sourceField = findField(inputSchema.fields, suggestion.source_field);
                const targetField = findField(outputSchema.fields, suggestion.target_field);
                console.log('  sourceField found:', !!sourceField, sourceField?.path);
                console.log('  targetField found:', !!targetField, targetField?.path);
                
                if (sourceField && targetField) {
                    // Find the actual key used in schema.fields for each field
                    const findKey = (fields, field) => {
                        return Object.keys(fields).find(k =>
                            fields[k] === field ||
                            fields[k].id === field.id ||
                            fields[k].path === field.path
                        ) || field.id || field.path;
                    };
                    const sourceKey = findKey(inputSchema.fields, sourceField);
                    const targetKey = findKey(outputSchema.fields, targetField);

                    // sourcePath: for XML/JSON use xml_path; for IDoc flat use the segment.field path (NOT the numeric offset)
                    const srcPath = sourceField.xml_path || sourceField.path;
                    const tgtPath = targetField.xml_path || targetField.path;

                    const conn = {
                        id: `conn_${Date.now()}`,
                        source: sourceKey,
                        target: targetKey,
                        sourcePath: srcPath,
                        targetPath: tgtPath,
                        sourceName: sourceField.name,
                        targetName: targetField.name,
                        businessTerm: targetField.business_term || '',
                        transformation: suggestion.suggested_formula 
                            ? { type: 'FORMULA', formula: suggestion.suggested_formula, description: suggestion.reasoning }
                            : { type: 'DIRECT', formula: null, description: suggestion.reasoning }
                    };
                    
                    console.log('  ‚úÖ Connection created:', conn.id);
                    setConnections(prev => [...prev, conn]);
                    
                    // CRITICAL: Use functional update to get current state
                    setAiSuggestions(prevSuggestions => {
                        const newSuggestions = prevSuggestions.filter(s => 
                            !(s.source_field === suggestion.source_field && 
                              s.target_field === suggestion.target_field)
                        );
                        console.log('  üìâ Suggestions:', prevSuggestions.length, '‚Üí', newSuggestions.length);
                        return newSuggestions;
                    });
                    
                    showStatus(`‚úÖ Applied: ${sourceField.name} ‚Üí ${targetField.name}`, 'success');
                    setTimeout(updateFieldPositions, 50);
                } else {
                    console.error('  ‚ùå Field not found!', {
                        sourceField: suggestion.source_field,
                        targetField: suggestion.target_field,
                        foundSource: !!sourceField,
                        foundTarget: !!targetField
                    });
                }
            };
            
            // Reject AI suggestion
            const rejectAISuggestion = (suggestion) => {
                // Filter by content not reference
                setAiSuggestions(aiSuggestions.filter(s => 
                    !(s.source_field === suggestion.source_field && s.target_field === suggestion.target_field)
                ));
            };
            
            return React.createElement('div', { className: 'app-container' },
                // Sidebar toggle button
                React.createElement('button', {
                    className: 'sidebar-toggle',
                    onClick: () => setShowSidebar(!showSidebar),
                    title: showSidebar ? 'Hide sidebar' : 'Show sidebar'
                }, showSidebar ? '‚àí' : '+'),
                
                // Sidebar wrapper with collapse
                React.createElement('div', { 
                    className: `sidebar-wrapper ${showSidebar ? '' : 'collapsed'}`,
                    style: {
                        width: showSidebar ? '350px' : '0',
                        overflow: 'hidden',
                        transition: 'width 0.3s ease'
                    }
                },
                    React.createElement(Sidebar, {
                    inputSchema,
                    outputSchema,
                    connections,
                    activeTab,
                    setActiveTab,
                    setShowUploadModal,
                    setUploadDirection,
                    downloadSampleCSV,
                    exportFieldsCSV,
                    statusMessage,
                    setDraggedField,
                    selectedConnection,
                    setSelectedConnection,
                    uploadExampleFile,
                    inputExample,
                    outputExample,
                    loadAvailableSchemas,
                    showStatus,
                    availableInputSchemas,
                    availableOutputSchemas,
                    inputSchemaId,
                    setInputSchemaId,
                    outputSchemaId,
                    setOutputSchemaId,
                    exportDiagram,
                    setShowAccountModal
                })
                ),  // Close sidebar-wrapper
                
                React.createElement(MainCanvas, {
                    inputSchema,
                    outputSchema,
                    connections,
                    draggedField,
                    setDraggedField,
                    addConnection,
                    mappingName,
                    setMappingName,
                    saveMapping,
                    canvasRef,
                    fieldPositions,
                    updateFieldPositions,
                    selectedConnection,
                    setSelectedConnection,
                    saveSessionToBackend,
                    clearSession,
                    sessionLoaded,
                    inputExample,
                    outputExample,
                    hoverPopup,
                    setHoverPopup,
                    hoverTimeoutRef,
                    setShowFormulaEditor,
                    setEditingConnection,
                    runAIAutoMap,
                    runBusinessRulesAutomap,
                    aiProcessing,
                    setShowSettings,
                    searchQuery,
                    setSearchQuery,
                    performSearch,
                    nextSearchResult,
                    searchResults,
                    currentSearchIndex,
                    saveProject,
                    loadProject,
                    generateCode,
                    reverseMapping,
                    setPopupPinned,
                    popupPinned,
                    setShowSchemaEditor,
                    hideConnected,
                    setHideConnected,
                    onOpenNodeImport: (dir) => { setNodeImportDirection(dir); setShowNodeImportModal(true); },
                    onFieldContextMenu: handleFieldContextMenu,
                    onEditNode: (f, t) => setEditingNode({ field: f, colType: t }),
                    onDeleteNode: deleteNode,
                    exportDiagram,
                    aiWorkLog,
                    setShowAiWork,
                    dbConnections,
                    setShowDbConnPanel,
                    billingStatus,
                    setShowBillingModal,
                    importEdiAsSchema,
                    usageAlerts
                }),
                
                selectedConnection && React.createElement(PropertiesPanel, {
                    connection: selectedConnection,
                    availableFormulas: availableFormulas,
                    updateConnectionTransformation,
                    deleteConnection,
                    setSelectedConnection,
                    setShowFormulaEditor,
                    setEditingConnection
                }),
                
                showUploadModal && React.createElement(UploadModal, {
                    direction: uploadDirection,
                    onClose: () => setShowUploadModal(false),
                    onUpload: uploadSchema
                }),

                // Node import modal
                showNodeImportModal && React.createElement(NodeImportModal, {
                    direction: nodeImportDirection,
                    schemaType: nodeImportDirection === 'input'
                        ? (inputSchema?.type || (inputSchema?.name?.includes('xml') ? 'xml' : 'csv'))
                        : (outputSchema?.type || (outputSchema?.name?.includes('xml') ? 'xml' : 'csv')),
                    onClose: () => setShowNodeImportModal(false),
                    onImport: handleNodeBundleImport
                }),

                // Draggable node bundles
                nodeBundles.map(bundle =>
                    React.createElement(NodeBundle, {
                        key: bundle.id,
                        bundle,
                        onDrop: handleBundleDrop,
                        onDismiss: dismissBundle
                    })
                ),

                // Field context menu
                contextMenu && React.createElement(FieldContextMenu, {
                    x: contextMenu.x,
                    y: contextMenu.y,
                    field: contextMenu.field,
                    colType: contextMenu.colType,
                    onEdit: (field, colType) => setEditingNode({ field, colType }),
                    onDelete: deleteNode,
                    onClose: () => setContextMenu(null)
                }),

                // Node edit modal
                editingNode && React.createElement(NodeEditModal, {
                    field: editingNode.field,
                    colType: editingNode.colType,
                    onSave: saveNodeEdit,
                    onClose: () => setEditingNode(null)
                }),
                
                hoverPopup && React.createElement(HoverPopup, { 
                    popup: hoverPopup,
                    setPopupPinned,
                    setHoverPopup
                }),
                
                showFormulaEditor && editingConnection && React.createElement(FormulaEditor, {
                    connection: editingConnection,
                    onSave: (result) => {
                        // result is { type: 'CUSTOM', expression: '...' }
                        updateConnectionTransformation(editingConnection.id, result);
                        setShowFormulaEditor(false);
                        setEditingConnection(null);
                    },
                    onClose: () => {
                        setShowFormulaEditor(false);
                        setEditingConnection(null);
                    }
                }),
                
                showSettings && React.createElement(SettingsModal, {
                    onClose: () => setShowSettings(false)
                }),
                
                showSchemaEditor && React.createElement(SchemaEditorModal, {
                    show: showSchemaEditor,
                    onClose: () => setShowSchemaEditor(false),
                    onSchemaSelect: (schema, direction, definition) => {
                        if (direction === 'input') {
                            setInputSchema(schema);
                            setInputSchemaDefinition(definition);
                            showStatus('‚úÖ Schema set as Input!', 'success');
                        } else {
                            setOutputSchema(schema);
                            setOutputSchemaDefinition(definition);
                            showStatus('‚úÖ Schema set as Output!', 'success');
                        }
                        setTimeout(updateFieldPositions, 300);
                    }
                }),
                
                showAiPanel && React.createElement(AISuggestionsPanel, {
                    suggestions: aiSuggestions,
                    onApprove: approveAISuggestion,
                    onReject: rejectAISuggestion,
                    onClose: () => setShowAiPanel(false),
                    processing: aiProcessing
                }),

                showAiWork && React.createElement(AIWorkPanel, {
                    log: aiWorkLog,
                    onClose: () => setShowAiWork(false),
                    processing: aiProcessing
                }),

                // ‚îÄ‚îÄ BILLING MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                showBillingModal && billingStatus && React.createElement('div', {
                    style: { position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.55)',zIndex:9999,display:'flex',alignItems:'center',justifyContent:'center' },
                    onClick: e => { if(e.target===e.currentTarget) setShowBillingModal(false); }
                },
                    React.createElement('div', { style: { background:'#fff',borderRadius:'12px',padding:'32px',maxWidth:'520px',width:'90%',boxShadow:'0 20px 60px rgba(0,0,0,.3)',position:'relative' } },
                        React.createElement('button', { onClick:()=>setShowBillingModal(false), style:{position:'absolute',top:'12px',right:'16px',background:'none',border:'none',fontSize:'22px',cursor:'pointer',color:'#666'} }, '√ó'),
                        React.createElement('h2', { style:{margin:'0 0 4px',fontSize:'20px'} }, i18n.t('app.plan_usage')),
                        React.createElement('p', { style:{color:'#666',margin:'0 0 20px',fontSize:'14px'} }, `Piano attuale: `+React.createElement('strong',null, billingStatus.plan || 'FREE')),

                        // Usage bar
                        (() => {
                            const limits = billingStatus.limits || {};
                            const usage = billingStatus.usage || {};
                            const maxT = limits.transforms_per_month;
                            const usedT = usage.transforms_count || 0;
                            const pct = maxT > 0 ? Math.min(100, Math.round((usedT/maxT)*100)) : 0;
                            const barColor = pct >= 100 ? '#e53935' : pct >= 95 ? '#ff6f00' : pct >= 80 ? '#f9a825' : '#4caf50';
                            return React.createElement('div', { style:{marginBottom:'20px'} },
                                React.createElement('div', { style:{display:'flex',justifyContent:'space-between',fontSize:'13px',marginBottom:'6px'} },
                                    React.createElement('span', null, i18n.t('app.transforms_month')),
                                    React.createElement('span', { style:{fontWeight:'600'} }, maxT > 0 ? `${usedT} / ${maxT}` : `${usedT} (illimitate)`)
                                ),
                                maxT > 0 && React.createElement('div', { style:{height:'10px',background:'#eee',borderRadius:'5px',overflow:'hidden'} },
                                    React.createElement('div', { style:{height:'100%',width:`${pct}%`,background:barColor,borderRadius:'5px',transition:'width .3s'} })
                                ),
                                usageAlerts.length > 0 && usageAlerts.map((a,i) =>
                                    React.createElement('div', { key:i, style:{
                                        marginTop:'8px',padding:'8px 12px',borderRadius:'6px',fontSize:'13px',
                                        background: a.level==='exceeded'?'#ffebee': a.level==='critical'?'#fff3e0':'#fffde7',
                                        color: a.level==='exceeded'?'#c62828': a.level==='critical'?'#e65100':'#f57f17',
                                        border: `1px solid ${a.level==='exceeded'?'#ef9a9a': a.level==='critical'?'#ffcc02':'#fff176'}`
                                    } },
                                        a.level==='exceeded' ? 'üö´' : a.level==='critical' ? '‚ö†Ô∏è' : 'üí°',
                                        ` ${a.feature}: ${a.pct}% del limite (${a.used}/${a.limit})`
                                    )
                                ),
                                // Other usage stats
                                React.createElement('div', { style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'8px',marginTop:'12px'} },
                                    React.createElement('div', { style:{background:'#f5f5f5',borderRadius:'8px',padding:'10px',textAlign:'center'} },
                                        React.createElement('div', { style:{fontSize:'18px',fontWeight:'700'} }, usage.codegen_count || 0),
                                        React.createElement('div', { style:{fontSize:'11px',color:'#666'} }, i18n.t('account.code_gen')))
                                    ),
                                    React.createElement('div', { style:{background:'#f5f5f5',borderRadius:'8px',padding:'10px',textAlign:'center'} },
                                        React.createElement('div', { style:{fontSize:'18px',fontWeight:'700'} },
                                            usage.bytes_processed > 1048576 ? `${(usage.bytes_processed/1048576).toFixed(1)} MB` :
                                            usage.bytes_processed > 1024 ? `${(usage.bytes_processed/1024).toFixed(0)} KB` :
                                            `${usage.bytes_processed||0} B`
                                        ),
                                        React.createElement('div', { style:{fontSize:'11px',color:'#666'} }, i18n.t('account.bytes_processed')))
                                    )
                                )
                            );
                        })(),

                        // Piano limits
                        React.createElement('div', { style:{background:'#f8f9fa',borderRadius:'8px',padding:'14px',marginBottom:'20px'} },
                            React.createElement('div', { style:{fontWeight:'600',marginBottom:'10px',fontSize:'13px'} }, i18n.t('app.plan_limits')),
                            ...(Object.entries({
                                'üîÑ Trasformazioni/mese': billingStatus.limits?.transforms_per_month === -1 ? '‚àû' : billingStatus.limits?.transforms_per_month || 100,
                                'üìÅ Max file size': `${billingStatus.limits?.max_file_size_mb || 1} MB`,
                                '‚ö° Code generation': billingStatus.limits?.code_generation ? '‚úÖ' : '‚ùå',
                                'üîå API access': billingStatus.limits?.api_access ? '‚úÖ' : '‚ùå',
                                'üóÑÔ∏è DB Connector': billingStatus.limits?.db_connector ? '‚úÖ' : '‚ùå',
                                'üë• Utenti max': billingStatus.limits?.max_users === -1 ? '‚àû' : billingStatus.limits?.max_users || 1,
                            }).map(([k,v]) =>
                                React.createElement('div', { key:k, style:{display:'flex',justifyContent:'space-between',fontSize:'13px',padding:'3px 0'} },
                                    React.createElement('span', { style:{color:'#555'} }, k),
                                    React.createElement('span', { style:{fontWeight:'600'} }, String(v))
                                )
                            ))
                        ),

                        // Upgrade buttons (only for FREE/PRO)
                        billingStatus.plan === 'FREE' && React.createElement('div', { style:{display:'flex',gap:'10px'} },
                            React.createElement('button', {
                                style:{flex:1,padding:'10px',background:'#1976d2',color:'#fff',border:'none',borderRadius:'8px',cursor:'pointer',fontWeight:'600',fontSize:'14px'},
                                onClick: async () => {
                                    const token = localStorage.getItem('buddyliko_token');
                                    try {
                                        const r = await fetch(`${API_URL}/billing/checkout`, {
                                            method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
                                            body: JSON.stringify({plan:'PRO',billing_period:'monthly'})
                                        });
                                        const d = await r.json();
                                        if(d.checkout_url) window.open(d.checkout_url,'_blank');
                                        else alert(d.detail || i18n.t('common.error'));
                                    } catch(e) { alert(i18n.t('account.billing_unavailable')); }
                                }
                            }, i18n.t('app.upgrade_pro')),
                            React.createElement('button', {
                                style:{flex:1,padding:'10px',background:'#6a1b9a',color:'#fff',border:'none',borderRadius:'8px',cursor:'pointer',fontWeight:'600',fontSize:'14px'},
                                onClick: async () => {
                                    const token = localStorage.getItem('buddyliko_token');
                                    try {
                                        const r = await fetch(`${API_URL}/billing/checkout`, {
                                            method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
                                            body: JSON.stringify({plan:'ENTERPRISE',billing_period:'monthly'})
                                        });
                                        const d = await r.json();
                                        if(d.checkout_url) window.open(d.checkout_url,'_blank');
                                        else alert(d.detail || i18n.t('common.error'));
                                    } catch(e) { alert(i18n.t('account.billing_unavailable')); }
                                }
                            }, i18n.t('app.enterprise_plan'))
                        ),
                        billingStatus.plan !== 'FREE' && React.createElement('button', {
                            style:{width:'100%',padding:'10px',background:'#f5f5f5',border:'1px solid #ddd',borderRadius:'8px',cursor:'pointer',fontSize:'14px'},
                            onClick: async () => {
                                const token = localStorage.getItem('buddyliko_token');
                                try {
                                    const r = await fetch(`${API_URL}/billing/portal`,{method:'POST',headers:{'Authorization':`Bearer ${token}`}});
                                    const d = await r.json();
                                    if(d.portal_url) window.open(d.portal_url,'_blank');
                                } catch(e) { alert(i18n.t('account.billing_unavailable')); }
                            }
                        }, i18n.t('app.manage_sub'))
                    )
                ),

                /* ‚îÄ‚îÄ ACCOUNT / SECURITY MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
                showAccountModal && React.createElement('div', {
                    style:{position:'fixed',inset:0,background:'rgba(0,0,0,0.75)',
                           display:'flex',alignItems:'center',justifyContent:'center',
                           zIndex:10000,padding:'20px'},
                    onClick: e => { if(e.target===e.currentTarget) setShowAccountModal(false); }
                },
                    React.createElement('div', {
                        style:{background:'#1a1e35',border:'1px solid #2e3250',borderRadius:'12px',
                               padding:'28px',maxWidth:'560px',width:'100%',maxHeight:'85vh',
                               overflowY:'auto',boxShadow:'0 20px 60px rgba(0,0,0,.5)'}
                    },
                        React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}},
                            React.createElement('h2',{style:{margin:0,color:'#e2e8f0',fontSize:'18px'}},'üë§ Account & Sicurezza'),
                            React.createElement('button',{onClick:()=>setShowAccountModal(false),
                                style:{background:'none',border:'none',color:'#94a3b8',fontSize:'20px',cursor:'pointer',lineHeight:1}},'‚úï')
                        ),
                        // Tabs
                        React.createElement('div',{style:{display:'flex',gap:'4px',marginBottom:'20px',background:'#0f1225',padding:'4px',borderRadius:'8px'}},
                            [['providers','üîó Login collegati'],['password','üîí Password'],['usage','üìä Consumo']].map(([tab,label]) =>
                                React.createElement('button',{key:tab,onClick:()=>setAccountTab(tab),
                                    style:{flex:1,padding:'8px',border:'none',borderRadius:'6px',cursor:'pointer',fontSize:'13px',fontWeight:'500',
                                           background:accountTab===tab?'#2563eb':'transparent',
                                           color:accountTab===tab?'#fff':'#94a3b8',transition:'all .15s'}},label)
                            )
                        ),

                        // ‚îÄ‚îÄ TAB PROVIDERS ‚îÄ‚îÄ
                        accountTab==='providers' && React.createElement('div',null,
                            React.createElement('p',{style:{color:'#94a3b8',fontSize:'13px',marginBottom:'16px'}},
                                'Collega pi√π metodi di login allo stesso account. Potrai accedere con qualsiasi metodo collegato.'),
                            !linkedProviders && React.createElement('p',{style:{color:'#64748b',textAlign:'center',padding:'20px'}},'Caricamento...'),
                            linkedProviders && React.createElement('div',{style:{display:'flex',flexDirection:'column',gap:'10px'}},
                                [{id:'google',label:'Google',icon:null,svg:'<svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>',color:'#4285f4'},
                                 {id:'github',label:'GitHub',icon:null,svg:'<svg width="18" height="18" viewBox="0 0 24 24"><path fill="#e2e8f0" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>',color:'#e2e8f0'}
                                ].map(prov => {
                                    const linked = linkedProviders.providers?.find(p=>p.provider===prov.id);
                                    return React.createElement('div',{key:prov.id,
                                        style:{display:'flex',alignItems:'center',justifyContent:'space-between',
                                               padding:'12px 14px',background:'#0f1225',borderRadius:'8px',
                                               border:linked?`1px solid ${prov.color}44`:'1px solid #2e3250'}},
                                        React.createElement('div',{style:{display:'flex',alignItems:'center',gap:'10px'}},
                                            React.createElement('span',{style:{display:'inline-flex',alignItems:'center',justifyContent:'center',width:'28px',height:'28px'},dangerouslySetInnerHTML:{__html:prov.svg}}),
                                            React.createElement('div',null,
                                                React.createElement('div',{style:{color:'#e2e8f0',fontWeight:'500',fontSize:'14px'}},prov.label),
                                                linked
                                                    ? React.createElement('div',{style:{color:'#64748b',fontSize:'12px'}},
                                                        '‚úÖ Collegato'+(linked.provider_email?' ¬∑ '+linked.provider_email:''))
                                                    : React.createElement('div',{style:{color:'#64748b',fontSize:'12px'}},'Non collegato')
                                            )
                                        ),
                                        linked
                                            ? React.createElement('button',{
                                                onClick: async () => {
                                                    if(!confirm('Scollegare '+prov.label+'? Se √® il tuo unico metodo di login, imposta prima una password.')) return;
                                                    const token=localStorage.getItem('buddyliko_token');
                                                    const r=await fetch(`${API_URL}/auth/link/${prov.id}`,{method:'DELETE',headers:{'Authorization':`Bearer ${token}`}});
                                                    const d=await r.json();
                                                    if(r.ok){showStatus('‚úÖ '+prov.label+' scollegato','success');const pr=await fetch(`${API_URL}/auth/providers`,{headers:{'Authorization':`Bearer ${token}`}});if(pr.ok)setLinkedProviders(await pr.json());}
                                                    else showStatus('‚ùå '+(d.detail||'Errore'),'error');
                                                },
                                                style:{padding:'6px 12px',background:'#7f1d1d',border:'1px solid #ef444433',color:'#fca5a5',borderRadius:'6px',cursor:'pointer',fontSize:'12px'}
                                              },'üîì Scollega')
                                            : React.createElement('button',{
                                                onClick: async () => {
                                                    try {
                                                        const token = localStorage.getItem('buddyliko_token');
                                                        const r = await fetch(`${API_URL}/auth/${prov.id}/login?link_token=${encodeURIComponent(token)}`);
                                                        const d = await r.json();
                                                        if (d.auth_url) {
                                                            window.location.href = d.auth_url;
                                                        } else {
                                                            showStatus('‚ùå Provider non disponibile','error');
                                                        }
                                                    } catch(e) {
                                                        showStatus('‚ùå Errore: '+e.message,'error');
                                                    }
                                                },
                                                style:{padding:'6px 12px',background:'#1e3a5f',border:'1px solid #2563eb44',color:'#93c5fd',borderRadius:'6px',cursor:'pointer',fontSize:'12px'}
                                              },'üîó Collega')
                                    );
                                })
                            )
                        ),

                        // ‚îÄ‚îÄ TAB PASSWORD ‚îÄ‚îÄ
                        accountTab==='password' && React.createElement('div',null,
                            React.createElement('p',{style:{color:'#94a3b8',fontSize:'13px',marginBottom:'16px'}},
                                linkedProviders?.has_password
                                    ? 'üîí Hai una password. Puoi cambiarla qui.'
                                    : '‚ö†Ô∏è Nessuna password. Impostane una per sicurezza.'),
                            !linkedProviders?.has_password && React.createElement('div',{
                                style:{background:'#451a03',border:'1px solid #f9731633',borderRadius:'8px',padding:'12px',color:'#fdba74',fontSize:'13px',marginBottom:'12px'}
                            },'‚ö†Ô∏è Senza password, se scolleghi tutti i provider OAuth perderai l\'accesso.'),
                            React.createElement('div',{style:{display:'flex',flexDirection:'column',gap:'10px'}},
                                React.createElement('input',{type:'password',placeholder:linkedProviders?.has_password?'Password attuale':'Lascia vuoto',id:'acc_old_pwd',
                                    style:{padding:'10px',background:'#0f1225',border:'1px solid #2e3250',borderRadius:'6px',color:'#e2e8f0',fontSize:'14px'}}),
                                React.createElement('input',{type:'password',placeholder:'Nuova password (min. 8 car.)',id:'acc_new_pwd',
                                    style:{padding:'10px',background:'#0f1225',border:'1px solid #2e3250',borderRadius:'6px',color:'#e2e8f0',fontSize:'14px'}}),
                                React.createElement('input',{type:'password',placeholder:'Conferma nuova password',id:'acc_conf_pwd',
                                    style:{padding:'10px',background:'#0f1225',border:'1px solid #2e3250',borderRadius:'6px',color:'#e2e8f0',fontSize:'14px'}}),
                                React.createElement('button',{
                                    onClick: async () => {
                                        const oldP=document.getElementById('acc_old_pwd').value;
                                        const newP=document.getElementById('acc_new_pwd').value;
                                        const conP=document.getElementById('acc_conf_pwd').value;
                                        if(newP.length<8){showStatus('‚ùå Min. 8 caratteri','error');return;}
                                        if(newP!==conP){showStatus('‚ùå Le password non coincidono','error');return;}
                                        const token=localStorage.getItem('buddyliko_token');
                                        const r=await fetch(`${API_URL}/auth/change-password`,{
                                            method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
                                            body:JSON.stringify({old_password:oldP,new_password:newP})
                                        });
                                        const d=await r.json();
                                        if(r.ok){
                                            showStatus('‚úÖ Password aggiornata','success');
                                            ['acc_old_pwd','acc_new_pwd','acc_conf_pwd'].forEach(id=>document.getElementById(id).value='');
                                            const pr=await fetch(`${API_URL}/auth/providers`,{headers:{'Authorization':`Bearer ${token}`}});
                                            if(pr.ok)setLinkedProviders(await pr.json());
                                        } else showStatus('‚ùå '+(d.detail||'Errore'),'error');
                                    },
                                    style:{padding:'10px',background:'#2563eb',border:'none',borderRadius:'6px',color:'#fff',fontSize:'14px',fontWeight:'600',cursor:'pointer'}
                                },linkedProviders?.has_password?'üîí Cambia password':'üîí Imposta password')
                            )
                        ),

                        // ‚îÄ‚îÄ TAB USAGE ‚îÄ‚îÄ
                        accountTab==='usage' && React.createElement('div',null,
                            React.createElement('p',{style:{color:'#94a3b8',fontSize:'13px',marginBottom:'16px'}},'Consumo mensile corrente.'),
                            billingStatus && React.createElement('div',{style:{display:'flex',flexDirection:'column',gap:'12px'}},
                                React.createElement('div',{style:{background:'#0f1225',borderRadius:'8px',padding:'14px',border:'1px solid #2e3250'}},
                                    React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'10px'}},
                                        React.createElement('span',{style:{color:'#e2e8f0',fontWeight:'600'}},'Piano: '+( billingStatus.plan||'FREE')),
                                        billingStatus.period_end && React.createElement('span',{style:{color:'#64748b',fontSize:'12px'}},
                                            'Rinnovo: '+new Date(billingStatus.period_end).toLocaleDateString('it-IT'))
                                    ),
                                    (() => {
                                        const used=billingStatus.usage?.transforms_count||0;
                                        const max=billingStatus.limits?.transforms_per_month;
                                        const pct=max===-1?0:Math.min(100,Math.round(used/(max||100)*100));
                                        const col=pct>90?'#ef4444':pct>70?'#f59e0b':'#22c55e';
                                        return React.createElement('div',null,
                                            React.createElement('div',{style:{display:'flex',justifyContent:'space-between',marginBottom:'4px'}},
                                                React.createElement('span',{style:{color:'#94a3b8',fontSize:'12px'}},'üîÑ Trasformazioni'),
                                                React.createElement('span',{style:{color:col,fontSize:'12px',fontWeight:'600'}},
                                                    max===-1?used+' (‚àû)':used+' / '+max)),
                                            max!==-1&&React.createElement('div',{style:{height:'6px',background:'#2e3250',borderRadius:'3px',overflow:'hidden'}},
                                                React.createElement('div',{style:{height:'100%',width:pct+'%',background:col,borderRadius:'3px',transition:'width .3s'}}))
                                        );
                                    })(),
                                    React.createElement('div',{style:{marginTop:'8px',display:'flex',justifyContent:'space-between'}},
                                        React.createElement('span',{style:{color:'#94a3b8',fontSize:'12px'}},'‚ö° Code gen'),
                                        React.createElement('span',{style:{color:'#e2e8f0',fontSize:'12px'}},billingStatus.usage?.codegen_count||0)),
                                    React.createElement('div',{style:{marginTop:'4px',display:'flex',justifyContent:'space-between'}},
                                        React.createElement('span',{style:{color:'#94a3b8',fontSize:'12px'}},'üì¶ Dati processati'),
                                        React.createElement('span',{style:{color:'#e2e8f0',fontSize:'12px'}},
                                            (()=>{const b=billingStatus.usage?.bytes_processed||0;return b>1048576?(b/1048576).toFixed(1)+' MB':b>1024?(b/1024).toFixed(0)+' KB':b+' B';})()
                                        ))
                                ),
                                React.createElement('button',{
                                    onClick:()=>window.open(`${API_URL}/billing/usage/export?months=12`,'_blank'),
                                    style:{padding:'10px',background:'#0f1225',border:'1px solid #2e3250',borderRadius:'6px',color:'#94a3b8',fontSize:'13px',cursor:'pointer'}
                                },'‚¨áÔ∏è Esporta storico CSV (12 mesi)'),
                                billingStatus.plan==='FREE' && React.createElement('div',{
                                    style:{background:'#1e3a5f',border:'1px solid #2563eb44',borderRadius:'8px',padding:'12px',display:'flex',justifyContent:'space-between',alignItems:'center'}},
                                    React.createElement('span',{style:{color:'#93c5fd',fontSize:'13px'}},'üöÄ PRO: illimitato, 50MB, code gen'),
                                    React.createElement('button',{onClick:()=>{setShowAccountModal(false);setShowBillingModal(true);},
                                        style:{padding:'6px 14px',background:'#2563eb',border:'none',borderRadius:'6px',color:'#fff',fontSize:'12px',cursor:'pointer',fontWeight:'600'}},'Aggiorna'))
                            )
                        )
                    )
                ),

                // ‚îÄ‚îÄ DB CONNECTOR PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                showDbConnPanel && React.createElement('div', {
                    style:{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.55)',zIndex:9999,display:'flex',alignItems:'center',justifyContent:'center'},
                    onClick: e => { if(e.target===e.currentTarget) { setShowDbConnPanel(false); setDbPanelView('list'); } }
                },
                    React.createElement('div', { style:{background:'#fff',borderRadius:'12px',padding:'28px',maxWidth:'680px',width:'95%',boxShadow:'0 20px 60px rgba(0,0,0,.3)',position:'relative',maxHeight:'88vh',overflowY:'auto'} },
                        React.createElement('button',{onClick:()=>{setShowDbConnPanel(false);setDbPanelView('list');},style:{position:'absolute',top:'12px',right:'16px',background:'none',border:'none',fontSize:'22px',cursor:'pointer',color:'#666'}},'√ó'),
                        React.createElement('h2',{style:{margin:'0 0 4px',fontSize:'20px'}},'üóÑÔ∏è Database Connector'),

                        // Navigation breadcrumb
                        React.createElement('div',{style:{display:'flex',gap:'6px',margin:'8px 0 16px',flexWrap:'wrap'}},
                            React.createElement('button',{onClick:()=>setDbPanelView('list'),style:{padding:'4px 12px',borderRadius:'14px',border:dbPanelView==='list'?'2px solid #1565c0':'1px solid #ddd',background:dbPanelView==='list'?'#e3f2fd':'#fff',cursor:'pointer',fontSize:'12px',fontWeight:'600',color:dbPanelView==='list'?'#1565c0':'#666'}},'üìã Connessioni'),
                            React.createElement('button',{onClick:()=>setDbPanelView('create'),style:{padding:'4px 12px',borderRadius:'14px',border:dbPanelView==='create'?'2px solid #2e7d32':'1px solid #ddd',background:dbPanelView==='create'?'#e8f5e9':'#fff',cursor:'pointer',fontSize:'12px',fontWeight:'600',color:dbPanelView==='create'?'#2e7d32':'#666'}},'‚ûï Nuova'),
                            dbPanelView === 'tables' && React.createElement('span',{style:{padding:'4px 12px',borderRadius:'14px',background:'#fff3e0',fontSize:'12px',fontWeight:'600',color:'#e65100'}},'üìä Tabelle'),
                            dbPanelView === 'preview' && React.createElement('span',{style:{padding:'4px 12px',borderRadius:'14px',background:'#f3e5f5',fontSize:'12px',fontWeight:'600',color:'#6a1b9a'}},'üëÅÔ∏è Anteprima'),
                            dbPanelView === 'write' && React.createElement('span',{style:{padding:'4px 12px',borderRadius:'14px',background:'#fce4ec',fontSize:'12px',fontWeight:'600',color:'#c62828'}},'‚úçÔ∏è Scrivi su DB')
                        ),

                        dbLoading && React.createElement('div',{style:{textAlign:'center',padding:'16px',color:'#1565c0'}},'‚è≥ Caricamento...'),

                        // ‚îÄ‚îÄ LIST VIEW ‚îÄ‚îÄ
                        dbPanelView === 'list' && React.createElement('div', null,
                            dbConnections.length === 0
                                ? React.createElement('div',{style:{textAlign:'center',padding:'30px',color:'#999',background:'#f9f9f9',borderRadius:'8px'}},'Nessuna connessione. Clicca "‚ûï Nuova" per crearne una.')
                                : dbConnections.map(conn =>
                                    React.createElement('div',{key:conn.id,style:{border:'1px solid #e0e0e0',borderRadius:'8px',padding:'12px',marginBottom:'8px',background:'#fafafa'}},
                                        React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'10px'}},
                                            React.createElement('div',{style:{display:'flex',alignItems:'center',gap:'8px'}},
                                                React.createElement('span',{style:{fontWeight:'700',fontSize:'14px'}},conn.name),
                                                React.createElement('span',{style:{fontSize:'11px',padding:'2px 8px',borderRadius:'12px',background:'#e3f2fd',color:'#1565c0',fontWeight:'600'}}, conn.db_type.toUpperCase()),
                                                React.createElement('span',{style:{fontSize:'18px'}}, conn.last_test_status==='ok'?'üü¢':conn.last_test_status==='error'?'üî¥':'‚ö™')
                                            ),
                                            React.createElement('div',{style:{display:'flex',gap:'4px'}},
                                                React.createElement('button',{onClick:()=>dbTestConnection(conn.id),style:{padding:'4px 8px',background:'#fff',border:'1px solid #ddd',borderRadius:'4px',cursor:'pointer',fontSize:'11px'}},'üß™'),
                                                React.createElement('button',{onClick:()=>dbDeleteConnection(conn.id),style:{padding:'4px 8px',background:'#fff',border:'1px solid #ddd',borderRadius:'4px',cursor:'pointer',fontSize:'11px'}},'üóëÔ∏è')
                                            )
                                        ),
                                        React.createElement('div',{style:{display:'flex',gap:'6px',flexWrap:'wrap'}},
                                            React.createElement('button',{onClick:()=>{ setDbTableSide('input'); dbLoadTables(conn); },style:{flex:1,padding:'8px',background:'#e3f2fd',border:'1px solid #90caf9',borderRadius:'6px',cursor:'pointer',fontSize:'12px',fontWeight:'600',color:'#1565c0'}},'üì• Usa come Input'),
                                            React.createElement('button',{onClick:()=>{ setDbTableSide('output'); dbLoadTables(conn); },style:{flex:1,padding:'8px',background:'#f3e5f5',border:'1px solid #ce93d8',borderRadius:'6px',cursor:'pointer',fontSize:'12px',fontWeight:'600',color:'#6a1b9a'}},'üì§ Usa come Output'),
                                            React.createElement('button',{onClick:()=>{ setDbTableSide('write'); dbLoadTables(conn); },style:{flex:1,padding:'8px',background:'#fce4ec',border:'1px solid #ef9a9a',borderRadius:'6px',cursor:'pointer',fontSize:'12px',fontWeight:'600',color:'#c62828'}},'‚úçÔ∏è Scrivi su DB')
                                        )
                                    )
                                )
                        ),

                        // ‚îÄ‚îÄ CREATE VIEW ‚îÄ‚îÄ
                        dbPanelView === 'create' && React.createElement('div',null,
                            React.createElement('div',{style:{marginBottom:'12px'}},
                                React.createElement('label',{style:{fontSize:'12px',fontWeight:'600',color:'#333',display:'block',marginBottom:'3px'}},'Nome connessione'),
                                React.createElement('input',{value:dbNewConn.name,onChange:e=>setDbNewConn({...dbNewConn,name:e.target.value}),placeholder:'Es: Production DB',style:{width:'100%',padding:'8px',border:'1px solid #ddd',borderRadius:'6px',fontSize:'13px'}})
                            ),
                            React.createElement('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px',marginBottom:'12px'}},
                                React.createElement('div',null,
                                    React.createElement('label',{style:{fontSize:'12px',fontWeight:'600',color:'#333',display:'block',marginBottom:'3px'}},'Tipo database'),
                                    React.createElement('select',{value:dbNewConn.db_type,onChange:e=>setDbNewConn({...dbNewConn,db_type:e.target.value}),style:{width:'100%',padding:'8px',border:'1px solid #ddd',borderRadius:'6px',fontSize:'13px'}},
                                        React.createElement('option',{value:'postgresql'},'PostgreSQL'),
                                        React.createElement('option',{value:'mysql'},'MySQL'),
                                        React.createElement('option',{value:'sqlserver'},'SQL Server'),
                                        React.createElement('option',{value:'sqlite'},'SQLite')
                                    )
                                ),
                                React.createElement('div',null,
                                    React.createElement('label',{style:{fontSize:'12px',fontWeight:'600',color:'#333',display:'block',marginBottom:'3px'}},'Schema'),
                                    React.createElement('input',{value:dbNewConn.schema,onChange:e=>setDbNewConn({...dbNewConn,schema:e.target.value}),placeholder:'public',style:{width:'100%',padding:'8px',border:'1px solid #ddd',borderRadius:'6px',fontSize:'13px'}})
                                )
                            ),
                            React.createElement('div',{style:{display:'grid',gridTemplateColumns:'2fr 1fr',gap:'12px',marginBottom:'12px'}},
                                React.createElement('div',null,
                                    React.createElement('label',{style:{fontSize:'12px',fontWeight:'600',color:'#333',display:'block',marginBottom:'3px'}},'Host'),
                                    React.createElement('input',{value:dbNewConn.host,onChange:e=>setDbNewConn({...dbNewConn,host:e.target.value}),placeholder:'localhost',style:{width:'100%',padding:'8px',border:'1px solid #ddd',borderRadius:'6px',fontSize:'13px'}})
                                ),
                                React.createElement('div',null,
                                    React.createElement('label',{style:{fontSize:'12px',fontWeight:'600',color:'#333',display:'block',marginBottom:'3px'}},'Porta'),
                                    React.createElement('input',{value:dbNewConn.port,onChange:e=>setDbNewConn({...dbNewConn,port:e.target.value}),placeholder:'Auto',style:{width:'100%',padding:'8px',border:'1px solid #ddd',borderRadius:'6px',fontSize:'13px'}})
                                )
                            ),
                            React.createElement('div',{style:{marginBottom:'12px'}},
                                React.createElement('label',{style:{fontSize:'12px',fontWeight:'600',color:'#333',display:'block',marginBottom:'3px'}},'Database'),
                                React.createElement('input',{value:dbNewConn.database,onChange:e=>setDbNewConn({...dbNewConn,database:e.target.value}),placeholder:'nome_database',style:{width:'100%',padding:'8px',border:'1px solid #ddd',borderRadius:'6px',fontSize:'13px'}})
                            ),
                            React.createElement('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px',marginBottom:'16px'}},
                                React.createElement('div',null,
                                    React.createElement('label',{style:{fontSize:'12px',fontWeight:'600',color:'#333',display:'block',marginBottom:'3px'}},'Utente'),
                                    React.createElement('input',{value:dbNewConn.user,onChange:e=>setDbNewConn({...dbNewConn,user:e.target.value}),placeholder:'username',style:{width:'100%',padding:'8px',border:'1px solid #ddd',borderRadius:'6px',fontSize:'13px'}})
                                ),
                                React.createElement('div',null,
                                    React.createElement('label',{style:{fontSize:'12px',fontWeight:'600',color:'#333',display:'block',marginBottom:'3px'}},'Password'),
                                    React.createElement('input',{type:'password',value:dbNewConn.password,onChange:e=>setDbNewConn({...dbNewConn,password:e.target.value}),placeholder:'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',style:{width:'100%',padding:'8px',border:'1px solid #ddd',borderRadius:'6px',fontSize:'13px'}})
                                )
                            ),
                            React.createElement('button',{onClick:dbCreateConnection,disabled:dbLoading||!dbNewConn.name||!dbNewConn.database,style:{width:'100%',padding:'10px',background:(!dbNewConn.name||!dbNewConn.database)?'#ccc':'#2e7d32',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'14px',fontWeight:'600'}},'üíæ Salva connessione')
                        ),

                        // ‚îÄ‚îÄ TABLES VIEW ‚îÄ‚îÄ
                        dbPanelView === 'tables' && dbSelectedConn && React.createElement('div',null,
                            React.createElement('div',{style:{marginBottom:'12px',padding:'10px',background:'#f5f5f5',borderRadius:'6px',fontSize:'13px'}},
                                React.createElement('strong',null,dbSelectedConn.name),' ‚Äî ',dbSelectedConn.db_type.toUpperCase(),
                                ' ‚Äî ',dbTableSide === 'write' ? '‚úçÔ∏è Seleziona tabella destinazione' : dbTableSide === 'input' ? 'üì• Seleziona tabella per INPUT' : 'üì§ Seleziona tabella per OUTPUT'
                            ),
                            dbTables.length === 0
                                ? React.createElement('div',{style:{padding:'20px',textAlign:'center',color:'#999'}},'Nessuna tabella trovata')
                                : React.createElement('div',{style:{maxHeight:'400px',overflowY:'auto'}},
                                    dbTables.map(tbl => React.createElement('div',{key:tbl,style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 12px',borderBottom:'1px solid #eee'}},
                                        React.createElement('span',{style:{fontFamily:'monospace',fontSize:'13px'}}, tbl),
                                        React.createElement('div',{style:{display:'flex',gap:'4px'}},
                                            React.createElement('button',{onClick:()=>dbLoadPreview(dbSelectedConn.id, tbl),style:{padding:'4px 10px',background:'#fff',border:'1px solid #ddd',borderRadius:'4px',cursor:'pointer',fontSize:'11px'}},'üëÅÔ∏è Anteprima'),
                                            dbTableSide === 'write'
                                                ? React.createElement('button',{onClick:()=>{setDbSelectedTable(tbl);setDbPanelView('write');},style:{padding:'4px 10px',background:'#fce4ec',border:'1px solid #ef9a9a',borderRadius:'4px',cursor:'pointer',fontSize:'11px',fontWeight:'600',color:'#c62828'}},'‚úçÔ∏è Scrivi qui')
                                                : React.createElement('button',{onClick:()=>{loadDbTableAsSchema(dbSelectedConn.id, tbl, dbTableSide);setShowDbConnPanel(false);setDbPanelView('list');},style:{padding:'4px 10px',background:dbTableSide==='input'?'#e3f2fd':'#f3e5f5',border:'1px solid '+(dbTableSide==='input'?'#90caf9':'#ce93d8'),borderRadius:'4px',cursor:'pointer',fontSize:'11px',fontWeight:'600',color:dbTableSide==='input'?'#1565c0':'#6a1b9a'}},dbTableSide==='input'?'üì• Input':'üì§ Output')
                                        )
                                    ))
                                ),
                            React.createElement('button',{onClick:()=>setDbPanelView('list'),style:{marginTop:'12px',padding:'8px 16px',background:'#f5f5f5',border:'1px solid #ddd',borderRadius:'6px',cursor:'pointer',fontSize:'12px'}},'‚Üê Indietro')
                        ),

                        // ‚îÄ‚îÄ PREVIEW VIEW ‚îÄ‚îÄ
                        dbPanelView === 'preview' && dbPreviewData && React.createElement('div',null,
                            React.createElement('div',{style:{marginBottom:'12px',display:'flex',justifyContent:'space-between',alignItems:'center'}},
                                React.createElement('strong',{style:{fontSize:'14px'}}, `üëÅÔ∏è Anteprima: ${dbPreviewData.table || dbSelectedTable} (${(dbPreviewData.rows||[]).length} righe)`),
                                React.createElement('button',{onClick:()=>setDbPanelView('tables'),style:{padding:'6px 12px',background:'#f5f5f5',border:'1px solid #ddd',borderRadius:'6px',cursor:'pointer',fontSize:'12px'}},'‚Üê Tabelle')
                            ),
                            (dbPreviewData.rows||[]).length > 0
                                ? React.createElement('div',{style:{overflowX:'auto',maxHeight:'350px',border:'1px solid #e0e0e0',borderRadius:'6px'}},
                                    React.createElement('table',{style:{width:'100%',borderCollapse:'collapse',fontSize:'11px'}},
                                        React.createElement('thead',null,
                                            React.createElement('tr',null,
                                                Object.keys(dbPreviewData.rows[0]).map(col =>
                                                    React.createElement('th',{key:col,style:{padding:'6px 8px',background:'#f5f5f5',borderBottom:'2px solid #ddd',textAlign:'left',whiteSpace:'nowrap',fontWeight:'700',fontSize:'11px'}},col)
                                                )
                                            )
                                        ),
                                        React.createElement('tbody',null,
                                            dbPreviewData.rows.map((row,i) =>
                                                React.createElement('tr',{key:i,style:{borderBottom:'1px solid #eee'}},
                                                    Object.values(row).map((val,j) =>
                                                        React.createElement('td',{key:j,style:{padding:'4px 8px',whiteSpace:'nowrap',maxWidth:'200px',overflow:'hidden',textOverflow:'ellipsis'}},String(val ?? ''))
                                                    )
                                                )
                                            )
                                        )
                                    )
                                )
                                : React.createElement('div',{style:{padding:'20px',textAlign:'center',color:'#999'}},'Nessun dato')
                        ),

                        // ‚îÄ‚îÄ WRITE VIEW ‚îÄ‚îÄ
                        dbPanelView === 'write' && dbSelectedConn && React.createElement('div',null,
                            React.createElement('div',{style:{padding:'12px',background:'#fce4ec',borderRadius:'8px',marginBottom:'14px'}},
                                React.createElement('strong',null,'‚úçÔ∏è Scrivi dati trasformati su DB'),
                                React.createElement('div',{style:{fontSize:'12px',color:'#666',marginTop:'4px'}},
                                    `Connessione: ${dbSelectedConn.name} ‚Üí Tabella: ${dbSelectedTable}`
                                )
                            ),
                            !outputExample && React.createElement('div',{style:{padding:'16px',background:'#fff3e0',borderRadius:'8px',color:'#e65100',fontSize:'13px'}},'‚ö†Ô∏è Nessun dato di output disponibile. Esegui prima una trasformazione nel mapper.'),
                            outputExample && React.createElement('div', null,
                                React.createElement('div',{style:{marginBottom:'12px'}},
                                    React.createElement('label',{style:{fontSize:'12px',fontWeight:'600',display:'block',marginBottom:'3px'}},'Modalit√† scrittura'),
                                    React.createElement('select',{value:dbWriteMode,onChange:e=>setDbWriteMode(e.target.value),style:{width:'100%',padding:'8px',border:'1px solid #ddd',borderRadius:'6px',fontSize:'13px'}},
                                        React.createElement('option',{value:'insert'},'INSERT ‚Äî Inserisci (errore se duplicato)'),
                                        React.createElement('option',{value:'insert_ignore'},'INSERT IGNORE ‚Äî Inserisci, ignora duplicati'),
                                        React.createElement('option',{value:'upsert'},'UPSERT ‚Äî Inserisci o aggiorna se esiste'),
                                        React.createElement('option',{value:'update'},'UPDATE ‚Äî Solo aggiorna esistenti')
                                    )
                                ),
                                (dbWriteMode === 'upsert' || dbWriteMode === 'update') && React.createElement('div',{style:{marginBottom:'12px'}},
                                    React.createElement('label',{style:{fontSize:'12px',fontWeight:'600',display:'block',marginBottom:'3px'}},'Colonne chiave primaria (separate da virgola)'),
                                    React.createElement('input',{value:dbWritePk,onChange:e=>setDbWritePk(e.target.value),placeholder:'id, code',style:{width:'100%',padding:'8px',border:'1px solid #ddd',borderRadius:'6px',fontSize:'13px'}})
                                ),
                                React.createElement('button',{onClick:()=>dbWriteData(dbSelectedConn.id, dbSelectedTable, dbWriteMode, dbWritePk),disabled:dbLoading,style:{width:'100%',padding:'12px',background:dbLoading?'#ccc':'#c62828',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'14px',fontWeight:'700'}},'üöÄ Esegui scrittura su DB')
                            ),
                            React.createElement('button',{onClick:()=>setDbPanelView('tables'),style:{marginTop:'12px',padding:'8px 16px',background:'#f5f5f5',border:'1px solid #ddd',borderRadius:'6px',cursor:'pointer',fontSize:'12px'}},'‚Üê Indietro')
                        )
                    )
                )
            );
        }
        
        function Sidebar({ inputSchema, outputSchema, connections, activeTab, setActiveTab, setShowUploadModal, setUploadDirection, downloadSampleCSV, exportFieldsCSV, statusMessage, setDraggedField, selectedConnection, setSelectedConnection, uploadExampleFile, inputExample, outputExample, loadAvailableSchemas, showStatus, availableInputSchemas, availableOutputSchemas, inputSchemaId, setInputSchemaId, outputSchemaId, setOutputSchemaId, exportDiagram, setShowAccountModal }) {
            return React.createElement('div', { className: 'sidebar' },
                React.createElement('div', { className: 'sidebar-header' },
                    React.createElement('img', {
                        src: '/assets/logo-new.png',
                        alt: 'Buddyliko',
                        style: {
                            width: '100%',
                            display: 'block'
                        }
                    })
                ),
                React.createElement('div', { className: 'sidebar-content' },
                    statusMessage && React.createElement('div', { 
                        className: `status-message status-${statusMessage.type}` 
                    }, statusMessage.message),
                    React.createElement('div', { className: 'tabs' },
                        React.createElement('div', { 
                            className: `tab ${activeTab === 'input' ? 'active' : ''}`,
                            onClick: () => setActiveTab('input')
                        }, i18n.t('app.input'))),
                        React.createElement('div', { 
                            className: `tab ${activeTab === 'output' ? 'active' : ''}`,
                            onClick: () => setActiveTab('output')
                        }, i18n.t('app.output'))),
                        React.createElement('div', { 
                            className: `tab ${activeTab === 'connections' ? 'active' : ''}`,
                            onClick: () => setActiveTab('connections')
                        }, `üîó ${connections.length}`),
                        React.createElement('div', { 
                            className: `tab ${activeTab === 'schemas' ? 'active' : ''}`,
                            onClick: () => setActiveTab('schemas')
                        }, i18n.t('app.schemas')))
                    ),
                    activeTab === 'input' && React.createElement('div', null,
                        React.createElement('div', { style: { marginBottom: '10px' } },
                            React.createElement('label', { style: { display: 'block', marginBottom: '5px', fontWeight: 'bold', fontSize: '13px' } }, i18n.t('app.select_schema_type'))),
                            React.createElement('select', {
                                id: 'inputSchemaTypeSelect',
                                className: 'schema-type-select',
                                style: { width: '100%', padding: '8px', borderRadius: '4px', border: '1px solid #ddd', fontSize: '13px' },
                                value: inputSchemaId,
                                onChange: (e) => setInputSchemaId(e.target.value)
                            },
                                React.createElement('option', { value: '' }, i18n.t('app.select_schema'))),
                                availableInputSchemas.map(schema => 
                                    React.createElement('option', { 
                                        key: schema.name, 
                                        value: schema.name 
                                    }, `${schema.name}${schema.hasXsd ? ' ‚úÖ' : ''}${schema.hasSchematron ? ' üìã' : ''}`)
                                )
                            )
                        ),
                        React.createElement('button', {
                            className: 'btn btn-primary btn-full',
                            onClick: () => {
                                setUploadDirection('input');
                                setShowUploadModal(true);
                            }
                        }, i18n.t('app.upload_input'))),
                        React.createElement('label', {
                            className: 'btn btn-secondary btn-full',
                            style: { cursor: 'pointer' }
                        }, 
                            inputExample ? '‚úÖ Example File Loaded' : 'üìÑ Upload Example File',
                            React.createElement('input', {
                                type: 'file',
                                accept: '.xml,.json,.txt,.csv',
                                style: { display: 'none' },
                                onChange: (e) => e.target.files[0] && uploadExampleFile(e.target.files[0], 'input')
                            })
                        ),
                        React.createElement('button', {
                            className: 'btn btn-secondary btn-full',
                            onClick: () => inputSchema ? exportFieldsCSV('input') : downloadSampleCSV('input')
                        }, inputSchema ? 'üì• Export Fields CSV' : 'üì• Download Sample CSV'),
                        inputSchema ? React.createElement('div', { style: { fontSize: '12px', color: '#666', marginBottom: '10px' } },
                            `${inputSchema.field_count} fields - Drag to canvas`
                        ) : React.createElement('div', { className: 'empty-state' },
                            React.createElement('div', { style: { fontSize: '48px' } }, 'üìã'),
                            React.createElement('p', null, i18n.t('app.upload_csv_schema'))
                        )
                    ),
                    activeTab === 'output' && React.createElement('div', null,
                        React.createElement('div', { style: { marginBottom: '10px' } },
                            React.createElement('label', { style: { display: 'block', marginBottom: '5px', fontWeight: 'bold', fontSize: '13px' } }, i18n.t('app.select_schema_type'))),
                            React.createElement('select', {
                                id: 'outputSchemaTypeSelect',
                                className: 'schema-type-select',
                                style: { width: '100%', padding: '8px', borderRadius: '4px', border: '1px solid #ddd', fontSize: '13px' },
                                value: outputSchemaId,
                                onChange: (e) => setOutputSchemaId(e.target.value)
                            },
                                React.createElement('option', { value: '' }, i18n.t('app.select_schema'))),
                                availableOutputSchemas.map(schema => 
                                    React.createElement('option', { 
                                        key: schema.name, 
                                        value: schema.name 
                                    }, `${schema.name}${schema.hasXsd ? ' ‚úÖ' : ''}${schema.hasSchematron ? ' üìã' : ''}`)
                                )
                            )
                        ),
                        React.createElement('button', {
                            className: 'btn btn-primary btn-full',
                            onClick: () => {
                                setUploadDirection('output');
                                setShowUploadModal(true);
                            }
                        }, i18n.t('app.upload_output'))),
                        React.createElement('label', {
                            className: 'btn btn-secondary btn-full',
                            style: { cursor: 'pointer' }
                        }, 
                            outputExample ? '‚úÖ Example File Loaded' : 'üìÑ Upload Example File',
                            React.createElement('input', {
                                type: 'file',
                                accept: '.xml,.json,.txt,.csv',
                                style: { display: 'none' },
                                onChange: (e) => e.target.files[0] && uploadExampleFile(e.target.files[0], 'output')
                            })
                        ),
                        React.createElement('button', {
                            className: 'btn btn-secondary btn-full',
                            onClick: () => outputSchema ? exportFieldsCSV('output') : downloadSampleCSV('output')
                        }, outputSchema ? 'üì§ Export Fields CSV' : 'üì• Download Sample CSV'),
                        outputSchema ? React.createElement('div', { style: { fontSize: '12px', color: '#666', marginBottom: '10px' } },
                            `${outputSchema.field_count} fields - Drag to canvas`
                        ) : React.createElement('div', { className: 'empty-state' },
                            React.createElement('div', { style: { fontSize: '48px' } }, 'üìã'),
                            React.createElement('p', null, i18n.t('app.upload_csv_schema'))
                        )
                    ),
                    activeTab === 'connections' && React.createElement('div', {
                        style: {
                            overflowY: 'auto',
                            maxHeight: 'calc(100vh - 280px)',
                            paddingRight: '4px'
                        }
                    },
                        React.createElement(ConnectionsList, {
                            connections,
                            selectedConnection,
                            setSelectedConnection
                        })
                    ),
                    activeTab === 'schemas' && React.createElement('div', { style: { padding: '10px' } },
                        React.createElement('h3', { style: { marginBottom: '15px', fontSize: '16px' } }, i18n.t('app.schema_mgmt'))),
                        React.createElement('p', { style: { fontSize: '13px', color: '#666', marginBottom: '15px' } }, 
                            'Upload a ZIP file containing schema.xsd and rules.sch. The schema will be added to both input/ and output/ directories.'
                        ),
                        React.createElement('label', {
                            className: 'btn btn-primary btn-full',
                            style: { cursor: 'pointer', marginBottom: '10px' }
                        }, 
                            'üì¶ Upload Schema ZIP',
                            React.createElement('input', {
                                type: 'file',
                                accept: '.zip',
                                style: { display: 'none' },
                                onChange: async (e) => {
                                    const file = e.target.files[0];
                                    if (!file) return;
                                    
                                    showStatus('‚è≥ Uploading schema...', 'info');
                                    
                                    const formData = new FormData();
                                    formData.append('file', file);
                                    
                                    try {
                                        const res = await fetch(`${API_URL}/schemas/upload`, {
                                            method: 'POST',
                                            body: formData
                                        });
                                        
                                        if (!res.ok) {
                                            const error = await res.json();
                                            throw new Error(error.detail || i18n.t('common.failed'));
                                        }
                                        
                                        const data = await res.json();
                                        showStatus(`‚úÖ Schema "${data.schemaName}" uploaded successfully!`, 'success');
                                        
                                        // Reload schemas list
                                        loadAvailableSchemas();
                                        
                                        // Reset file input
                                        e.target.value = '';
                                    } catch (err) {
                                        console.error('Upload error:', err);
                                        showStatus(`‚ùå Upload failed: ${err.message}`, 'error');
                                    }
                                }
                            })
                        ),
                        React.createElement('div', { style: { marginTop: '20px', padding: '10px', background: '#f0f0f0', borderRadius: '6px', fontSize: '12px' } },
                            React.createElement('strong', null, i18n.t('app.zip_structure')),
                            React.createElement('pre', { style: { margin: '5px 0', fontFamily: 'monospace', fontSize: '11px' } },
                                `schema_name/\n  ‚îú‚îÄ‚îÄ schema.xsd (required)\n  ‚îî‚îÄ‚îÄ rules.sch (optional)`
                            )
                        ),
                        React.createElement('button', {
                            className: 'btn btn-secondary btn-full',
                            style: { marginTop: '10px' },
                            onClick: loadAvailableSchemas
                        }, i18n.t('app.refresh_schemas')))
                    )
                ),
                React.createElement('div', { className: 'sidebar-footer' },
                    React.createElement('div', { className: 'user-info' },
                        React.createElement('div', { className: 'user-avatar' },
                            (localStorage.getItem('buddyliko_user') ? 
                                JSON.parse(localStorage.getItem('buddyliko_user')).name?.charAt(0).toUpperCase() : 
                                'U')
                        ),
                        React.createElement('div', { className: 'user-details' },
                            React.createElement('div', { className: 'user-name' },
                                (localStorage.getItem('buddyliko_user') ? 
                                    JSON.parse(localStorage.getItem('buddyliko_user')).name || 'User' : 
                                    i18n.t('common.none'))
                            ),
                            React.createElement('div', { className: 'user-email' },
                                (localStorage.getItem('buddyliko_user') ? 
                                    JSON.parse(localStorage.getItem('buddyliko_user')).email || '' : 
                                    i18n.t('common.none'))
                            )
                        )
                    ),
                    React.createElement('div', { id: 'app-lang-switcher', style: { marginBottom: '8px' } }),
                    localStorage.getItem('buddyliko_token') && React.createElement(React.Fragment, null,
                        React.createElement('button', {
                            style: {
                                marginRight: '8px',
                                background: '#22263a',
                                border: '1px solid #2e3250',
                                color: '#94a3b8',
                                borderRadius: '6px',
                                padding: '6px 12px',
                                cursor: 'pointer',
                                fontSize: '12px',
                                fontFamily: 'inherit'
                            },
                            onClick: () => { window.location.href = 'workspace.html'; }
                        }, i18n.t('app.workspace')),
                        React.createElement('button', {
                            style: {
                                marginRight: '8px',
                                background: '#22263a',
                                border: '1px solid #2e3250',
                                color: '#94a3b8',
                                borderRadius: '6px',
                                padding: '6px 12px',
                                cursor: 'pointer',
                                fontSize: '12px',
                                fontFamily: 'inherit'
                            },
                            onClick: () => setShowAccountModal(true)
                        }, i18n.t('app.account')),
                        React.createElement('button', {
                            style: {
                                marginRight: '8px',
                                background: '#1e3a5f',
                                border: '1px solid #2563eb44',
                                color: '#93c5fd',
                                borderRadius: '6px',
                                padding: '6px 12px',
                                cursor: 'pointer',
                                fontSize: '12px',
                                fontFamily: 'inherit'
                            },
                            onClick: () => { window.location.href = 'account.html'; }
                        }, i18n.t('app.subscription')),
                        React.createElement('button', {
                            className: 'btn-logout',
                            onClick: () => {
                                if (confirm(i18n.t('app.confirm_logout'))) {
                                    logout();
                                }
                            }
                        }, i18n.t('app.logout'))
                    )
                )
            );
        }
        
        function MainCanvas({ inputSchema, outputSchema, connections, draggedField, setDraggedField, addConnection, mappingName, setMappingName, saveMapping, canvasRef, fieldPositions, updateFieldPositions, selectedConnection, setSelectedConnection, saveSessionToBackend, clearSession, sessionLoaded, inputExample, outputExample, hoverPopup, setHoverPopup, hoverTimeoutRef, setShowFormulaEditor, setEditingConnection, runAIAutoMap, runBusinessRulesAutomap, aiProcessing, setShowSettings, searchQuery, setSearchQuery, performSearch, nextSearchResult, searchResults, currentSearchIndex, saveProject, loadProject, reverseMapping, setPopupPinned, popupPinned, setShowSchemaEditor, hideConnected, setHideConnected, onOpenNodeImport, onFieldContextMenu, onEditNode, onDeleteNode, exportDiagram, aiWorkLog, setShowAiWork, generateCode, dbConnections, setShowDbConnPanel, billingStatus, setShowBillingModal, importEdiAsSchema, usageAlerts }) {
            const [dropTarget, setDropTarget] = useState(null);
            
            const handleDrop = (targetField, targetType) => {
                if (!draggedField) return;
                
                if (draggedField.type === 'input' && targetType === 'output') {
                    addConnection(draggedField.field, targetField);
                } else if (draggedField.type === 'output' && targetType === 'input') {
                    addConnection(targetField, draggedField.field);
                } else {
                    // Same side drop - not allowed
                }
                
                setDraggedField(null);
                setDropTarget(null);
            };
            
            return React.createElement('div', { className: 'main-canvas' },
                React.createElement('div', { className: 'toolbar' },
                    React.createElement('div', {
                        style: { display: 'flex', alignItems: 'center', gap: '8px', marginRight: '20px' }
                    },
                        React.createElement('input', {
                            type: 'text',
                            className: 'search-input',
                            placeholder: 'Search fields (RegExp supported)...',
                            value: searchQuery,
                            onChange: (e) => setSearchQuery(e.target.value),
                            onKeyPress: (e) => { if (e.key === 'Enter') performSearch(); }
                        }),
                        React.createElement('button', {
                            className: 'btn btn-primary',
                            onClick: performSearch,
                            disabled: !searchQuery.trim(),
                            title: 'Search for fields matching pattern'
                        }, i18n.t('app.search'))),
                        React.createElement('button', {
                            className: 'btn btn-secondary',
                            onClick: nextSearchResult,
                            disabled: searchResults.length === 0,
                            title: `Next result (${currentSearchIndex + 1}/${searchResults.length})`
                        }, `üîΩ Next ${searchResults.length > 0 ? `(${currentSearchIndex + 1}/${searchResults.length})` : ''}`)
                    ),
                    React.createElement('input', {
                        type: 'text',
                        placeholder: 'Mapping name...',
                        value: mappingName,
                        onChange: (e) => setMappingName(e.target.value),
                        style: { width: '200px' }
                    }),
                    React.createElement('button', {
                        className: 'btn btn-success',
                        onClick: saveMapping
                    }, i18n.t('app.save_mapping'))),
                    React.createElement('button', {
                        className: 'btn btn-secondary',
                        onClick: () => window.exportMappingCSV?.(),
                        disabled: connections.length === 0,
                        title: 'Export mapping as CSV'
                    }, i18n.t('app.export_csv_schema'))),
                    React.createElement('button', {
                        className: 'btn btn-secondary',
                        onClick: () => window.exportMappingJSON?.(),
                        disabled: connections.length === 0,
                        title: 'Export mapping as JSON'
                    }, i18n.t('app.export_json'))),
                    React.createElement('button', {
                        className: 'btn btn-secondary',
                        onClick: exportDiagram,
                        disabled: connections.length === 0,
                        title: 'Esporta diagramma SVG della mappatura',
                        style: { background: connections.length > 0 ? 'linear-gradient(135deg, #667eea, #764ba2)' : undefined, color: connections.length > 0 ? '#fff' : undefined, border: 'none' }
                    }, i18n.t('app.diagram')),
                    React.createElement('div', {
                        style: { 
                            width: '2px', 
                            height: '30px', 
                            background: '#ddd', 
                            margin: '0 10px' 
                        }
                    }),
                    React.createElement('button', {
                        className: 'btn btn-success',
                        onClick: saveProject,
                        disabled: !inputSchema || !outputSchema,
                        title: 'Save complete project (schemas + examples + mappings) ‚Äî name not required'
                    }, i18n.t('app.save_project'))),
                    React.createElement('button', {
                        className: 'btn btn-primary',
                        onClick: loadProject,
                        title: 'Load project from file'
                    }, i18n.t('app.load_project'))),
                    React.createElement('button', {
                        className: 'btn btn-warning',
                        onClick: generateCode,
                        disabled: !inputSchema || !outputSchema || connections.length === 0,
                        title: 'Generate optimized Python + C# code from this mapping',
                        style: { background: '#7c3aed', borderColor: '#7c3aed', color: 'white' }
                    }, i18n.t('app.generate_code'))),
                    React.createElement('button', {
                        className: 'btn btn-danger',
                        onClick: reverseMapping,
                        disabled: !inputSchema || !outputSchema || connections.length === 0,
                        title: 'Reverse mapping: Swap input‚Üîoutput and invert transformations'
                    }, i18n.t('app.reverse'))),
                    React.createElement('button', {
                        className: `btn ${hideConnected ? 'btn-success' : 'btn-secondary'}`,
                        onClick: () => setHideConnected(!hideConnected),
                        disabled: connections.length === 0,
                        title: hideConnected ? 'Show all fields' : 'Hide connected fields'
                    }, hideConnected ? 'üëÅÔ∏è Show All' : 'üôà Hide Connected'),
                    React.createElement('button', {
                        className: 'btn btn-success',
                        onClick: () => executeTransformAsync(),
                        disabled: !inputSchema || !outputSchema || connections.length === 0,
                        title: 'Execute transformation ‚Äî async with progress polling, auto-downloads result'
                    }, i18n.t('app.execute_transform'))),
                    React.createElement('button', {
                        className: 'btn btn-primary',
                        onClick: runAIAutoMap,
                        disabled: !inputSchema || !outputSchema || aiProcessing,
                        title: 'AI analyzes schemas and suggests mappings'
                    }, aiProcessing ? '‚è≥ AI Working...' : 'ü§ñ AI Auto-Map'),
                    React.createElement('button', {
                        className: 'btn btn-secondary',
                        title: aiProcessing ? 'AI running ‚Äî click to open live log' : aiWorkLog.length > 0 ? 'Open AI activity log from last run' : 'Run AI Auto-Map first',
                        disabled: aiWorkLog.length === 0 && !aiProcessing,
                        onClick: () => setShowAiWork(true),
                        style: { position: 'relative' }
                    }, 
                        aiProcessing ? '‚ö° AI at Work‚Ä¶' : 'üî¨ AI at Work',
                        aiProcessing && React.createElement('span', {
                            style: { display: 'inline-block', width: '8px', height: '8px', borderRadius: '50%',
                                background: '#a6e3a1', marginLeft: '6px', animation: 'pulse 1s infinite' }
                        })
                    ),
                    React.createElement('button', {
                        className: 'btn btn-success',
                        onClick: runBusinessRulesAutomap,
                        disabled: !inputSchema || !outputSchema,
                        title: 'Automatically match fields with identical business terms'
                    }, i18n.t('app.business_rules'))),
                    React.createElement('button', {
                        className: 'btn btn-primary',
                        onClick: () => setShowSchemaEditor(true),
                        title: 'Visual schema structure builder'
                    }, i18n.t('app.schema_editor'))),
                    React.createElement('button', {
                        className: 'btn btn-secondary',
                        onClick: () => setShowSettings(true),
                        title: 'Configure AI API keys'
                    }, i18n.t('app.settings'))),
                    React.createElement('button', {
                        className: 'btn btn-primary',
                        onClick: saveSessionToBackend,
                        title: 'Save current session to server'
                    }, i18n.t('app.save_session'))),
                    React.createElement('button', {
                        className: 'btn btn-secondary',
                        onClick: clearSession,
                        title: 'Clear all and start fresh'
                    }, i18n.t('app.clear_session'))),
                    // EDI / HL7 import buttons
                    React.createElement('button', {
                        className: 'btn btn-secondary',
                        onClick: () => importEdiAsSchema('input'),
                        title: 'Import EDI X12 / EDIFACT / HL7 v2 / FHIR as input schema'
                    }, i18n.t('app.edi_input'))),
                    React.createElement('button', {
                        className: 'btn btn-secondary',
                        onClick: () => importEdiAsSchema('output'),
                        title: 'Import EDI X12 / EDIFACT / HL7 v2 / FHIR as output schema'
                    }, i18n.t('app.edi_output'))),
                    // DB Connector
                    React.createElement('button', {
                        className: 'btn btn-secondary',
                        onClick: () => setShowDbConnPanel(true),
                        title: 'Load schema from database table'
                    }, `üóÑÔ∏è DB${dbConnections.length > 0 ? ` (${dbConnections.length})` : ''}`),
                    React.createElement('div', { style: { marginLeft: 'auto', fontSize: '13px', color: '#666' } },
                        `${connections.length} connection(s)`,
                        sessionLoaded && React.createElement('span', {
                            style: { marginLeft: '10px', fontSize: '11px', color: '#4caf50' }
                        }, i18n.t('app.autosave'))),
                        // Billing usage indicator
                        billingStatus && React.createElement('span', {
                            style: {
                                marginLeft: '12px', fontSize: '11px', cursor: 'pointer',
                                color: usageAlerts.some(a => a.level === 'exceeded') ? '#e53935' :
                                       usageAlerts.some(a => a.level === 'critical') ? '#ff6f00' :
                                       usageAlerts.some(a => a.level === 'warning') ? '#f9a825' : '#666',
                                fontWeight: usageAlerts.length > 0 ? '600' : 'normal',
                            },
                            onClick: () => setShowBillingModal(true),
                            title: 'Clicca per dettagli piano e utilizzo'
                        }, (() => {
                            const plan = billingStatus.plan || 'FREE';
                            const usage = billingStatus.usage || {};
                            const limits = billingStatus.limits || {};
                            const maxT = limits.transforms_per_month;
                            const used = usage.transforms_count || 0;
                            if (maxT > 0) {
                                const pct = Math.round((used / maxT) * 100);
                                return `${plan} ¬∑ ${used}/${maxT} trasf. (${pct}%)${usageAlerts.length > 0 ? ' ‚ö†Ô∏è' : ''}`;
                            }
                            return `${plan} ¬∑ ${used} trasf. ‚àû`;
                        })())
                    )
                ),
                React.createElement('div', { className: 'canvas-area', ref: canvasRef },
                    draggedField && React.createElement('div', {
                        style: {
                            position: 'fixed',
                            top: '10px',
                            left: '50%',
                            transform: 'translateX(-50%)',
                            background: '#4caf50',
                            color: 'white',
                            padding: '10px 20px',
                            borderRadius: '6px',
                            fontWeight: 'bold',
                            zIndex: 1000
                        }
                    }, `‚úã Dragging: ${draggedField.field.name} ‚Üí Drop on ${draggedField.type === 'input' ? 'OUTPUT' : 'INPUT'} field`),
                    
                    React.createElement(ConnectionsSVG, {
                        connections,
                        fieldPositions,
                        selectedConnection,
                        setSelectedConnection
                    }),
                    
                    React.createElement('div', { 
                        className: 'canvas-columns'
                    },
                        // INPUT COLUMN
                        React.createElement('div', { 
                            className: 'canvas-column',
                            id: 'input-column',
                            style: { width: '450px' }
                        },
                            React.createElement('h3', {
                                style: { cursor: 'ew-resize', display: 'flex', alignItems: 'center', justifyContent: 'space-between' },  // Always show resize cursor
                                onMouseDown: (e) => {
                                    // Don't trigger resize if clicking the + button
                                    if (e.target.classList.contains('col-import-btn')) return;
                                    e.preventDefault();
                                    console.log('INPUT HEADER DRAG START');
                                    const column = document.getElementById('input-column');
                                    const startX = e.clientX;
                                    const startWidth = column.offsetWidth;
                                    
                                    const onMouseMove = (moveEvent) => {
                                        const delta = moveEvent.clientX - startX;
                                        const newWidth = Math.max(250, Math.min(900, startWidth + delta));
                                        column.style.flex = `0 0 ${newWidth}px`;
                                        column.style.width = newWidth + 'px';
                                        
                                        // Update arrows
                                        requestAnimationFrame(() => {
                                            updateFieldPositions();
                                        });
                                    };
                                    
                                    const onMouseUp = () => {
                                        console.log('INPUT HEADER DRAG END');
                                        document.removeEventListener('mousemove', onMouseMove);
                                        document.removeEventListener('mouseup', onMouseUp);
                                        document.body.style.cursor = '';
                                    };
                                    
                                    document.body.style.cursor = 'ew-resize';
                                    document.addEventListener('mousemove', onMouseMove);
                                    document.addEventListener('mouseup', onMouseUp);
                                }
                            },
                                React.createElement('span', null, 'üì• INPUT SCHEMA'),
                                inputSchema && React.createElement('button', {
                                    className: 'col-import-btn',
                                    title: 'Importa nodi aggiuntivi (CSV/JSON)',
                                    onClick: (e) => { e.stopPropagation(); onOpenNodeImport && onOpenNodeImport('input'); }
                                }, 'Ôºã')
                            ),
                            inputSchema && Object.values(inputSchema.fields)
                                .filter(field => {
                                    if (!hideConnected) return true;
                                    // Hide if field is source of any connection
                                    return !connections.some(conn => 
                                        conn.source === field.id || 
                                        (conn.sources && conn.sources.includes(field.id))
                                    );
                                })
                                .map(field =>
                                React.createElement(FieldBox, {
                                    key: field.id,
                                    field,
                                    type: 'input',
                                    setDraggedField,
                                    draggedField,
                                    dropTarget,
                                    setDropTarget,
                                    handleDrop,
                                    updateFieldPositions,
                                    connections,
                                    inputExample,
                                    outputExample,
                                    inputSchema,
                                    outputSchema,
                                    setHoverPopup,
                                    hoverTimeoutRef,
                                    popupPinned,
                                    setPopupPinned,
                                    selectedConnection,
                                    onFieldContextMenu,
                                    onEditNode,
                                    onDeleteNode
                                })
                            )
                        ),
                        
                        // OUTPUT COLUMN
                        React.createElement('div', { 
                            className: 'canvas-column',
                            id: 'output-column',
                            style: { width: '450px' }
                        },
                            React.createElement('h3', {
                                style: { cursor: 'ew-resize', display: 'flex', alignItems: 'center', justifyContent: 'space-between' },  // Always show resize cursor
                                onMouseDown: (e) => {
                                    if (e.target.classList.contains('col-import-btn')) return;
                                    e.preventDefault();
                                    console.log('OUTPUT HEADER DRAG START');
                                    const column = document.getElementById('output-column');
                                    const startX = e.clientX;
                                    const startWidth = column.offsetWidth;
                                    
                                    const onMouseMove = (moveEvent) => {
                                        const delta = moveEvent.clientX - startX; // Moving right = positive delta
                                        const newWidth = Math.max(250, Math.min(900, startWidth - delta)); // Subtract delta: drag left = wider
                                        column.style.flex = `0 0 ${newWidth}px`;
                                        column.style.width = newWidth + 'px';
                                        
                                        // Update arrows
                                        requestAnimationFrame(() => {
                                            updateFieldPositions();
                                        });
                                    };
                                    
                                    const onMouseUp = () => {
                                        console.log('OUTPUT HEADER DRAG END');
                                        document.removeEventListener('mousemove', onMouseMove);
                                        document.removeEventListener('mouseup', onMouseUp);
                                        document.body.style.cursor = '';
                                    };
                                    
                                    document.body.style.cursor = 'ew-resize';
                                    document.addEventListener('mousemove', onMouseMove);
                                    document.addEventListener('mouseup', onMouseUp);
                                }
                            },
                                React.createElement('span', null, 'üì§ OUTPUT SCHEMA'),
                                outputSchema && React.createElement('button', {
                                    className: 'col-import-btn',
                                    title: 'Importa nodi aggiuntivi (CSV/JSON)',
                                    onClick: (e) => { e.stopPropagation(); onOpenNodeImport && onOpenNodeImport('output'); }
                                }, 'Ôºã')
                            ),
                            outputSchema && Object.values(outputSchema.fields)
                                .filter(field => {
                                    if (!hideConnected) return true;
                                    // Hide if field is target of any connection
                                    return !connections.some(conn => conn.target === field.id);
                                })
                                .map(field =>
                                React.createElement(FieldBox, {
                                    key: field.id,
                                    field,
                                    type: 'output',
                                    setDraggedField,
                                    draggedField,
                                    dropTarget,
                                    setDropTarget,
                                    handleDrop,
                                    updateFieldPositions,
                                    connections,
                                    inputExample,
                                    outputExample,
                                    inputSchema,
                                    outputSchema,
                                    setHoverPopup,
                                    hoverTimeoutRef,
                                    popupPinned,
                                    setPopupPinned,
                                    selectedConnection,
                                    onFieldContextMenu,
                                    onEditNode,
                                    onDeleteNode
                                })
                            )
                        )
                    ),
                    (!inputSchema || !outputSchema) && React.createElement('div', { className: 'empty-state' },
                        React.createElement('div', { style: { fontSize: '64px' } }, 'üìä'),
                        React.createElement('h3', null, 'Upload Schemas to Start'),
                        React.createElement('p', null, i18n.t('app.upload_subtitle'))
                    )
                )
            );
        }
        
        function FieldBox({ field, type, setDraggedField, draggedField, dropTarget, setDropTarget, handleDrop, updateFieldPositions, connections, inputExample, outputExample, inputSchema, outputSchema, setHoverPopup, hoverTimeoutRef, popupPinned, setPopupPinned, selectedConnection, onFieldContextMenu, onEditNode, onDeleteNode }) {
            const isConnected = connections.some(c => 
                (type === 'input' && (c.source === field.path || c.source === field.id || c.source === field.name)) ||
                (type === 'output' && (c.target === field.path || c.target === field.id || c.target === field.name ||
                    c.target === (field.path || '').replace(/\./g, '_') ||
                    (field.path && c.target && c.target.replace(/[._]/g,'') === field.path.replace(/[._]/g,''))))
            );
            
            // DEBUG: Log connection status
            if (type === 'output') {
                console.log('üîç Field:', field.name, 'path:', field.path, 'id:', field.id);
                console.log('üîó isConnected:', isConnected);
                console.log('üìä Total connections:', connections.length);
                if (isConnected) {
                    const matchingConns = connections.filter(c => c.target === field.path || c.target === field.id || c.target === field.name || c.target === (field.path||'').replace(/\./g,'_') || (field.path && c.target && c.target.replace(/[._]/g,'') === field.path.replace(/[._]/g,'')));
                    console.log('üéØ Matching conns for popup:', matchingConns.length, matchingConns.map(c => ({target: c.target, source: c.source, sourcePath: c.sourcePath})));
                }
            }
            
            const isDropTarget = dropTarget === field.id;
            const isDragging = draggedField?.field.id === field.id;
            
            const handleMouseEnter = (e, immediate = false) => {
                console.log('HOVER START on', field.name, 'type:', type, 'immediate:', immediate);
                
                // If popup is pinned, don't do anything on hover
                if (popupPinned && !immediate) return;
                
                if (hoverTimeoutRef.current) {
                    clearTimeout(hoverTimeoutRef.current);
                }
                
                // Capture rect BEFORE setTimeout
                const rect = e.currentTarget.getBoundingClientRect();
                
                // Use a ref snapshot so setTimeout closure always sees latest connections
                const connectionsSnapshot = connections.slice();
                const showPopupFn = () => {
                    console.log('SHOWING POPUP for', field.name);
                    
                    if (type === 'input' && inputExample) {
                        // INPUT: Extract context using offset/length or XML path
                        const lines = inputExample.split('\n');
                        let contextLines = [];
                        let highlightIndex = -1;
                        let highlightChar = null;
                        
                        // Detect format
                        const isXML = inputExample.trim().startsWith('<');
                        const isJSON = inputExample.trim().startsWith('{') || inputExample.trim().startsWith('[');
                        const isFlat = !isXML && !isJSON;
                        
                        if (isFlat && field.offset !== undefined && field.length !== undefined) {
                            // IDOC FORMAT: segment pattern + offset + length
                            const segmentName = field.path.split('.')[0]; // E1EDK01
                            const offset = parseInt(field.offset) || 0;
                            const length = parseInt(field.length) || 0;
                            
                            // Find line containing this segment
                            let foundLine = -1;
                            
                            for (let i = 0; i < lines.length; i++) {
                                const line = lines[i];
                                // Check both E1 and E2 prefixes (E1EDK01 might be E2EDK01 in file)
                                const altSegment = segmentName.replace(/^E1/, 'E2');
                                
                                if (line.startsWith(segmentName) || line.startsWith(altSegment)) {
                                    foundLine = i;
                                    break; // Take first occurrence
                                }
                            }
                            
                            if (foundLine >= 0) {
                                // Get 5 lines before and after
                                const start = Math.max(0, foundLine - 5);
                                const end = Math.min(lines.length, foundLine + 6);
                                contextLines = lines.slice(start, end);
                                highlightIndex = foundLine - start;
                                
                                // Highlight EXACTLY offset -> offset+length
                                const line = lines[foundLine];
                                const charStart = offset;
                                const charEnd = Math.min(offset + length, line.length);
                                
                                console.log('HIGHLIGHT CHAR:', {
                                    field: field.name,
                                    segment: segmentName,
                                    line: line.substring(0, 100),
                                    offset: offset,
                                    length: length,
                                    charStart: charStart,
                                    charEnd: charEnd,
                                    extractedValue: line.substring(charStart, charEnd)
                                });
                                
                                highlightChar = { start: charStart, end: charEnd };
                            }
                        } else if ((isXML || isJSON) && (field.xml_path || field.json_path)) {
                            // XML/JSON: Use backend API for extraction
                            console.log('üì° Calling API for XML/JSON extraction:', field.name);
                            
                            const fieldPath = field.xml_path || field.json_path || field.path;
                            const formatType = isXML ? 'xml' : 'json';
                            
                            // Call API asynchronously
                            fetch(`${API_URL}/preview/extract`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    example_content: inputExample,
                                    field_path: fieldPath,
                                    field_name: field.name,
                                    format_type: formatType
                                })
                            })
                            .then(res => res.json())
                            .then(data => {
                                console.log('‚úÖ API Response:', data);
                                
                                if (data.error) {
                                    console.error('API Error:', data.error);
                                    // Show error in popup
                                    setHoverPopup({
                                        field,
                                        type,
                                        rect,
                                        code: `Error: ${data.error}`,
                                        contextLines: [],
                                        highlightIndex: -1
                                    });
                                    return;
                                }
                                
                                // Success - show extracted value
                                const extractedValue = data.value || 'N/A';
                                const code = `<${field.name}>${extractedValue}</${field.name}>`;
                                
                                setHoverPopup({
                                    field,
                                    type,
                                    rect,
                                    code,
                                    contextLines: data.context_lines || [],
                                    highlightIndex: data.highlight_line || -1,
                                    highlightChar: null // XML uses line-level highlighting
                                });
                            })
                            .catch(err => {
                                console.error('API Call Failed:', err);
                                setHoverPopup({
                                    field,
                                    type,
                                    rect,
                                    code: `Error: ${err.message}`,
                                    contextLines: [],
                                    highlightIndex: -1
                                });
                            });
                            
                            // Show loading state immediately
                            setHoverPopup({
                                field,
                                type,
                                rect,
                                code: '‚è≥ Loading...',
                                contextLines: ['Extracting value from ' + formatType.toUpperCase() + '...'],
                                highlightIndex: -1
                            });
                            
                            return; // Exit early - popup will be updated by API response
                        } else {
                            // FALLBACK: Search by field name/path
                            const searchTerms = [field.name, field.path, field.id].filter(Boolean);
                            
                            lines.forEach((line, idx) => {
                                if (searchTerms.some(term => line.includes(term))) {
                                    if (highlightIndex === -1) {
                                        highlightIndex = idx;
                                    }
                                }
                            });
                            
                            if (highlightIndex >= 0) {
                                const start = Math.max(0, highlightIndex - 5);
                                const end = Math.min(lines.length, highlightIndex + 6);
                                contextLines = lines.slice(start, end);
                                highlightIndex = highlightIndex - start;
                            } else {
                                // Show first 11 lines as fallback
                                contextLines = lines.slice(0, Math.min(11, lines.length));
                                highlightIndex = 0;
                            }
                        }
                        
                        setHoverPopup({
                            type: 'input',
                            field: field,
                            lines: contextLines,
                            highlightIndex: highlightIndex,
                            highlightChar: highlightChar,
                            x: rect.right + 10,
                            y: rect.top
                        });
                        
                    } else if (type === 'output' && isConnected) {
                        console.log('OUTPUT HOVER START (CONNECTED)', field.name, 'isConnected:', isConnected);
                        
                        // Helper function to apply transformations
                        const applyTransformation = (value, transType) => {
                            if (!value || typeof value !== 'string') return value;
                            
                            const type = typeof transType === 'string' ? transType.toUpperCase() : '';
                            
                            switch (type) {
                                case 'UPPERCASE':
                                    return value.toUpperCase();
                                case 'LOWERCASE':
                                    return value.toLowerCase();
                                case 'TRIM':
                                    return value.trim();
                                case 'CAPITALIZE':
                                    return value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                                case 'DIRECT':
                                    return value;
                                default:
                                    // Unknown transformation type
                                    console.warn('Unknown transformation type:', transType);
                                    return value;
                            }
                        };
                        
                        // OUTPUT: Generate XML code with ACTUAL VALUES from input
                        // FIX: Check both field.path and field.id for matching connections
                        const relatedConns = connections.filter(c => 
                            c.target === field.path || 
                            c.target === field.id ||
                            c.target === field.name
                        );
                        console.log('Related connections:', relatedConns);
                        console.log('Field:', field.path, field.id, field.name);
                        
                        let code = '';
                        
                        // Generate XML from xmlpath
                        const xmlPath = field.xml_path || field.path;
                        const nodeName = xmlPath.split('/').pop();
                        
                        // Function to extract value from input example
                        const extractValueFromInput = async (sourceField, directPath) => {
                            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                            console.log('üîç EXTRACTING VALUE');
                            console.log('üìù sourceField:', sourceField);
                            console.log('üìã inputSchema.fields:', Object.keys(inputSchema?.fields || {}));
                            
                            if (!inputExample || !inputSchema) {
                                console.log('‚ùå No inputExample or inputSchema');
                                return null;
                            }
                            
                            const lines = inputExample.split('\n');
                            
                            // SHORTCUT: if we already have the path from conn.sourcePath, use it directly
                            if (directPath && (inputExample.trim().startsWith('<') || inputExample.trim().startsWith('{'))) {
                                const isXML2 = inputExample.trim().startsWith('<');
                                try {
                                    const resp = await fetch(`${API_URL}/preview/extract`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                                        body: JSON.stringify({
                                            example_content: inputExample,
                                            field_path: directPath,
                                            field_name: sourceField,
                                            format_type: isXML2 ? 'xml' : 'json'
                                        })
                                    });
                                    const d = await resp.json();
                                    if (d.value !== null && d.value !== undefined && !d.error) {
                                        return d.value;
                                    }
                                } catch(e) {}
                                // If direct path failed, fall through to schema lookup
                            }

                            // Find source field data - try multiple keys
                            let sourceFieldData = null;
                            const possibleKeys = [
                                sourceField,
                                sourceField.replace('.', '_'),
                                sourceField.replace(':', '_'),
                                sourceField.replace(/[.:]/g, '_')
                            ];
                            
                            console.log('üîé Trying keys:', possibleKeys);
                            
                            for (const key of possibleKeys) {
                                if (inputSchema.fields[key]) {
                                    sourceFieldData = inputSchema.fields[key];
                                    console.log('‚úÖ FOUND with key:', key);
                                    console.log('üìÑ Field data:', sourceFieldData);
                                    break;
                                }
                            }
                            
                            // If not found by key, try to find by field.id or field.name
                            if (!sourceFieldData) {
                                console.log('üîé Searching in all fields by id/name/path...');
                                for (const [fieldKey, fieldData] of Object.entries(inputSchema.fields)) {
                                    if (fieldData.id === sourceField || 
                                        fieldData.name === sourceField || 
                                        fieldData.path === sourceField ||
                                        fieldKey === sourceField) {
                                        sourceFieldData = fieldData;
                                        console.log('‚úÖ FOUND field:', fieldKey, '‚Üí', fieldData);
                                        break;
                                    }
                                }
                            }
                            
                            if (!sourceFieldData) {
                                // Last resort: try using sourceField as a path directly
                                const isXML3 = inputExample.trim().startsWith('<');
                                const isJSON3 = inputExample.trim().startsWith('{') || inputExample.trim().startsWith('[');
                                if (isXML3 || isJSON3) {
                                    try {
                                        const resp = await fetch(`${API_URL}/preview/extract`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                                            body: JSON.stringify({
                                                example_content: inputExample,
                                                field_path: sourceField,
                                                field_name: sourceField,
                                                format_type: isXML3 ? 'xml' : 'json'
                                            })
                                        });
                                        const d = await resp.json();
                                        if (d.value !== null && d.value !== undefined && !d.error) {
                                            return d.value;
                                        }
                                    } catch(e) {}
                                }
                                console.error('‚ùå‚ùå‚ùå FIELD NOT FOUND:', sourceField);
                                return null;
                            }
                            
                            console.log('‚úÖ‚úÖ‚úÖ sourceFieldData:', sourceFieldData);
                            
                            // Detect format
                            const isXML = inputExample.trim().startsWith('<');
                            const isJSON = inputExample.trim().startsWith('{') || inputExample.trim().startsWith('[');
                            // IDoc: flat file with numeric offset+length on the field
                            const hasNumericOffset = sourceFieldData?.offset && 
                                !isNaN(parseInt(sourceFieldData.offset)) && 
                                parseInt(sourceFieldData.offset) > 0;
                            const hasLength = sourceFieldData?.length && 
                                !isNaN(parseInt(sourceFieldData.length));
                            const isIDoc = !isXML && !isJSON && hasNumericOffset && hasLength;
                            
                            if ((isXML || isJSON) && !isIDoc) {
                                // XML/JSON: Use API extraction
                                console.log('üì° Using API for XML/JSON extraction');
                                
                                // For XML: prefer xml_path, then json_path, then path (FatturaPA uses path directly)
                                const fieldPath = sourceFieldData?.xml_path || sourceFieldData?.json_path || sourceFieldData?.path;
                                if (!fieldPath) {
                                    console.log('No path for field, skipping API');
                                    return null;
                                }
                                
                                try {
                                    const response = await fetch(`${API_URL}/preview/extract`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            example_content: inputExample,
                                            field_path: fieldPath,
                                            field_name: sourceFieldData.name || sourceField,
                                            format_type: isXML ? 'xml' : 'json'
                                        })
                                    });
                                    
                                    const data = await response.json();
                                    
                                    if (data.error) {
                                        console.error('API Error:', data.error);
                                        return null;
                                    }
                                    
                                    console.log('‚úÖ Extracted value from XML/JSON:', data.value);
                                    return data.value;
                                    
                                } catch (err) {
                                    console.error('API call failed:', err);
                                    return null;
                                }
                                
                            } else {
                                // FLAT FILE (IDOC): Use offset/length
                                if (!sourceFieldData || !sourceFieldData.offset || !sourceFieldData.length) {
                                    console.log('Missing offset/length');
                                    return null;
                                }
                                
                                const segmentName = sourceField.split('.')[0];
                                const offset = parseInt(sourceFieldData.offset);
                                const length = parseInt(sourceFieldData.length);
                                
                                // Find line with segment
                                for (let line of lines) {
                                    const altSegment = segmentName.replace(/^E1/, 'E2');
                                    if (line.startsWith(segmentName) || line.startsWith(altSegment)) {
                                        // Extract value at offset
                                        const value = line.substring(offset, offset + length).trim();
                                        console.log('Extracted value:', value, 'from offset', offset, 'length', length);
                                        return value || null;
                                    }
                                }
                                return null;
                            }
                        };
                        
                        if (relatedConns.length === 1) {
                            const conn = relatedConns[0];
                            
                            // Show loading state immediately
                            setHoverPopup({
                                type: 'output',
                                code: '‚è≥ Loading transformation...',
                                field: field,
                                x: rect.left - 410,
                                y: rect.top
                            });
                            
                            // Extract value asynchronously ‚Äî prefer sourcePath if available
                            extractValueFromInput(conn.source, conn.sourcePath).then(value => {
                                console.log('üì• Extracted value:', value);
                                console.log('üîó Connection:', conn);
                                console.log('üîÑ Transformation object:', conn.transformation);
                                
                                if (!value) {
                                    // NO FALLBACK to field name! Use placeholder instead
                                    console.warn('‚ö†Ô∏è Could not extract value from input example for:', conn.source);
                                    value = 'VALUE_NOT_FOUND';
                                }
                                
                                // Apply transformation to the extracted value
                                let transformedValue = value;
                                
                                if (conn.transformation) {
                                    // Check what type of transformation object we have
                                    if (typeof conn.transformation === 'string') {
                                        // Simple string transformation type
                                        transformedValue = applyTransformation(value, conn.transformation);
                                    } else if (conn.transformation.formula) {
                                        // Has custom formula - show formula (can't evaluate dynamically)
                                        transformedValue = `\${${conn.transformation.formula}}`;
                                    } else if (conn.transformation.type && typeof conn.transformation.type === 'string' && conn.transformation.type !== 'direct') {
                                        // Built-in transformation with type property
                                        transformedValue = applyTransformation(value, conn.transformation.type);
                                    } else if (conn.transformation.operation) {
                                        // Complex transformation object with operation, inputs, etc.
                                        // For now, show a placeholder (can't evaluate complex transformations)
                                        transformedValue = `\${${conn.transformation.operation}(...)}`;
                                    } else {
                                        // Unknown transformation format, use value as-is
                                        console.warn('Unknown transformation format:', conn.transformation);
                                        transformedValue = value;
                                    }
                                }
                                
                                console.log('Final transformed value:', transformedValue);
                                
                                let code = '';
                                const xmlPath = field.xml_path || field.path;
                                const nodeName = xmlPath.split('/').pop();
                                
                                // Generate XML with transformed value
                                code = `<${nodeName}>${transformedValue}</${nodeName}>`;
                                
                                // Add parent context if available
                                const pathParts = xmlPath.split('/').filter(p => p);
                                if (pathParts.length > 1) {
                                    const parentNode = pathParts[pathParts.length - 2];
                                    code = `<${parentNode}>\n  ${code}\n</${parentNode}>`;
                                }
                                
                                console.log('Generated code:', code);
                                
                                // Update popup with actual code
                                setHoverPopup({
                                    type: 'output',
                                    code: code,
                                    field: field,
                                    connections: relatedConns,
                                    x: rect.left - 410,
                                    y: rect.top
                                });
                            }).catch(err => {
                                console.error('Extraction failed:', err);
                                // Show error popup
                                setHoverPopup({
                                    type: 'output',
                                    code: `‚ùå Error: ${err.message}`,
                                    field: field,
                                    x: rect.left - 410,
                                    y: rect.top
                                });
                            });
                            
                            // Exit early - popup will be updated by promise
                            
                        } else if (relatedConns.length > 1) {
                            // Multiple inputs - show loading
                            setHoverPopup({
                                type: 'output',
                                code: '‚è≥ Loading transformation...',
                                field: field,
                                x: rect.left - 410,
                                y: rect.top
                            });
                            
                            // Extract all values asynchronously
                            Promise.all(relatedConns.map(c => extractValueFromInput(c.source)))
                                .then(extractedValues => {
                                    const values = extractedValues.map((val, i) => 
                                        val || relatedConns[i].sourceName || relatedConns[i].source
                                    ).join(' ');
                                    
                                    const xmlPath = field.xml_path || field.path;
                                    const nodeName = xmlPath.split('/').pop();
                                    let code = `<${nodeName}>${values}</${nodeName}>`;
                                    
                                    // Add parent context
                                    const pathParts = xmlPath.split('/').filter(p => p);
                                    if (pathParts.length > 1) {
                                        const parentNode = pathParts[pathParts.length - 2];
                                        code = `<${parentNode}>\n  ${code}\n</${parentNode}>`;
                                    }
                                    
                                    console.log('Generated code (multiple):', code);
                                    
                                    setHoverPopup({
                                        type: 'output',
                                        code: code,
                                        field: field,
                                        connections: relatedConns,
                                        x: rect.left - 410,
                                        y: rect.top
                                    });
                                })
                                .catch(err => {
                                    console.error('Extraction failed:', err);
                                    setHoverPopup({
                                        type: 'output',
                                        code: `‚ùå Error: ${err.message}`,
                                        field: field,
                                        x: rect.left - 410,
                                        y: rect.top
                                    });
                                });
                            
                            // Exit early - popup updated by promise
                            
                        } else {
                            // No connection yet
                            const xmlPath = field.xml_path || field.path;
                            const nodeName = xmlPath.split('/').pop();
                            let code = `<${nodeName}>TO_BE_MAPPED</${nodeName}>`;
                            
                            // Add parent context if available
                            const pathParts = xmlPath.split('/').filter(p => p);
                            if (pathParts.length > 1) {
                                const parentNode = pathParts[pathParts.length - 2];
                                code = `<${parentNode}>\n  ${code}\n</${parentNode}>`;
                            }
                            
                            setHoverPopup({
                                type: 'output',
                                code: code,
                                field: field,
                                connections: relatedConns,
                                x: rect.left - 410,
                                y: rect.top
                            });
                        }
                    } else if (type === 'output' && !isConnected && outputExample) {
                        // OUTPUT NOT CONNECTED: Show structure from example
                        console.log('OUTPUT HOVER (NO CONNECTION) - Showing structure from example');
                        
                        const xmlPath = field.xml_path || field.path;
                        const nodeName = xmlPath.split('/').pop();
                        
                        // Try to extract structure from output example
                        const isXML = outputExample.trim().startsWith('<');
                        
                        if (isXML) {
                            // Extract this node from output example
                            try {
                                const regex = new RegExp(`<${nodeName}[^>]*>([\\s\\S]*?)<\\/${nodeName}>`, 'i');
                                const match = outputExample.match(regex);
                                
                                if (match) {
                                    let code = match[0];
                                    
                                    setHoverPopup({
                                        type: 'output',
                                        code: code,
                                        field: field,
                                        connections: [],
                                        x: rect.left - 410,
                                        y: rect.top
                                    });
                                } else {
                                    // No match in example, show placeholder
                                    let code = `<${nodeName}>TO_BE_MAPPED</${nodeName}>`;
                                    
                                    const pathParts = xmlPath.split('/').filter(p => p);
                                    if (pathParts.length > 1) {
                                        const parentNode = pathParts[pathParts.length - 2];
                                        code = `<${parentNode}>\n  ${code}\n</${parentNode}>`;
                                    }
                                    
                                    setHoverPopup({
                                        type: 'output',
                                        code: code,
                                        field: field,
                                        connections: [],
                                        x: rect.left - 410,
                                        y: rect.top
                                    });
                                }
                            } catch (err) {
                                console.error('Error extracting structure:', err);
                                // Fallback to simple placeholder
                                setHoverPopup({
                                    type: 'output',
                                    code: `<${nodeName}>STRUCTURE</${nodeName}>`,
                                    field: field,
                                    connections: [],
                                    x: rect.left - 410,
                                    y: rect.top
                                });
                            }
                        } else {
                            // Non-XML output, show simple placeholder
                            let code = `<${nodeName}>TO_BE_MAPPED</${nodeName}>`;
                            
                            setHoverPopup({
                                type: 'output',
                                code: code,
                                field: field,
                                connections: [],
                                x: rect.left - 410,
                                y: rect.top
                            });
                        }
                    }
                };
                
                // Show immediately on click, or after 2s on hover
                if (immediate) {
                    showPopupFn();
                } else {
                    hoverTimeoutRef.current = setTimeout(showPopupFn, 2000);
                }
            };
            
            const handleMouseLeave = () => {
                // Don't hide popup if it's pinned
                if (popupPinned) return;
                
                if (hoverTimeoutRef.current) {
                    clearTimeout(hoverTimeoutRef.current);
                }
                setHoverPopup(null);
            };
            
            const handleFieldClick = (e) => {
                // Single click: show popup immediately and pin it
                if (hoverTimeoutRef.current) {
                    clearTimeout(hoverTimeoutRef.current);
                }
                
                // Trigger the hover popup immediately
                handleMouseEnter(e, true); // Pass immediate=true
                setPopupPinned(true);
                updateFieldPositions();
            };
            
            // Check if this field is part of selected connection
            const isHighlighted = selectedConnection && (
                (selectedConnection.source === field.id) ||
                (selectedConnection.sources && selectedConnection.sources.includes(field.id)) ||
                (selectedConnection.target === field.id)
            );
            
            return React.createElement('div', {
                className: `field-box ${field.required ? 'required' : ''} ${field.calculation ? 'calculated' : ''} ${isDragging ? 'dragging' : ''} ${isDropTarget ? 'selected' : ''} ${isHighlighted ? 'highlighted' : ''}`,
                'data-field-id': `${type}-${field.id}`,
                draggable: true,
                onDragStart: (e) => {
                    setDraggedField({ field, type });
                    e.dataTransfer.effectAllowed = 'link';
                },
                onDragEnd: () => {
                    setDraggedField(null);
                    setDropTarget(null);
                },
                onDragOver: (e) => {
                    if (draggedField && draggedField.type !== type) {
                        e.preventDefault();
                        setDropTarget(field.id);
                    }
                },
                onDragLeave: () => {
                    setDropTarget(null);
                },
                onDrop: (e) => {
                    e.preventDefault();
                    handleDrop(field, type);
                },
                onClick: handleFieldClick,
                onMouseEnter: (e) => handleMouseEnter(e, false),
                onMouseLeave: handleMouseLeave
            },
                // Edit / Delete buttons (visible on hover)
                (onEditNode || onDeleteNode) && React.createElement('div', {
                    className: 'field-box-actions',
                    onClick: e => e.stopPropagation(),
                    onMouseDown: e => e.stopPropagation(),
                    draggable: false,
                    onDragStart: e => e.preventDefault()
                },
                    onEditNode && React.createElement('button', {
                        className: 'field-action-btn edit',
                        title: i18n.t('app.edit_node'),
                        onClick: (e) => { e.stopPropagation(); e.preventDefault(); onEditNode(field, type); }
                    }, '‚úèÔ∏è'),
                    onDeleteNode && React.createElement('button', {
                        className: 'field-action-btn delete',
                        title: i18n.t('app.delete_node'),
                        onClick: (e) => { e.stopPropagation(); e.preventDefault(); onDeleteNode(field, type); }
                    }, 'üóëÔ∏è')
                ),
                React.createElement('div', { className: 'field-name' },
                    isConnected && (type === 'input' ? '‚Üí ' : '‚Üê '),
                    field.name
                ),
                field.business_term && React.createElement('div', { className: 'field-business' },
                    field.business_term
                ),
                React.createElement('div', { className: 'field-meta' },
                    React.createElement('span', { className: 'field-badge', style: { background: '#e3f2fd' } }, field.type),
                    React.createElement('span', { className: 'field-badge', style: { background: '#f3e5f5' } }, field.cardinality),
                    field.calculation && React.createElement('span', { className: 'field-badge', style: { background: '#fff3cd' } }, 'üìê ' + field.calculation.substring(0, 15)),
                    field.offset && React.createElement('span', { className: 'field-badge', style: { background: '#e8f5e9' } }, 'üìç ' + field.offset),
                    field.length && React.createElement('span', { className: 'field-badge', style: { background: '#fce4ec' } }, 'üìè ' + field.length),
                    field.xml_path && React.createElement('span', { className: 'field-badge', style: { background: '#fff9c4', fontSize: '9px' }, title: field.xml_path }, 'üåê ' + field.xml_path.substring(field.xml_path.lastIndexOf('/') + 1))
                )
            );
        }
        
        function ConnectionsSVG({ connections, fieldPositions, selectedConnection, setSelectedConnection }) {
            if (connections.length === 0) return null;
            
            return React.createElement('svg', { className: 'connections' },
                connections.map(conn => {
                    // Handle both single source and multiple sources (for CONCAT)
                    const sourceId = conn.source || (conn.sources && conn.sources[0]);
                    const targetId = conn.target;
                    
                    if (!sourceId || !targetId) return null;
                    
                    const sourcePos = fieldPositions[`input-${sourceId.replace(/\./g, '_')}`];
                    const targetPos = fieldPositions[`output-${targetId.replace(/\./g, '_')}`];
                    
                    if (!sourcePos || !targetPos) return null;
                    
                    const isSelected = selectedConnection?.id === conn.id;
                    const pathD = `M ${sourcePos.x} ${sourcePos.y} C ${sourcePos.x + 20} ${sourcePos.y}, ${targetPos.x - 20} ${targetPos.y}, ${targetPos.x} ${targetPos.y}`;
                    
                    return React.createElement('g', { key: conn.id },
                        React.createElement('path', {
                            d: pathD,
                            className: `connection-line ${isSelected ? 'selected' : ''}`,
                            onClick: (e) => {
                                e.stopPropagation();
                                setSelectedConnection(conn);
                            },
                            onDoubleClick: (e) => {
                                e.stopPropagation();
                                if (confirm(`Eliminare collegamento ${conn.sourceName} ‚Üí ${conn.targetName}?`)) {
                                    setSelectedConnection(null);
                                    // Trigger delete (pass to parent)
                                    window.deleteConnectionCallback?.(conn.id);
                                }
                            },
                            style: { cursor: 'pointer' }
                        }),
                        React.createElement('polygon', {
                            className: 'connection-arrow',
                            points: `${targetPos.x},${targetPos.y} ${targetPos.x-10},${targetPos.y-5} ${targetPos.x-10},${targetPos.y+5}`,
                            style: { fill: isSelected ? '#f44336' : '#00BCD4', cursor: 'pointer' },
                            onDoubleClick: (e) => {
                                e.stopPropagation();
                                if (confirm(`Eliminare collegamento ${conn.sourceName} ‚Üí ${conn.targetName}?`)) {
                                    setSelectedConnection(null);
                                    window.deleteConnectionCallback?.(conn.id);
                                }
                            }
                        })
                    );
                })
            );
        }
        
        // ===================================================
        // NODE IMPORT MODAL
        // ===================================================
        function NodeImportModal({ direction, schemaType, onClose, onImport }) {
            const [file, setFile] = useState(null);
            const [fileType, setFileType] = useState('csv');
            const [isDragging, setIsDragging] = useState(false);
            const [preview, setPreview] = useState(null);
            const [error, setError] = useState('');
            const fileInputRef = useRef(null);

            const isXML = schemaType === 'xml' || schemaType === 'xsd';

            const parseCSV = (text) => {
                const lines = text.trim().split('\n').filter(l => l.trim());
                if (lines.length < 2) throw new Error('CSV must have header + at least one row');
                const headers = lines[0].split(',').map(h => h.replace(/"/g,'').trim());
                return lines.slice(1).map(line => {
                    const vals = line.split(',').map(v => v.replace(/"/g,'').trim());
                    const obj = {};
                    headers.forEach((h, i) => obj[h] = vals[i] || '');
                    return obj;
                });
            };

            const parseJSON = (text) => {
                const data = JSON.parse(text);
                if (Array.isArray(data)) return data;
                if (data.fields) return Array.isArray(data.fields) ? data.fields : Object.values(data.fields);
                return [data];
            };

            const handleFileSelect = async (selectedFile) => {
                setFile(selectedFile);
                setError('');
                setPreview(null);
                try {
                    const text = await selectedFile.text();
                    let rows;
                    const ext = selectedFile.name.split('.').pop().toLowerCase();
                    if (ext === 'json') {
                        rows = parseJSON(text);
                        setFileType('json');
                    } else {
                        rows = parseCSV(text);
                        setFileType('csv');
                    }
                    setPreview(rows.slice(0, 5));
                } catch(e) {
                    setError('Parse error: ' + e.message);
                }
            };

            const handleImport = async () => {
                if (!file) return;
                try {
                    const text = await file.text();
                    let rows;
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (ext === 'json') {
                        rows = parseJSON(text);
                    } else {
                        rows = parseCSV(text);
                    }
                    onImport(rows, direction);
                    onClose();
                } catch(e) {
                    setError('Import error: ' + e.message);
                }
            };

            return React.createElement('div', { className: 'modal-overlay', onClick: onClose },
                React.createElement('div', {
                    className: 'node-import-modal',
                    onClick: e => e.stopPropagation()
                },
                    // Header
                    React.createElement('div', {
                        style: {
                            padding: '18px 20px',
                            background: 'linear-gradient(135deg, #00BCD4 0%, #3F51B5 100%)',
                            color: 'white',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }
                    },
                        React.createElement('h3', null,
                            `üì• Importa Nodi Aggiuntivi ‚Äî ${direction.toUpperCase()}`
                        ),
                        React.createElement('button', {
                            onClick: onClose,
                            style: { background: 'none', border: 'none', color: 'white', fontSize: '20px', cursor: 'pointer' }
                        }, '√ó')
                    ),



                    // Body
                    React.createElement('div', { style: { padding: '20px', overflowY: 'auto', flex: 1 } },
                        React.createElement('p', { style: { fontSize: '13px', color: '#555', marginBottom: '16px' } },
                            'Carica un file CSV o JSON con la stessa struttura dello schema corrente. I nodi importati appariranno come un pacchetto trascinabile da posizionare nello schema XML.'
                        ),

                        // Drop area
                        React.createElement('div', {
                            style: {
                                border: isDragging ? '3px dashed #00BCD4' : '2px dashed #ccc',
                                borderRadius: '8px',
                                padding: '24px',
                                textAlign: 'center',
                                background: isDragging ? '#e0f7fa' : '#fafafa',
                                cursor: 'pointer',
                                marginBottom: '16px',
                                transition: 'all 0.2s'
                            },
                            onClick: () => fileInputRef.current?.click(),
                            onDragOver: e => { e.preventDefault(); setIsDragging(true); },
                            onDragLeave: () => setIsDragging(false),
                            onDrop: e => {
                                e.preventDefault();
                                setIsDragging(false);
                                const f = e.dataTransfer.files[0];
                                if (f) handleFileSelect(f);
                            }
                        },
                            file
                                ? React.createElement('div', null,
                                    React.createElement('div', { style: { fontSize: '36px' } }, '‚úÖ'),
                                    React.createElement('div', { style: { fontWeight: 'bold', marginTop: '6px' } }, file.name)
                                )
                                : React.createElement('div', null,
                                    React.createElement('div', { style: { fontSize: '36px' } }, isDragging ? 'üìÇ' : 'üìÅ'),
                                    React.createElement('div', { style: { marginTop: '8px', color: '#666' } }, i18n.t('app.drop_file'))
                                ),
                            React.createElement('input', {
                                ref: fileInputRef,
                                type: 'file',
                                style: { display: 'none' },
                                accept: '.csv,.json',
                                onChange: e => e.target.files[0] && handleFileSelect(e.target.files[0])
                            })
                        ),

                        // Error
                        error && React.createElement('div', {
                            style: { color: '#f44336', fontSize: '13px', marginBottom: '12px', padding: '8px', background: '#ffebee', borderRadius: '4px' }
                        }, error),

                        // Preview
                        preview && preview.length > 0 && React.createElement('div', { style: { marginBottom: '16px' } },
                            React.createElement('div', {
                                style: { fontWeight: '600', fontSize: '13px', marginBottom: '8px', color: '#333' }
                            }, `Anteprima (${preview.length} su ${preview.length} righe):`)  ,
                            React.createElement('div', {
                                style: { overflowX: 'auto', border: '1px solid #ddd', borderRadius: '6px', fontSize: '11px' }
                            },
                                React.createElement('table', { style: { width: '100%', borderCollapse: 'collapse' } },
                                    React.createElement('thead', null,
                                        React.createElement('tr', { style: { background: '#f5f5f5' } },
                                            Object.keys(preview[0]).slice(0,6).map(k =>
                                                React.createElement('th', {
                                                    key: k,
                                                    style: { padding: '6px 8px', borderBottom: '1px solid #ddd', textAlign: 'left', whiteSpace: 'nowrap' }
                                                }, k)
                                            )
                                        )
                                    ),
                                    React.createElement('tbody', null,
                                        preview.map((row, i) =>
                                            React.createElement('tr', { key: i, style: { borderBottom: '1px solid #f0f0f0' } },
                                                Object.values(row).slice(0,6).map((v, j) =>
                                                    React.createElement('td', {
                                                        key: j,
                                                        style: { padding: '5px 8px', maxWidth: '100px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }
                                                    }, String(v))
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),

                    // Footer
                    React.createElement('div', {
                        style: { padding: '14px 20px', borderTop: '1px solid #eee', display: 'flex', gap: '10px', justifyContent: 'flex-end' }
                    },
                        React.createElement('button', { className: 'btn btn-secondary', onClick: onClose }, i18n.t('common.cancel')),
                        React.createElement('button', {
                            className: 'btn btn-primary',
                            onClick: handleImport,
                            disabled: !file || !!error
                        }, i18n.t('app.import_package'))
                    )
                )
            );
        }

        // ===================================================
        // NODE BUNDLE (draggable package of nodes)
        // ===================================================
        function NodeBundle({ bundle, onDrop, onDismiss }) {
            const [pos, setPos] = useState({ x: 80, y: 200 });
            const [dragging, setDragging] = useState(false);
            const [dropZoneActive, setDropZoneActive] = useState(false);
            const dragOffset = useRef({ x: 0, y: 0 });
            const bundleRef = useRef(null);

            const handleMouseDown = (e) => {
                e.preventDefault();
                setDragging(true);
                dragOffset.current = {
                    x: e.clientX - pos.x,
                    y: e.clientY - pos.y
                };

                const onMove = (me) => {
                    setPos({ x: me.clientX - dragOffset.current.x, y: me.clientY - dragOffset.current.y });

                    // Check if hovering over a field-box
                    const els = document.elementsFromPoint(me.clientX, me.clientY);
                    const onField = els.some(el => el.classList.contains('field-box'));
                    setDropZoneActive(onField);
                };

                const onUp = (ue) => {
                    setDragging(false);
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);

                    // Check drop target
                    const els = document.elementsFromPoint(ue.clientX, ue.clientY);
                    const fieldEl = els.find(el => el.classList.contains('field-box') && el.dataset.fieldId);
                    if (fieldEl) {
                        const fieldId = fieldEl.dataset.fieldId;
                        const colType = fieldId.startsWith('input-') ? 'input' : 'output';
                        onDrop(bundle, fieldId, colType);
                    }
                };

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            };

            return React.createElement('div', {
                ref: bundleRef,
                className: 'node-bundle',
                style: {
                    left: pos.x + 'px',
                    top: pos.y + 'px',
                    outline: dropZoneActive ? '2px solid #4caf50' : 'none',
                    background: dropZoneActive ? '#e8f5e9' : 'white'
                },
                onMouseDown: handleMouseDown
            },
                React.createElement('div', { className: 'node-bundle-title' },
                    'üì¶ Pacchetto',
                    React.createElement('span', { className: 'node-bundle-count' }, bundle.nodes.length + ' nodi'),
                    React.createElement('span', {
                        style: { marginLeft: 'auto', cursor: 'pointer', color: '#999', fontSize: '16px', fontWeight: 'normal' },
                        onClick: (e) => { e.stopPropagation(); onDismiss(bundle.id); }
                    }, '√ó')
                ),
                React.createElement('ul', { className: 'node-bundle-list' },
                    bundle.nodes.slice(0, 6).map((n, i) =>
                        React.createElement('li', { key: i }, n.name || n.field_name || n.Field_Name || Object.values(n)[0])
                    ),
                    bundle.nodes.length > 6 && React.createElement('li', { key: 'more', style: { color: '#999', fontStyle: 'italic' } },
                        `... e altri ${bundle.nodes.length - 6}`
                    )
                ),
                React.createElement('div', { className: 'node-bundle-drop-hint' },
                    dropZoneActive ? '‚úÖ Rilascia qui per inserire dopo questo nodo' : '‚òùÔ∏è Trascina su un nodo per inserirlo dopo'
                )
            );
        }

        // ===================================================
        // FIELD CONTEXT MENU
        // ===================================================
        function FieldContextMenu({ x, y, field, colType, onEdit, onDelete, onClose }) {
            useEffect(() => {
                // Use mousedown on capture so we catch clicks outside AFTER the menu has rendered
                const handler = (e) => {
                    // If click is not inside context menu, close
                    const menu = document.querySelector('.field-context-menu');
                    if (menu && !menu.contains(e.target)) {
                        onClose();
                    }
                };
                // Delay adding listener so the right-click event that opened the menu doesn't immediately close it
                const t = setTimeout(() => {
                    document.addEventListener('mousedown', handler);
                }, 100);
                return () => {
                    clearTimeout(t);
                    document.removeEventListener('mousedown', handler);
                };
            }, []);

            // Adjust position so menu doesn't go off screen
            const menuStyle = {
                left: Math.min(x, window.innerWidth - 180) + 'px',
                top: Math.min(y, window.innerHeight - 100) + 'px'
            };

            return React.createElement('div', {
                className: 'field-context-menu',
                style: menuStyle,
                onMouseDown: e => e.stopPropagation()
            },
                React.createElement('div', {
                    className: 'field-context-menu-item',
                    onMouseDown: (e) => {
                        e.stopPropagation();
                        onClose();
                        setTimeout(() => onEdit(field, colType), 0);
                    }
                }, React.createElement('span', null, '‚úèÔ∏è'), ' '+i18n.t('app.edit_node')),
                React.createElement('div', { className: 'field-context-menu-separator' }),
                React.createElement('div', {
                    className: 'field-context-menu-item danger',
                    onMouseDown: (e) => {
                        e.stopPropagation();
                        onClose();
                        setTimeout(() => onDelete(field, colType), 0);
                    }
                }, React.createElement('span', null, 'üóëÔ∏è'), ' '+i18n.t('app.delete_node'))
            );
        }

        // ===================================================
        // NODE EDIT MODAL
        // ===================================================
        function NodeEditModal({ field, colType, onSave, onClose }) {
            const [form, setForm] = useState({
                name: field.name || '',
                type: field.type || 'string',
                cardinality: field.cardinality || '0..1',
                business_term: field.business_term || '',
                description: field.description || '',
                required: field.required || false
            });

            const set = (k, v) => setForm(f => ({ ...f, [k]: v }));

            return React.createElement('div', { className: 'modal-overlay', onClick: onClose },
                React.createElement('div', {
                    className: 'node-edit-modal',
                    onClick: e => e.stopPropagation(),
                    style: { padding: '0' }
                },
                    // Header
                    React.createElement('div', {
                        style: {
                            padding: '16px 20px',
                            background: 'linear-gradient(135deg, #00BCD4 0%, #3F51B5 100%)',
                            color: 'white',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            borderRadius: '12px 12px 0 0'
                        }
                    },
                        React.createElement('h3', null, `‚úèÔ∏è Modifica Nodo ‚Äî ${field.name}`),
                        React.createElement('button', {
                            onClick: onClose,
                            style: { background: 'none', border: 'none', color: 'white', fontSize: '20px', cursor: 'pointer' }
                        }, '√ó')
                    ),
                    // Body
                    React.createElement('div', { style: { padding: '20px' } },
                        [
                            ['Nome campo', 'name', 'text'],
                            ['Tipo dati', 'type', 'select', ['string', 'integer', 'decimal', 'boolean', 'date', 'datetime', 'element']],
                            ['Cardinalit√†', 'cardinality', 'select', ['0..1', '1..1', '0..n', '1..n']],
                            ['Business Term', 'business_term', 'text'],
                            ['Descrizione', 'description', 'text']
                        ].map(([label, key, inputType, opts]) =>
                            React.createElement('div', { key: key, className: 'form-group', style: { marginBottom: '14px' } },
                                React.createElement('label', { style: { display: 'block', fontWeight: '600', fontSize: '13px', marginBottom: '5px' } }, label),
                                inputType === 'select'
                                    ? React.createElement('select', {
                                        value: form[key],
                                        onChange: e => set(key, e.target.value),
                                        style: { width: '100%' }
                                    },
                                        opts.map(o => React.createElement('option', { key: o, value: o }, o))
                                    )
                                    : React.createElement('input', {
                                        type: 'text',
                                        value: form[key],
                                        onChange: e => set(key, e.target.value),
                                        style: { width: '100%' }
                                    })
                            )
                        ),
                        React.createElement('label', { style: { display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' } },
                            React.createElement('input', {
                                type: 'checkbox',
                                checked: form.required,
                                onChange: e => set('required', e.target.checked)
                            }),
                            React.createElement('span', { style: { fontWeight: '600', fontSize: '13px' } }, i18n.t('app.required_field'))
                        )
                    ),
                    // Footer
                    React.createElement('div', {
                        style: { padding: '14px 20px', borderTop: '1px solid #eee', display: 'flex', gap: '10px', justifyContent: 'flex-end' }
                    },
                        React.createElement('button', { className: 'btn btn-secondary', onClick: onClose }, i18n.t('common.cancel')),
                        React.createElement('button', {
                            className: 'btn btn-success',
                            onClick: () => { onSave({ ...field, ...form }, colType); onClose(); }
                        }, i18n.t('app.save'))
                    )
                )
            );
        }

        function ConnectionsList({ connections, selectedConnection, setSelectedConnection }) {
            if (connections.length === 0) {
                return React.createElement('div', { className: 'empty-state' },
                    React.createElement('p', null, i18n.t('app.no_connections')),
                    React.createElement('small', null, i18n.t('app.drag_hint'))
                );
            }
            
            return React.createElement('div', null,
                connections.map(conn =>
                    React.createElement('div', {
                        key: conn.id,
                        className: `connection-list-item ${selectedConnection?.id === conn.id ? 'selected' : ''}`,
                        onClick: () => setSelectedConnection(conn)
                    },
                        React.createElement('div', { style: { fontSize: '11px', color: '#4caf50', fontWeight: 'bold' } },
                            'üì• ' + conn.source
                        ),
                        React.createElement('div', { style: { fontSize: '11px', color: '#2196f3', fontWeight: 'bold', marginTop: '4px' } },
                            'üì§ ' + conn.target
                        ),
                        React.createElement('div', { style: { fontSize: '10px', color: '#666', marginTop: '4px' } },
                            '‚öôÔ∏è ' + conn.transformation.type
                        )
                    )
                )
            );
        }
        
        function FormulaParamsPanel({ transType, params, onChange }) {
            // Helper: generic text input row
            const row = (label, key, placeholder, type='text') =>
                React.createElement('div', { className: 'form-group', key: key },
                    React.createElement('label', null, label),
                    React.createElement('input', {
                        type,
                        value: params[key] || '',
                        placeholder,
                        onChange: e => onChange({ ...params, [key]: e.target.value })
                    })
                );

            const select = (label, key, options) =>
                React.createElement('div', { className: 'form-group', key: key },
                    React.createElement('label', null, label),
                    React.createElement('select', {
                        value: params[key] || options[0].value,
                        onChange: e => onChange({ ...params, [key]: e.target.value })
                    }, options.map(o => React.createElement('option', { key: o.value, value: o.value }, o.label)))
                );

            const hint = (text) =>
                React.createElement('div', { style: { fontSize: '11px', color: '#888', background: '#f9f9f9', padding: '8px 10px', borderRadius: '4px', marginBottom: '8px' } }, text);

            const t = (transType || '').toUpperCase();

            if (t === 'DIRECT') return React.createElement('div', { style: { fontSize: '12px', color: '#888', padding: '8px 0' } }, i18n.t('app.no_params'))√®.');

            if (t === 'CONCAT') return React.createElement('div', null,
                hint('Unisce pi√π valori. Trascina pi√π campi sorgente sulla stessa destinazione per abilitare il multi-source.'),
                row('Separatore', 'separator', 'es: " " oppure "-" oppure ""')
            );

            if (t === 'SPLIT') return React.createElement('div', null,
                hint('Estrae una parte da una stringa usando un delimitatore o regex.'),
                row('Delimitatore', 'delimiter', 'es: "/" oppure "-" oppure " "'),
                row('Indice parte (0=prima)', 'index', '0', 'number'),
                row('Oppure: Regex (avanzato)', 'regex', 'es: (\\d{4})-(\\d{2})'),
                row('Gruppo regex', 'group', '1', 'number')
            );

            if (t === 'DATE_FORMAT') return React.createElement('div', null,
                hint('Converte il formato data. Usa strftime: %Y=anno, %m=mese, %d=giorno, %H=ora, %M=minuti.'),
                row('Formato input', 'from_format', 'es: %Y%m%d oppure %d/%m/%Y'),
                row('Formato output', 'to_format', 'es: %Y-%m-%d oppure %d.%m.%Y')
            );

            if (t === 'MATH') return React.createElement('div', null,
                hint('Operazione aritmetica sul valore numerico del campo sorgente.'),
                select('Operazione', 'operation', [
                    { value: 'add',       label: '+ Addizione' },
                    { value: 'subtract',  label: '- Sottrazione' },
                    { value: 'multiply',  label: '√ó Moltiplicazione' },
                    { value: 'divide',    label: '√∑ Divisione' },
                    { value: 'round',     label: '‚âà Arrotonda' },
                    { value: 'abs',       label: '| | Valore assoluto' },
                    { value: 'negate',    label: '‚àí Negazione' },
                ]),
                row('Operando (es: 100)', 'operand', '100', 'number'),
                row('Decimali (solo per round)', 'decimals', '2', 'number')
            );

            if (t === 'LOOKUP') return React.createElement('div', null,
                hint('Traduce codici tramite una tabella. Inserisci il JSON della tabella sotto.'),
                React.createElement('div', { className: 'form-group' },
                    React.createElement('label', null, 'Tabella (JSON)'),
                    React.createElement('textarea', {
                        style: { width: '100%', minHeight: '90px', fontFamily: 'monospace', fontSize: '12px', padding: '8px', border: '1px solid #ddd', borderRadius: '4px', resize: 'vertical' },
                        value: params.table_raw || (params.table ? JSON.stringify(params.table, null, 2) : ''),
                        placeholder: '{"IT": "380", "DE": "380", "FR": "380"}',
                        onChange: e => {
                            try { onChange({ ...params, table: JSON.parse(e.target.value), table_raw: e.target.value }); }
                            catch(_) { onChange({ ...params, table_raw: e.target.value }); }
                        }
                    })
                ),
                row('Valore default se non trovato', 'default', 'es: 380')
            );

            if (t === 'CONDITIONAL') return React.createElement('div', null,
                hint('Condizioni if/then. Inserisci le regole come JSON array.'),
                React.createElement('div', { className: 'form-group' },
                    React.createElement('label', null, i18n.t('app.conditions_json')),
                    React.createElement('textarea', {
                        style: { width: '100%', minHeight: '110px', fontFamily: 'monospace', fontSize: '12px', padding: '8px', border: '1px solid #ddd', borderRadius: '4px', resize: 'vertical' },
                        value: params.conditions_raw || (params.conditions ? JSON.stringify(params.conditions, null, 2) : ''),
                        placeholder: '[{"if": {"equals": "RE"}, "then": "381"}]',
                        onChange: e => {
                            try { onChange({ ...params, conditions: JSON.parse(e.target.value), conditions_raw: e.target.value }); }
                            catch(_) { onChange({ ...params, conditions_raw: e.target.value }); }
                        }
                    })
                ),
                row('Valore default (nessuna condizione)', 'default', 'es: 380')
            );

            if (t === 'STRING_OP') {
                const op = params.operation || 'upper';
                const extraFields = [];
                if (op === 'replace')       { extraFields.push(row('Trova', 'find', 'es: .')); extraFields.push(row('Sostituisci con', 'replace_with', 'es: ,')); }
                if (op === 'substring')     { extraFields.push(row('Inizio (0-based)', 'start', '0', 'number')); extraFields.push(row('Fine (escluso)', 'end', '8', 'number')); }
                if (op === 'pad_left' || op === 'pad_right') { extraFields.push(row('Larghezza totale', 'width', '10', 'number')); extraFields.push(row('Carattere riempimento', 'char', '0')); }
                if (op === 'remove_prefix') extraFields.push(row('Prefisso da rimuovere', 'prefix', 'es: IT'));
                if (op === 'remove_suffix') extraFields.push(row('Suffisso da rimuovere', 'suffix', 'es: .xml'));
                if (op === 'regex_replace') { extraFields.push(row('Pattern regex', 'pattern', 'es: [^0-9]')); extraFields.push(row('Sostituisci con', 'repl', '')); }
                return React.createElement('div', null,
                    hint('Operazione sulla stringa.'),
                    select('Operazione', 'operation', [
                        { value: 'upper',          label: 'MAIUSCOLO' },
                        { value: 'lower',          label: 'minuscolo' },
                        { value: 'trim',           label: 'Rimuovi spazi' },
                        { value: 'replace',        label: 'Sostituisci' },
                        { value: 'substring',      label: 'Sottostringa' },
                        { value: 'pad_left',       label: 'Riempi a sinistra' },
                        { value: 'pad_right',      label: 'Riempi a destra' },
                        { value: 'remove_prefix',  label: 'Rimuovi prefisso' },
                        { value: 'remove_suffix',  label: 'Rimuovi suffisso' },
                        { value: 'regex_replace',  label: 'Regex replace' },
                    ]),
                    ...extraFields
                );
            }

            if (t === 'DEFAULT') return React.createElement('div', null,
                hint('Usa questo valore se il campo sorgente √® vuoto o null.'),
                row('Valore di default', 'value', 'es: EUR oppure 380')
            );

            if (t === 'HARDCODE') return React.createElement('div', null,
                hint('Ignora il valore sorgente e inserisce sempre questo valore fisso.'),
                row('Valore fisso', 'value', 'es: EUR oppure 380 oppure IT')
            );

            if (t === 'COALESCE') return React.createElement('div', null,
                hint('Prende il primo valore non vuoto tra i campi elencati (separati da virgola).'),
                row('Campi alternativi (separati da ,)', 'fields_raw', 'es: VAT_ID, TAX_ID, FISCAL_CODE')
            );

            if (t === 'SUM_MULTI') return React.createElement('div', null,
                hint('Somma numericamente pi√π campi sorgente. Usa multi-source per selezionare i campi.'),
                row('Decimali', 'decimals', '2', 'number')
            );

            if (t === 'CUSTOM') return React.createElement('div', { style: { fontSize: '12px', color: '#888', padding: '8px 0' } },
                '‚úèÔ∏è Clicca "Apri Editor Avanzato" per scrivere l\'espressione Python.'
            );

            return React.createElement('div', { style: { fontSize: '12px', color: '#888', padding: '8px 0' } },
                'Seleziona una formula per vedere i parametri.'
            );
        }

        function PropertiesPanel({ connection, updateConnectionTransformation, deleteConnection, setSelectedConnection, setShowFormulaEditor, setEditingConnection, availableFormulas }) {
            const [transType, setTransType] = useState(connection.transformation?.type || 'direct');
            const [params, setParams] = useState(connection.transformation?.params || {});

            const saveParams = (newParams) => {
                setParams(newParams);
                updateConnectionTransformation(connection.id, { type: transType, params: newParams });
            };

            const handleTypeChange = (newType) => {
                setTransType(newType);
                setParams({});
                updateConnectionTransformation(connection.id, { type: newType, params: {} });
            };

            const sectionStyle = { background: '#f5f9ff', border: '1px solid #e3eaf5', borderRadius: '6px', padding: '12px 14px', marginTop: '12px' };
            const sectionLabel = { fontSize: '11px', fontWeight: '700', color: '#29D6EC', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '10px' };

            // Build formula options
            const STATIC_FORMULAS = [
                { id: 'direct',      label: '‚Üí Direct (1:1)' },
                { id: 'custom',      label: '‚úèÔ∏è Custom Formula' },
                { id: 'concat',      label: 'üîó Concatenate' },
                { id: 'split',       label: '‚úÇÔ∏è Split' },
                { id: 'date_format', label: 'üìÖ Date Format' },
                { id: 'math',        label: 'üî¢ Math' },
                { id: 'lookup',      label: 'üìä Lookup Table' },
                { id: 'conditional', label: 'üîÄ Conditional' },
                { id: 'string_op',   label: 'üî§ String Operation' },
                { id: 'default',     label: 'üîÅ Default Value' },
                { id: 'hardcode',    label: 'üìå Hardcode' },
                { id: 'coalesce',    label: 'üîç Coalesce' },
                { id: 'sum_multi',   label: '‚ûï Sum Multi' },
            ];
            const formulaOptions = (availableFormulas && availableFormulas.length > 0)
                ? [{ id: 'direct', label: '‚Üí Direct (1:1)' }, { id: 'custom', label: '‚úèÔ∏è Custom Formula' },
                   ...availableFormulas.filter(f => !['DIRECT','NOOP'].includes(f.id)).map(f => ({ id: f.id.toLowerCase(), label: f.label }))]
                : STATIC_FORMULAS;

            return React.createElement('div', { className: 'properties-panel' },
                React.createElement('h3', { style: { marginBottom: '16px' } }, i18n.t('app.conn_properties'))),

                // Source / Target
                React.createElement('div', { className: 'form-group' },
                    React.createElement('label', null, 'Source:'),
                    React.createElement('input', { type: 'text', value: connection.sourceName || connection.source, readOnly: true, style: { background: '#f5f5f5', color: '#4caf50', fontWeight: 'bold' } })
                ),
                React.createElement('div', { className: 'form-group' },
                    React.createElement('label', null, 'Target:'),
                    React.createElement('input', { type: 'text', value: connection.targetName || connection.target, readOnly: true, style: { background: '#f5f5f5', color: '#2196f3', fontWeight: 'bold' } })
                ),

                // Formula selector
                React.createElement('div', { className: 'form-group' },
                    React.createElement('label', null, i18n.t('app.transformation')),
                    React.createElement('select', {
                        value: transType,
                        onChange: e => handleTypeChange(e.target.value),
                        style: { fontWeight: '600' }
                    }, formulaOptions.map(f => React.createElement('option', { key: f.id, value: f.id }, f.label)))
                ),

                // Params panel
                transType !== 'direct' && React.createElement('div', { style: sectionStyle },
                    React.createElement('div', { style: sectionLabel }, i18n.t('app.parameters')),
                    React.createElement(FormulaParamsPanel, { transType, params, onChange: saveParams })
                ),

                // Custom formula button
                (transType === 'custom' || transType === 'CUSTOM') && React.createElement('button', {
                    className: 'btn btn-primary',
                    style: { width: '100%', marginTop: '12px' },
                    onClick: () => { setEditingConnection(connection); setShowFormulaEditor(true); }
                }, i18n.t('app.open_editor')),

                // Delete / Close
                React.createElement('div', { style: { display: 'flex', gap: '10px', marginTop: '24px' } },
                    React.createElement('button', { className: 'btn btn-danger', style: { flex: 1 }, onClick: () => deleteConnection(connection.id) }, i18n.t('app.delete'))),
                    React.createElement('button', { className: 'btn btn-secondary', style: { flex: 1 }, onClick: () => setSelectedConnection(null) }, i18n.t('app.close')))
                )
            );
        }
        
        function UploadModal({ direction, onClose, onUpload }) {
            const [file, setFile] = useState(null);
            const [type, setType] = useState('csv');
            const [isDragging, setIsDragging] = useState(false);
            const fileInputRef = useRef(null);
            
            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(true);
            };
            
            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
                
                const droppedFile = e.dataTransfer.files[0];
                if (droppedFile) {
                    setFile(droppedFile);
                }
            };
            
            return React.createElement('div', { className: 'modal-overlay', onClick: onClose },
                React.createElement('div', { className: 'modal', onClick: (e) => e.stopPropagation() },
                    React.createElement('h3', { style: { marginBottom: '20px' } }, `Upload ${direction} Schema`),
                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', null, 'Schema Type:'),
                        React.createElement('select', {
                            value: type,
                            onChange: (e) => setType(e.target.value)
                        },
                            React.createElement('option', { value: 'csv' }, i18n.t('app.csv_recommended'))),
                            React.createElement('option', { value: 'xsd' }, i18n.t('app.xsd'))),
                            React.createElement('option', { value: 'idoc' }, i18n.t('app.idoc')))
                        )
                    ),
                    React.createElement('div', {
                        className: 'upload-area',
                        onClick: () => fileInputRef.current?.click(),
                        onDragOver: handleDragOver,
                        onDragLeave: handleDragLeave,
                        onDrop: handleDrop,
                        style: {
                            border: isDragging ? '3px dashed #00BCD4' : '2px dashed #ddd',
                            background: isDragging ? '#f0f4ff' : 'transparent'
                        }
                    },
                        file ? React.createElement('div', null,
                            React.createElement('div', { style: { fontSize: '48px' } }, '‚úÖ'),
                            React.createElement('div', { style: { fontWeight: 'bold' } }, file.name)
                        ) : React.createElement('div', null,
                            React.createElement('div', { style: { fontSize: '64px' } }, isDragging ? 'üìÇ' : 'üìÅ'),
                            React.createElement('div', null, isDragging ? 'Drop file here' : 'Click or drag file here')
                        ),
                        React.createElement('input', {
                            ref: fileInputRef,
                            type: 'file',
                            style: { display: 'none' },
                            onChange: (e) => setFile(e.target.files[0]),
                            accept: '.csv,.xsd,.json,.xml,.txt'
                        })
                    ),
                    React.createElement('div', { style: { display: 'flex', gap: '10px', marginTop: '20px', justifyContent: 'flex-end' } },
                        React.createElement('button', { className: 'btn btn-secondary', onClick: onClose }, i18n.t('app.cancel'))),
                        React.createElement('button', {
                            className: 'btn btn-primary',
                            onClick: () => file && onUpload(file, direction, type),
                            disabled: !file
                        }, i18n.t('workspace.upload')))
                    )
                )
            );
        }
        
        // Init i18n before rendering
        i18n.init().then(() => {
            // Create lang switcher helper
            window.T = (key, rep) => i18n.t(key, rep);
            // langchange listener for re-render
            window.addEventListener('langchange', () => {
                // Force React re-render by dispatching state change
                if (window.__buddylikoForceUpdate) window.__buddylikoForceUpdate();
            });
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
        // Create lang switcher after React renders
        setTimeout(() => {
            const el = document.getElementById('app-lang-switcher');
            if (el) i18n.createSwitcher('app-lang-switcher');
        }, 100);
        }); // end i18n.init()
    </script>
<script src="/assets/theme.js"></script>
</body>
</html>
