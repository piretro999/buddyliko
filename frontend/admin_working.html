<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Buddyliko</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32.png">
    <script src="/lang/i18n.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui; background: #0a0e1a; color: #e2e8f0; }
        /* Unified topbar (same as workspace) */
        .topbar { background:linear-gradient(135deg,#0d1220,#141b2d); border-bottom:1px solid #2e3250; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
        .topbar-left { display:flex; align-items:center; gap:16px; }
        .topbar-left h1 { font-size:18px; font-weight:600; color:#e2e8f0; }
        .topbar-left .logo { width:28px; height:28px; }
        .topbar-nav { display:flex; gap:6px; }
        .topbar-nav a { padding:6px 14px; border-radius:6px; text-decoration:none; font-size:13px; color:#94a3b8; transition:all .15s; }
        .topbar-nav a:hover { background:#1e2235; color:#e2e8f0; }
        .topbar-nav a.active { background:#1e3a5f; color:#93c5fd; }
        .topbar-right { display:flex; align-items:center; gap:12px; }
        .topbar-right .user-info { font-size:12px; color:#94a3b8; }
        .topbar-right .btn-logout { background:transparent; border:1px solid #2e3250; color:#94a3b8; padding:6px 14px; border-radius:6px; cursor:pointer; font-size:12px; transition:all .15s; }
        .topbar-right .btn-logout:hover { border-color:#ef4444; color:#f87171; }
        .container { max-width: 1400px; margin: 0 auto; padding: 24px 20px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 28px; }
        .stat-card { background: #141b2d; padding: 20px; border-radius: 12px; border: 1px solid #2e3250; }
        .stat-value { font-size: 32px; font-weight: bold; color: #60a5fa; }
        .stat-label { color: #94a3b8; font-size: 13px; margin-top: 5px; }
        .section { background: #141b2d; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #2e3250; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #e2e8f0; display: flex; align-items: center; gap: 8px; }
        .section-title .count { background: #1e3a5f; color: #60a5fa; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #0d1220; padding: 10px 12px; text-align: left; font-weight: 600; font-size: 12px; color: #94a3b8; border-bottom: 1px solid #2e3250; }
        td { padding: 12px; border-bottom: 1px solid #1e2235; font-size: 13px; vertical-align: middle; color: #e2e8f0; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #0f172a; }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-approved, .badge-APPROVED { background: rgba(46,125,50,.2); color: #4ade80; }
        .badge-pending, .badge-PENDING { background: rgba(230,81,0,.2); color: #fb923c; }
        .badge-suspended, .badge-SUSPENDED { background: rgba(198,40,40,.2); color: #f87171; }
        .badge-blocked, .badge-BLOCKED { background: rgba(106,27,154,.2); color: #c084fc; }
        .badge-user, .badge-USER { background: rgba(21,101,192,.2); color: #60a5fa; }
        .badge-admin, .badge-ADMIN { background: rgba(46,125,50,.2); color: #4ade80; }
        .badge-master, .badge-MASTER { background: rgba(136,14,79,.2); color: #f472b6; }
        .btn { padding: 5px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.15s; }
        .btn:hover { opacity: 0.85; transform: translateY(-1px); }
        .btn-primary { background: #2563eb; color: white; }
        .btn-success { background: #059669; color: white; }
        .btn-warning { background: #d97706; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-sm { padding: 3px 8px; font-size: 11px; }
        .role-select, .status-select { padding: 4px 8px; border: 1px solid #2e3250; border-radius: 6px; font-size: 12px; background: #0a0e1a; color: #e2e8f0; cursor: pointer; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 13px; animation: fadeIn 0.3s ease; }
        .alert-success { background: rgba(46,125,50,.15); color: #4ade80; border-left: 4px solid #059669; }
        .alert-error { background: rgba(198,40,40,.15); color: #f87171; border-left: 4px solid #dc2626; }
        .empty { padding: 30px; text-align: center; color: #64748b; font-size: 13px; }
        .loading { padding: 20px; text-align: center; color: #64748b; }
        .tab-bar { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 2px solid #2e3250; }
        .tab { padding: 10px 18px; cursor: pointer; border-radius: 8px 8px 0 0; font-size: 13px; font-weight: 500; color: #94a3b8; background: none; border: none; transition: all 0.15s; }
        .tab.active { color: #60a5fa; border-bottom: 2px solid #60a5fa; margin-bottom: -2px; background: rgba(37,99,235,.1); }
        .tab:hover:not(.active) { background: #0f172a; }
        .view { display: none; }
        .view.active { display: block; }
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], select, textarea { background: #0a0e1a; border: 1px solid #2e3250; color: #e2e8f0; border-radius: 6px; padding: 6px 10px; font-size: 13px; }
        label { color: #94a3b8; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="topbar-left">
            <img src="/assets/logo-icon.svg" class="logo" alt="Buddyliko">
            <h1 data-i18n="admin.title">üîê Admin Dashboard</h1>
        </div>
        <nav class="topbar-nav">
            <a href="app.html">üó∫Ô∏è Mapper</a>
            <a href="workspace.html" data-i18n="nav.workspace">Workspace</a>
            <a href="admin.html" class="active" data-i18n="nav.admin">Admin</a>
            <a href="finance.html" data-i18n="nav.finance">Finance</a>
        </nav>
        <div class="topbar-right">
            <span id="theme-slot"></span>
            <span id="lang-switcher"></span>
            <span class="user-info" id="adminName"></span>
            <button class="btn-logout" onclick="doLogout()" data-i18n="admin.logout">üö™ Logout</button>
        </div>
    </div>

    <div class="container">
        <div id="alerts"></div>

        <!-- Stats -->
        <div class="stats" id="stats">
            <div class="stat-card"><div class="loading">Caricamento...</div></div>
        </div>

        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab active" onclick="showTab('pending')"><span data-i18n="admin.pending_tab">‚è≥ In attesa</span> <span id="pendingBadge"></span></button>
            <button class="tab" onclick="showTab('users')" data-i18n="admin.all_users">üë• Tutti gli utenti</button>
            <button class="tab" onclick="showTab('groups')" data-i18n="admin.groups_tab">üìÅ Gruppi</button>
            <button class="tab" onclick="showTab('files')" data-i18n="admin.files_tab">üìÑ File</button>
            <button class="tab" onclick="showTab('dbconn')" data-i18n="admin.db_tab">üîå Connessioni DB</button>
            <button class="tab" onclick="showTab('audit')" data-i18n="admin.audit_tab">üîç Audit Log</button>
            <button class="tab" onclick="showTab('billing')" data-i18n="admin.billing_tab">üí≥ Billing</button>
            <button class="tab" onclick="showTab('ai-budget')">ü§ñ AI Budget</button>
            <button class="tab" onclick="showTab('api-docs')">üì° API Docs</button>
        </div>

        <!-- Pending users -->
        <div class="view active" id="view-pending">
            <div class="section">
                <div class="section-title"><span data-i18n="admin.pending_approval">Utenti in attesa di approvazione</span> <span class="count" id="pendingCount">0</span></div>
                <div id="pendingBody"><div class="loading">Caricamento...</div></div>
            </div>
        </div>

        <!-- All users -->
        <div class="view" id="view-users">
            <div class="section">
                <div class="section-title" data-i18n="admin.all_users">Tutti gli utenti</div>
                <div id="usersBody"><div class="loading">Caricamento...</div></div>
            </div>
        </div>

        <!-- Groups -->
        <div class="view" id="view-groups">
            <div class="section">
                <div class="section-title" data-i18n="admin.groups">Gruppi</div>
                <div id="groupsBody"><div class="loading">Caricamento...</div></div>
            </div>
        </div>

        <!-- Files -->
        <div class="view" id="view-files">
            <div class="section">
                <div class="section-title" data-i18n="admin.files_in_ws">File nel workspace</div>
                <div id="filesBody"><div class="loading">Caricamento...</div></div>
            </div>
        </div>

        <!-- DB Connections -->
        <div class="view" id="view-dbconn">
            <div class="section">
                <div class="section-title" style="display:flex;justify-content:space-between;align-items:center">
                    <span data-i18n="admin.db_all_users">Connessioni Database di tutti gli utenti</span>
                    <button class="btn btn-success" onclick="document.getElementById('newDbConnForm').style.display=document.getElementById('newDbConnForm').style.display==='none'?'block':'none'">‚ûï Nuova connessione</button>
                </div>
                <!-- Create form -->
                <div id="newDbConnForm" style="display:none;background:#f9f9f9;border:1px solid #e0e0e0;border-radius:8px;padding:16px;margin-bottom:16px">
                    <div style="display:grid;grid-template-columns:2fr 1fr;gap:10px;margin-bottom:10px">
                        <div><label style="font-size:12px;font-weight:600">Nome</label><input id="dbcName" class="role-select" style="width:100%;padding:6px" placeholder="Es: Production DB"></div>
                        <div><label style="font-size:12px;font-weight:600">Tipo</label><select id="dbcType" class="role-select" style="width:100%;padding:6px"><option value="postgresql">PostgreSQL</option><option value="mysql">MySQL</option><option value="sqlserver">SQL Server</option><option value="sqlite">SQLite</option></select></div>
                    </div>
                    <div style="display:grid;grid-template-columns:2fr 1fr 2fr;gap:10px;margin-bottom:10px">
                        <div><label style="font-size:12px;font-weight:600">Host</label><input id="dbcHost" class="role-select" style="width:100%;padding:6px" value="localhost"></div>
                        <div><label style="font-size:12px;font-weight:600">Porta</label><input id="dbcPort" class="role-select" style="width:100%;padding:6px" placeholder="Auto"></div>
                        <div><label style="font-size:12px;font-weight:600">Database</label><input id="dbcDatabase" class="role-select" style="width:100%;padding:6px" placeholder="nome_db"></div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">
                        <div><label style="font-size:12px;font-weight:600">Utente</label><input id="dbcUser" class="role-select" style="width:100%;padding:6px" placeholder="username"></div>
                        <div><label style="font-size:12px;font-weight:600">Password</label><input id="dbcPass" type="password" class="role-select" style="width:100%;padding:6px" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                        <div><label style="font-size:12px;font-weight:600">Schema</label><input id="dbcSchema" class="role-select" style="width:100%;padding:6px" value="public"></div>
                    </div>
                    <button class="btn btn-success" onclick="adminCreateDbConn()">üíæ Salva</button>
                    <button class="btn btn-primary" onclick="document.getElementById('newDbConnForm').style.display='none'" style="margin-left:8px">Annulla</button>
                </div>
                <div id="dbconnBody"><div class="loading">Caricamento...</div></div>
            </div>
        </div>

        <!-- Audit Log -->
        <div class="view" id="view-audit">
            <!-- Level selector -->
            <div class="section" style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
                <div class="section-title" style="margin:0"><span data-i18n="admin.log_level">üéõÔ∏è Livello di log:</span></div>
                <select id="auditLevelSelect" class="role-select" style="font-size:14px;padding:6px 12px"
                        onchange="setAuditLevel(this.value)">
                    <option value="MINIMAL">MINIMAL ‚Äî solo chi/cosa/quando</option>
                    <option value="STANDARD" selected>STANDARD ‚Äî + metadati file</option>
                    <option value="FULL">FULL ‚Äî + preview dati (GDPR: attenzione!)</option>
                </select>
                <span id="auditLevelStatus" style="font-size:12px;color:#666"></span>
                <div style="margin-left:auto;display:flex;gap:8px">
                    <button class="btn btn-primary" onclick="loadAuditLogs()">üîÑ Aggiorna</button>
                    <button class="btn btn-success" onclick="exportAuditCSV()">‚¨áÔ∏è Export CSV</button>
                </div>
            </div>
            <!-- Filters -->
            <div class="section" style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
                <div>
                    <div style="font-size:11px;color:#888;margin-bottom:4px">Utente (ID)</div>
                    <input type="text" id="auditFilterUser" class="role-select" placeholder="Lascia vuoto = tutti"
                           style="width:180px" oninput="debounceLoadAudit()">
                </div>
                <div>
                    <div style="font-size:11px;color:#888;margin-bottom:4px">Azione</div>
                    <select id="auditFilterAction" class="role-select" onchange="loadAuditLogs()">
                        <option value="">Tutte</option>
                        <option>LOGIN</option><option>LOGOUT</option><option>LOGIN_FAILED</option>
                        <option>TRANSFORM</option><option>TRANSFORM_ASYNC</option>
                        <option>FILE_UPLOAD</option><option>FILE_DOWNLOAD</option><option>FILE_DELETE</option>
                        <option>PROJECT_SAVE</option><option>PROJECT_LOAD</option>
                        <option>CODE_GENERATE</option>
                        <option>USER_STATUS_CHANGE</option><option>USER_ROLE_CHANGE</option>
                        <option>SCHEMA_CREATE</option><option>SCHEMA_DELETE</option>
                        <option>JOB_CREATE</option><option>JOB_COMPLETE</option><option>JOB_FAIL</option>
                    </select>
                </div>
                <div>
                    <div style="font-size:11px;color:#888;margin-bottom:4px">Esito</div>
                    <select id="auditFilterOutcome" class="role-select" onchange="loadAuditLogs()">
                        <option value="">Tutti</option>
                        <option>SUCCESS</option><option>FAILURE</option><option>WARNING</option>
                    </select>
                </div>
                <div>
                    <div style="font-size:11px;color:#888;margin-bottom:4px">Dal</div>
                    <input type="date" id="auditDateFrom" class="role-select" onchange="loadAuditLogs()">
                </div>
                <div>
                    <div style="font-size:11px;color:#888;margin-bottom:4px">Al</div>
                    <input type="date" id="auditDateTo" class="role-select" onchange="loadAuditLogs()">
                </div>
                <button class="btn btn-warning" onclick="clearAuditFilters()">‚úï Reset filtri</button>
            </div>
            <!-- Log table -->
            <div class="section" style="overflow-x:auto">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div class="section-title" style="margin:0">Log <span id="auditTotal" style="font-size:13px;font-weight:400;color:#888"></span></div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <button class="btn btn-primary btn-sm" id="auditPrevBtn" onclick="auditPage(-1)">‚óÄ</button>
                        <span id="auditPageLabel" style="font-size:13px"></span>
                        <button class="btn btn-primary btn-sm" id="auditNextBtn" onclick="auditPage(1)">‚ñ∂</button>
                    </div>
                </div>
                <div id="auditBody"><div class="loading">Carica la tab per vedere i log</div></div>
            </div>
        </div>

        <!-- Billing -->
        <div class="view" id="view-billing">
            <div class="section">
                <div class="section-title"><span data-i18n="admin.revenue_overview">üí≥ Panoramica Revenue</span></div>
                <div style="margin-bottom:8px;display:flex;gap:10px;align-items:center">
                    <button class="btn btn-primary" onclick="loadBillingStats(); loadAllUsersUsage();">üîÑ Aggiorna</button>
                </div>
                <div id="billingStatsBox"><div class="loading">Caricamento statistiche...</div></div>
            </div>

            <div class="section" style="margin-top:16px">
                <div class="section-title" style="display:flex;align-items:center;gap:12px">
                    <span data-i18n="admin.usage_per_user">üìä Utilizzo per utente</span>
                    <select id="billingMonth" onchange="loadAllUsersUsage()" style="font-size:13px;padding:5px 10px;border:1px solid #ddd;border-radius:6px">
                        <option value="">Mese corrente</option>
                    </select>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:13px">
                    <thead>
                        <tr style="background:#f5f5f5">
                            <th style="padding:10px;text-align:left;border-bottom:2px solid #ddd">Email</th>
                            <th style="padding:10px;text-align:left;border-bottom:2px solid #ddd">Nome</th>
                            <th style="padding:10px;text-align:left;border-bottom:2px solid #ddd">Piano</th>
                            <th style="padding:10px;text-align:right;border-bottom:2px solid #ddd">Trasf.</th>
                            <th style="padding:10px;text-align:right;border-bottom:2px solid #ddd">Dati</th>
                            <th style="padding:10px;text-align:center;border-bottom:2px solid #ddd">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="billingUsageTable">
                        <tr><td colspan="6" style="text-align:center;padding:20px;color:#999">Clicca sulla tab per caricare i dati</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- AI Budget -->
        <div class="view" id="view-ai-budget">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px">
                <div class="stat-card" id="ai-balance-card">
                    <div class="stat-label">Saldo stimato Anthropic</div>
                    <div class="stat-value" id="ai-est-balance">‚Äî</div>
                    <div style="font-size:11px;color:#64748b;margin-top:4px" id="ai-balance-status"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Spesa questo mese</div>
                    <div class="stat-value" id="ai-month-spend">‚Äî</div>
                    <div style="font-size:11px;color:#64748b;margin-top:4px" id="ai-month-calls"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Spesa oggi</div>
                    <div class="stat-value" id="ai-today-spend">‚Äî</div>
                </div>
            </div>

            <!-- Calibrazione -->
            <div class="section">
                <div class="section-title">üéØ Calibrazione saldo</div>
                <p style="font-size:13px;color:#94a3b8;margin-bottom:16px">
                    Inserisci il saldo reale letto da
                    <a href="https://console.anthropic.com/settings/billing" target="_blank"
                       style="color:#60a5fa">console.anthropic.com</a>.
                    Il sistema calcoler√† automaticamente il saldo aggiornato in base al consumo tracciato.
                </p>
                <div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap">
                    <div>
                        <label style="display:block;font-size:12px;margin-bottom:4px">Saldo attuale ($)</label>
                        <input type="number" id="ai-cal-balance" step="0.01" min="0" placeholder="14.99"
                               style="width:120px;padding:8px;font-size:14px">
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;margin-bottom:4px">Auto-recharge</label>
                        <select id="ai-cal-recharge" style="padding:8px;font-size:13px">
                            <option value="true">S√¨</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;margin-bottom:4px">Importo ricarica ($)</label>
                        <input type="number" id="ai-cal-amount" step="0.01" value="15"
                               style="width:100px;padding:8px;font-size:14px">
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;margin-bottom:4px">Soglia ricarica ($)</label>
                        <input type="number" id="ai-cal-threshold" step="0.01" value="5"
                               style="width:100px;padding:8px;font-size:14px">
                    </div>
                    <button class="btn btn-primary" onclick="calibrateBalance()" style="padding:8px 20px;height:38px">
                        ‚úÖ Calibra
                    </button>
                </div>
                <div id="ai-cal-result" style="margin-top:12px;font-size:13px"></div>
            </div>

            <!-- Dettaglio consumo -->
            <div class="section" style="margin-top:16px">
                <div class="section-title">üìä Dettaglio consumo mese</div>
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>Provider</th>
                            <th style="text-align:right">Chiamate</th>
                            <th style="text-align:right">Input tokens</th>
                            <th style="text-align:right">Output tokens</th>
                            <th style="text-align:right">Costo ($)</th>
                            <th style="text-align:right">Durata media</th>
                        </tr>
                    </thead>
                    <tbody id="ai-usage-table">
                        <tr><td colspan="6" class="empty">Caricamento...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Info configurazione -->
            <div class="section" style="margin-top:16px">
                <div class="section-title">‚öôÔ∏è Configurazione</div>
                <div id="ai-config-info" style="font-size:13px;color:#94a3b8">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" id="ai-config-grid"></div>
                </div>
            </div>
        </div>

        <!-- API Docs (Swagger) -->
        <div class="view" id="view-api-docs">
            <div class="section">
                <div class="section-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
                    <span>üì° API Documentation</span>
                    <div style="display:flex;gap:8px">
                        <a href="/api/docs" target="_blank" class="btn btn-primary"
                           style="padding:6px 16px;font-size:12px;text-decoration:none;color:#fff">
                            üîó Swagger UI
                        </a>
                        <a href="/api/redoc" target="_blank" class="btn"
                           style="padding:6px 16px;font-size:12px;text-decoration:none;background:#475569;color:#fff">
                            üìñ ReDoc
                        </a>
                        <a href="/api/openapi.json" target="_blank" class="btn"
                           style="padding:6px 16px;font-size:12px;text-decoration:none;background:#334155;color:#fff">
                            {} OpenAPI JSON
                        </a>
                    </div>
                </div>
                <iframe id="swagger-frame" src="about:blank"
                        style="width:100%;height:calc(100vh - 260px);border:1px solid #2e3250;border-radius:8px;margin-top:12px;background:#fff">
                </iframe>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        let token = localStorage.getItem('buddyliko_token');

        // ================================================================
        // UTILS
        // ================================================================
        function showAlert(msg, type = 'success') {
            const div = document.createElement('div');
            div.className = `alert alert-${type}`;
            div.textContent = msg;
            const el = document.getElementById('alerts');
            el.insertBefore(div, el.firstChild);
            setTimeout(() => div.remove(), 3500);
        }

        async function apiFetch(path, options = {}) {
            const res = await fetch(API + path, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...(options.headers || {})
                }
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({ detail: T('admin.request_failed') }));
                throw new Error(err.detail || 'Errore');
            }
            return res.json();
        }

        function showTab(name) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('view-' + name).classList.add('active');
            event.target.classList.add('active');
            if (name === 'users') loadUsers();
            if (name === 'groups') loadGroups();
            if (name === 'files') loadFiles();
            if (name === 'dbconn') loadDbConnections();
            if (name === 'audit') { loadAuditLevel(); loadAuditLogs(); }
            if (name === 'ai-budget') loadAIBudgetAdmin();
            if (name === 'api-docs') {
                const frame = document.getElementById('swagger-frame');
                if (frame && frame.src === 'about:blank') frame.src = '/api/docs';
            }
            if (name === 'billing') {
                // Popola select mesi ultimi 6
                const sel = document.getElementById('billingMonth');
                if (sel && sel.options.length <= 1) {
                    const now = new Date();
                    for (let i = 0; i < 6; i++) {
                        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                        const opt = document.createElement('option');
                        opt.value = val; opt.textContent = val;
                        if (i > 0) sel.appendChild(opt);
                    }
                }
                loadBillingStats(); loadAllUsersUsage();
            }
        }

        function doLogout() {
            localStorage.removeItem('buddyliko_token');
            localStorage.removeItem('buddyliko_user');
            window.location.href = 'login.html';
        }

        // ================================================================
        // STATS
        // ================================================================
        async function loadStats() {
            try {
                const res = await apiFetch('/admin/stats');
                const u = res.users, g = res.groups, f = res.files;
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${u.total_users}</div>
                        <div class="stat-label">Utenti totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:#E65100">${u.pending_users}</div>
                        <div class="stat-label">In attesa</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:#2E7D32">${u.active_users}</div>
                        <div class="stat-label">Attivi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${u.free_users}</div>
                        <div class="stat-label">Piano Free</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:#6c63ff">${u.pro_users || 0}</div>
                        <div class="stat-label">Piano Pro</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${g.total_groups}</div>
                        <div class="stat-label">Gruppi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${f.total_files}</div>
                        <div class="stat-label">File</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatSize(f.total_size || 0)}</div>
                        <div class="stat-label">Spazio usato</div>
                    </div>
                `;
            } catch(e) {
                document.getElementById('stats').innerHTML = `<div class="stat-card"><div style="color:red;font-size:13px">Errore: ${e.message}</div></div>`;
            }
        }

        function formatSize(bytes) {
            if (!bytes) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
            return (bytes/1048576).toFixed(1) + ' MB';
        }

        // ================================================================
        // PENDING USERS (status=PENDING -> approve = set status APPROVED)
        // ================================================================
        async function loadPending() {
            try {
                const res = await apiFetch('/admin/users?status=PENDING');
                const users = res.users || [];
                document.getElementById('pendingCount').textContent = users.length;
                document.getElementById('pendingBadge').textContent = users.length > 0 ? `(${users.length})` : '';

                if (!users.length) {
                    document.getElementById('pendingBody').innerHTML = '<div class="empty">‚úÖ Nessun utente in attesa</div>';
                    return;
                }
                document.getElementById('pendingBody').innerHTML = `
                    <table>
                        <thead><tr>
                            <th>Nome</th><th>Email</th><th>Registrato</th><th>Azioni</th>
                        </tr></thead>
                        <tbody>
                            ${users.map(u => `
                                <tr>
                                    <td>${u.name || '‚Äî'}</td>
                                    <td>${u.email}</td>
                                    <td>${u.created_at ? new Date(u.created_at).toLocaleDateString('it-IT') : '‚Äî'}</td>
                                    <td style="display:flex;gap:6px">
                                        <button class="btn btn-success" onclick="approveUser('${u.id}')">‚úì Approva</button>
                                        <button class="btn btn-danger" onclick="rejectUser('${u.id}')">‚úó Rifiuta</button>
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>`;
            } catch(e) {
                document.getElementById('pendingBody').innerHTML = `<div class="empty" style="color:red">${e.message}</div>`;
            }
        }

        async function approveUser(id) {
            try {
                await apiFetch(`/admin/users/${id}/status?status=APPROVED`, { method: 'PUT' });
                showAlert(T('admin.approved'));
                loadStats(); loadPending();
            } catch(e) { showAlert(T('admin.error') + ': ' + e.message, 'error'); }
        }

        async function rejectUser(id) {
            if (!confirm(T('admin.reject_confirm'))) return;
            try {
                await apiFetch(`/admin/users/${id}/status?status=BLOCKED`, { method: 'PUT' });
                showAlert(T('admin.rejected'));
                loadStats(); loadPending();
            } catch(e) { showAlert(T('admin.error') + ': ' + e.message, 'error'); }
        }

        // ================================================================
        // ALL USERS
        // ================================================================
        async function loadUsers() {
            const el = document.getElementById('usersBody');
            el.innerHTML = '<div class="loading">' + T('admin.loading') + '</div>';
            try {
                const res = await apiFetch('/admin/users');
                const users = res.users || [];
                if (!users.length) { el.innerHTML = '<div class="empty">' + T('admin.no_users') + '</div>'; return; }
                el.innerHTML = `
                    <table>
                        <thead><tr>
                            <th>Nome</th><th>Email</th><th>Ruolo</th><th>Stato</th><th>Piano</th><th>Registrato</th><th>Azioni</th>
                        </tr></thead>
                        <tbody>
                            ${users.map(u => `
                                <tr>
                                    <td>${u.name || '‚Äî'}</td>
                                    <td>${u.email}</td>
                                    <td>
                                        <select class="role-select" onchange="updateRole('${u.id}', this.value)">
                                            ${['USER','ADMIN','MASTER'].map(r => `<option ${u.role===r?'selected':''}>${r}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td>
                                        <select class="status-select" onchange="updateStatus('${u.id}', this.value)">
                                            ${['PENDING','APPROVED','SUSPENDED','BLOCKED'].map(s => `<option ${u.status===s?'selected':''}>${s}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td>${u.plan || 'FREE'}</td>
                                    <td>${u.created_at ? new Date(u.created_at).toLocaleDateString('it-IT') : '‚Äî'}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="showUserDetail('${u.id}')">Dettagli</button>
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>`;
            } catch(e) { el.innerHTML = `<div class="empty" style="color:red">${e.message}</div>`; }
        }

        async function updateRole(id, role) {
            try {
                await apiFetch(`/admin/users/${id}/role?role=${role}`, { method: 'PUT' });
                showAlert(T('admin.role_updated'));
            } catch(e) { showAlert(T('admin.error') + ': ' + e.message, 'error'); loadUsers(); }
        }

        async function updateStatus(id, status) {
            try {
                await apiFetch(`/admin/users/${id}/status?status=${status}`, { method: 'PUT' });
                showAlert(T('admin.status_updated'));
            } catch(e) { showAlert(T('admin.error') + ': ' + e.message, 'error'); loadUsers(); }
        }

        function showUserDetail(userId) {
            apiFetch('/admin/users').then(res => {
                const u = (res.users||[]).find(x => String(x.id) === String(userId));
                if (!u) return;
                alert(`Utente: ${u.name}\nEmail: ${u.email}\nID: ${u.id}\nRuolo: ${u.role}\nStato: ${u.status}\nPiano: ${u.plan}\nRegistrato: ${u.created_at ? new Date(u.created_at).toLocaleString('it-IT') : 'N/A'}`);
            });
        }

        // ================================================================
        // GROUPS
        // ================================================================
        async function loadGroups() {
            const el = document.getElementById('groupsBody');
            el.innerHTML = '<div class="loading">' + T('admin.loading') + '</div>';
            try {
                const res = await apiFetch('/groups');
                const groups = res.groups || [];
                if (!groups.length) { el.innerHTML = '<div class="empty">' + T('admin.no_groups') + '</div>'; return; }
                el.innerHTML = `
                    <table>
                        <thead><tr>
                            <th>Nome</th><th>Descrizione</th><th>Gruppo padre</th><th>Creato</th><th>Azioni</th>
                        </tr></thead>
                        <tbody>
                            ${groups.map(g => `
                                <tr>
                                    <td><strong>${g.name}</strong></td>
                                    <td>${g.description || '‚Äî'}</td>
                                    <td>${g.parent_id || '‚Äî'}</td>
                                    <td>${g.created_at ? new Date(g.created_at).toLocaleDateString('it-IT') : '‚Äî'}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="deleteGroup('${g.id}','${g.name}')">Elimina</button>
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>`;
            } catch(e) { el.innerHTML = `<div class="empty" style="color:red">${e.message}</div>`; }
        }

        async function deleteGroup(id, name) {
            if (!confirm(`Eliminare il gruppo "${name}"? Verranno eliminati anche tutti i sottogruppi.`)) return;
            try {
                await apiFetch(`/groups/${id}`, { method: 'DELETE' });
                showAlert(T('admin.group_deleted'));
                loadGroups();
            } catch(e) { showAlert(T('admin.error') + ': ' + e.message, 'error'); }
        }

        // ================================================================
        // FILES
        // ================================================================
        async function loadFiles() {
            const el = document.getElementById('filesBody');
            el.innerHTML = '<div class="loading">' + T('admin.loading') + '</div>';
            try {
                const res = await apiFetch('/workspace/files?scope=all');
                const files = res.files || [];
                if (!files.length) { el.innerHTML = '<div class="empty">' + T('admin.no_files') + '</div>'; return; }
                el.innerHTML = `
                    <table>
                        <thead><tr>
                            <th>Nome</th><th>Tipo</th><th>Proprietario</th><th>Comune</th><th>Dimensione</th><th>Creato</th><th>Azioni</th>
                        </tr></thead>
                        <tbody>
                            ${files.map(f => `
                                <tr>
                                    <td>${f.name}</td>
                                    <td><span class="badge">${f.file_type}</span></td>
                                    <td>${f.owner_id}</td>
                                    <td>${f.is_common ? '‚úÖ' : '‚Äî'}</td>
                                    <td>${formatSize(f.file_size||0)}</td>
                                    <td>${f.created_at ? new Date(f.created_at).toLocaleDateString('it-IT') : '‚Äî'}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="deleteFile('${f.id}','${f.name}')">Elimina</button>
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>`;
            } catch(e) { el.innerHTML = `<div class="empty" style="color:red">${e.message}</div>`; }
        }

        async function deleteFile(id, name) {
            if (!confirm(`Eliminare il file "${name}"?`)) return;
            try {
                await apiFetch(`/workspace/files/${id}`, { method: 'DELETE' });
                showAlert(T('admin.file_deleted'));
                loadFiles();
            } catch(e) { showAlert(T('admin.error') + ': ' + e.message, 'error'); }
        }

        // ================================================================
        // INIT
        // ================================================================
        async function init() {
            // Check token
            if (!token) { window.location.href = 'login.html'; return; }

            try {
                const res = await apiFetch('/auth/me');
                const user = res.user || res;
                if (!['MASTER', 'ADMIN'].includes(user.role)) {
                    alert(T('admin.access_denied'));
                    window.location.href = 'app.html';
                    return;
                }
                document.getElementById('adminName').textContent = `${user.name || user.email} (${user.role})`;
                await loadStats();
                await loadPending();
            } catch(e) {
                localStorage.removeItem('buddyliko_token');
                window.location.href = 'login.html';
            }
        }

        init();

        // ================================================================
        // DB CONNECTIONS
        // ================================================================
        async function loadDbConnections() {
            const el = document.getElementById('dbconnBody');
            el.innerHTML = '<div class="loading">' + T('admin.loading') + '</div>';
            try {
                const res = await apiFetch('/admin/dbconn');
                const conns = res.connections || [];
                if (!conns.length) {
                    el.innerHTML = '<div class="empty">üîå Nessuna connessione DB configurata</div>';
                    return;
                }
                const statusIcon = s => s === 'ok' ? 'üü¢' : s === 'error' ? 'üî¥' : '‚ö™';
                const dbTypeColor = t => ({
                    postgresql: '#336791', mysql: '#4479A1', sqlserver: '#CC2927', sqlite: '#003B57'
                }[t] || '#666');
                el.innerHTML = `
                    <table>
                        <thead><tr>
                            <th>Nome</th><th>Tipo</th><th>Utente</th><th>Schema</th>
                            <th>Stato</th><th>Ultimo test</th><th>Creata</th><th>Azioni</th>
                        </tr></thead>
                        <tbody>
                            ${conns.map(c => `
                                <tr>
                                    <td><strong>${c.name}</strong></td>
                                    <td><span class="badge" style="background:${dbTypeColor(c.db_type)};color:white">${c.db_type}</span></td>
                                    <td style="font-size:12px">${c.user_email || c.user_id || '‚Äî'}</td>
                                    <td style="font-size:12px;color:#666">${c.default_schema || '‚Äî'}</td>
                                    <td>${statusIcon(c.last_test_status)} ${c.last_test_status || 'unknown'}</td>
                                    <td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${c.last_test_message || ''}">${c.last_test_message || '‚Äî'}</td>
                                    <td style="font-size:12px">${c.created_at ? new Date(c.created_at).toLocaleDateString('it-IT') : '‚Äî'}</td>
                                    <td style="display:flex;gap:4px">
                                        <button class="btn btn-primary btn-sm" onclick="testDbConn('${c.id}','${c.user_id}')">üß™ Test</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteDbConn('${c.id}','${c.name}')">üóëÔ∏è</button>
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>`;
            } catch(e) { el.innerHTML = `<div class="empty" style="color:red">${e.message}</div>`; }
        }

        async function testDbConn(connId, userId) {
            try {
                const res = await apiFetch(`/dbconn/${connId}/test`, { method: 'POST' });
                if (res.success) showAlert('‚úÖ Connessione OK: ' + (res.message || ''));
                else showAlert('‚ùå Test fallito: ' + (res.message || ''), 'error');
                loadDbConnections();
            } catch(e) { showAlert(T('admin.error') + ': ' + e.message, 'error'); }
        }

        async function deleteDbConn(connId, name) {
            if (!confirm(`Eliminare la connessione "${name}"?`)) return;
            try {
                await apiFetch(`/admin/dbconn/${connId}`, { method: 'DELETE' });
                showAlert('Connessione eliminata');
                loadDbConnections();
            } catch(e) { showAlert(T('admin.error') + ': ' + e.message, 'error'); }
        }

        async function adminCreateDbConn() {
            const name = document.getElementById('dbcName').value.trim();
            const db_type = document.getElementById('dbcType').value;
            const host = document.getElementById('dbcHost').value.trim() || 'localhost';
            const port = document.getElementById('dbcPort').value.trim();
            const database = document.getElementById('dbcDatabase').value.trim();
            const user = document.getElementById('dbcUser').value.trim();
            const password = document.getElementById('dbcPass').value;
            const schema = document.getElementById('dbcSchema').value.trim() || 'public';
            if (!name || !database) { showAlert('Nome e Database sono obbligatori', 'error'); return; }
            try {
                await apiFetch('/dbconn/save', {
                    method: 'POST',
                    body: JSON.stringify({ name, db_type, connection_params: { host, port: port||undefined, database, user, password, schema } })
                });
                showAlert('‚úÖ Connessione creata!');
                document.getElementById('newDbConnForm').style.display = 'none';
                document.getElementById('dbcName').value = '';
                document.getElementById('dbcDatabase').value = '';
                document.getElementById('dbcUser').value = '';
                document.getElementById('dbcPass').value = '';
                loadDbConnections();
            } catch(e) { showAlert(T('admin.error') + ': ' + e.message, 'error'); }
        }

        // ================================================================
        // AUDIT LOG
        // ================================================================
        let _auditOffset = 0;
        const _auditLimit = 50;
        let _auditTotal = 0;
        let _auditDebounce = null;

        function debounceLoadAudit() {
            clearTimeout(_auditDebounce);
            _auditDebounce = setTimeout(loadAuditLogs, 500);
        }

        async function loadAuditLevel() {
            try {
                const res = await apiFetch('/admin/audit/level');
                const sel = document.getElementById('auditLevelSelect');
                if (sel) sel.value = res.level;
            } catch(e) {}
        }

        async function setAuditLevel(level) {
            const statusEl = document.getElementById('auditLevelStatus');
            try {
                await apiFetch('/admin/audit/level', {
                    method: 'PUT',
                    body: JSON.stringify({ level })
                });
                if (statusEl) statusEl.textContent = `‚úÖ Livello impostato a ${level}`;
                setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 3000);
                showAlert(`Livello audit aggiornato: ${level}`);
            } catch(e) {
                showAlert(T('admin.error') + ': ' + e.message, 'error');
                if (statusEl) statusEl.textContent = `‚ùå ${e.message}`;
            }
        }

        async function loadAuditLogs() {
            const el = document.getElementById('auditBody');
            if (!el) return;
            el.innerHTML = '<div class="loading">' + T('admin.loading') + '</div>';

            const userId = document.getElementById('auditFilterUser')?.value || '';
            const action = document.getElementById('auditFilterAction')?.value || '';
            const outcome = document.getElementById('auditFilterOutcome')?.value || '';
            const dateFrom = document.getElementById('auditDateFrom')?.value || '';
            const dateTo = document.getElementById('auditDateTo')?.value || '';

            const params = new URLSearchParams({ limit: _auditLimit, offset: _auditOffset });
            if (userId) params.set('user_id', userId);
            if (action) params.set('action', action);
            if (outcome) params.set('outcome', outcome);
            if (dateFrom) params.set('date_from', dateFrom);
            if (dateTo) params.set('date_to', dateTo);

            try {
                const res = await apiFetch('/admin/audit/logs?' + params.toString());
                const logs = res.logs || [];
                _auditTotal = res.total || 0;

                document.getElementById('auditTotal').textContent = `(${_auditTotal} totali)`;
                document.getElementById('auditPageLabel').textContent =
                    `${_auditOffset + 1}‚Äì${Math.min(_auditOffset + _auditLimit, _auditTotal)} / ${_auditTotal}`;
                document.getElementById('auditPrevBtn').disabled = _auditOffset === 0;
                document.getElementById('auditNextBtn').disabled = _auditOffset + _auditLimit >= _auditTotal;

                if (!logs.length) {
                    el.innerHTML = '<div class="empty">Nessun log trovato</div>';
                    return;
                }

                const outcomeColor = { SUCCESS: '#2E7D32', FAILURE: '#C62828', WARNING: '#E65100', PENDING: '#1565C0' };
                el.innerHTML = `<table>
                    <thead><tr>
                        <th>Timestamp</th><th>Utente</th><th>Azione</th>
                        <th>Risorsa</th><th>Esito</th><th>File</th>
                        <th>Durata</th><th>IP</th><th>Dettagli</th>
                    </tr></thead>
                    <tbody>
                    ${logs.map(l => `<tr>
                        <td style="white-space:nowrap;font-size:11px">${l.timestamp ? new Date(l.timestamp).toLocaleString('it-IT') : '‚Äî'}</td>
                        <td style="font-size:12px">${l.user_email || l.user_id || '‚Äî'}</td>
                        <td><span class="badge" style="background:#EEF2FF;color:#3730a3">${l.action}</span></td>
                        <td style="font-size:11px;color:#666">${l.resource_type || '‚Äî'}</td>
                        <td><span style="color:${outcomeColor[l.outcome]||'#333'};font-weight:600;font-size:12px">${l.outcome}</span></td>
                        <td style="font-size:11px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${l.file_name||''}">${l.file_name || '‚Äî'}</td>
                        <td style="font-size:11px">${l.duration_ms != null ? l.duration_ms + 'ms' : '‚Äî'}</td>
                        <td style="font-size:11px">${l.ip_address || '‚Äî'}</td>
                        <td>
                            ${l.error_message ? `<span style="color:#C62828;font-size:11px" title="${l.error_message}">‚ö†Ô∏è ${l.error_message.substring(0,40)}...</span>` : ''}
                            ${l.input_preview || l.output_preview ? `<button class="btn btn-primary btn-sm" onclick='showLogDetail(${JSON.stringify(l)})'>Preview</button>` : ''}
                        </td>
                    </tr>`).join('')}
                    </tbody></table>`;
            } catch(e) {
                el.innerHTML = `<div class="empty" style="color:red">${e.message}</div>`;
            }
        }

        function auditPage(dir) {
            _auditOffset = Math.max(0, _auditOffset + dir * _auditLimit);
            loadAuditLogs();
        }

        function clearAuditFilters() {
            document.getElementById('auditFilterUser').value = '';
            document.getElementById('auditFilterAction').value = '';
            document.getElementById('auditFilterOutcome').value = '';
            document.getElementById('auditDateFrom').value = '';
            document.getElementById('auditDateTo').value = '';
            _auditOffset = 0;
            loadAuditLogs();
        }

        async function exportAuditCSV() {
            const userId = document.getElementById('auditFilterUser')?.value || '';
            const action = document.getElementById('auditFilterAction')?.value || '';
            const outcome = document.getElementById('auditFilterOutcome')?.value || '';
            const dateFrom = document.getElementById('auditDateFrom')?.value || '';
            const dateTo = document.getElementById('auditDateTo')?.value || '';
            const params = new URLSearchParams();
            if (userId) params.set('user_id', userId);
            if (action) params.set('action', action);
            if (outcome) params.set('outcome', outcome);
            if (dateFrom) params.set('date_from', dateFrom);
            if (dateTo) params.set('date_to', dateTo);
            window.open(API + '/admin/audit/export?' + params.toString() + '&token=' + token);
        }

        function showLogDetail(log) {
            const pre = s => s ? `<pre style="margin:4px 0;background:#f5f5f5;padding:8px;border-radius:6px;font-size:11px;white-space:pre-wrap;max-height:200px;overflow:auto">${String(s).replace(/</g,'&lt;')}</pre>` : '<i>N/A</i>';
            const html = `
<b>ID:</b> ${log.id || '‚Äî'}<br>
<b>Azione:</b> ${log.action}<br>
<b>Esito:</b> ${log.outcome || '‚Äî'}<br>
<b>Utente:</b> ${log.user_email || log.user_id || '‚Äî'} (${log.user_role || '‚Äî'})<br>
<b>IP:</b> ${log.ip_address || '‚Äî'}<br>
<b>Timestamp:</b> ${log.timestamp ? new Date(log.timestamp).toLocaleString('it-IT') : '‚Äî'}<br>
<b>File:</b> ${log.file_name || '‚Äî'} (${log.file_size_bytes ? (log.file_size_bytes/1024).toFixed(1)+'KB' : '‚Äî'})<br>
<b>Formato:</b> ${log.input_format || '?'} ‚Üí ${log.output_format || '?'}<br>
<b>Durata:</b> ${log.duration_ms != null ? log.duration_ms + 'ms' : '‚Äî'}<br>
<b>Errore:</b> ${log.error_message || 'Nessuno'}<br>
<b>Metadata:</b> ${log.metadata ? pre(JSON.stringify(log.metadata,null,2)) : '‚Äî'}<br>
<b>Input preview:</b><br>${pre(log.input_preview)}
<b>Output preview:</b><br>${pre(log.output_preview)}`;
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.3);z-index:9999;max-width:600px;width:90%;max-height:80vh;overflow:auto';
            div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <strong>üîç Dettaglio Log</strong>
                <button onclick="this.closest('div[style]').remove()" style="border:none;background:none;cursor:pointer;font-size:18px">‚úï</button>
            </div>${html}`;
            document.body.appendChild(div);
        }

        // ================================================================
        // BILLING FUNCTIONS
        // ================================================================
        async function loadBillingStats() {
            const t = localStorage.getItem('buddyliko_token');
            try {
                const r = await fetch(`${API}/billing/admin/stats`, { headers: {'Authorization': `Bearer ${t}`} });
                if (!r.ok) { document.getElementById('billingStatsBox').innerHTML = '<p style="color:#999">Billing non configurato o non disponibile.</p>'; return; }
                const d = await r.json();
                const planColors = { FREE:'#78909c', PRO:'#1976d2', ENTERPRISE:'#6a1b9a', CUSTOM:'#2e7d32' };
                let html = `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px">
                    <div style="background:#e8f5e9;border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:28px;font-weight:700;color:#2e7d32">‚Ç¨${(d.mrr_eur||0).toFixed(0)}</div>
                        <div style="font-size:12px;color:#666">MRR stimato</div>
                    </div>
                    <div style="background:#e3f2fd;border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:28px;font-weight:700;color:#1565c0">${d.by_plan?.reduce((a,r)=>a+(r.active||0),0)||0}</div>
                        <div style="font-size:12px;color:#666">Abbonati attivi</div>
                    </div>
                    <div style="background:#fce4ec;border-radius:10px;padding:16px;text-align:center">
                        <div style="font-size:28px;font-weight:700;color:#c62828">${d.by_plan?.reduce((a,r)=>a+(r.past_due||0),0)||0}</div>
                        <div style="font-size:12px;color:#666">Pagamenti scaduti</div>
                    </div>
                </div>`;

                if (d.by_plan?.length) {
                    html += `<h4 style="margin:0 0 10px">Distribuzione piani</h4>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px">`;
                    for (const row of d.by_plan) {
                        const color = planColors[row.plan] || '#607d8b';
                        html += `<div style="background:${color};color:white;border-radius:8px;padding:10px 16px;min-width:100px;text-align:center">
                            <div style="font-size:20px;font-weight:700">${row.count||0}</div>
                            <div style="font-size:11px;opacity:.85">${row.plan}</div>
                            <div style="font-size:10px;opacity:.7">${row.active||0} attivi</div>
                        </div>`;
                    }
                    html += '</div>';
                }

                if (d.monthly_usage?.length) {
                    html += `<h4 style="margin:0 0 10px">Utilizzo ultimi 6 mesi</h4>
                    <table style="width:100%;border-collapse:collapse;font-size:13px">
                    <thead><tr style="background:#f5f5f5"><th style="padding:8px;text-align:left;border-bottom:2px solid #ddd">Mese</th><th style="padding:8px;text-align:right;border-bottom:2px solid #ddd">Trasf.</th><th style="padding:8px;text-align:right;border-bottom:2px solid #ddd">Utenti attivi</th><th style="padding:8px;text-align:right;border-bottom:2px solid #ddd">Dati processati</th></tr></thead><tbody>`;
                    for (const row of d.monthly_usage) {
                        const mb = row.total_bytes > 0 ? (row.total_bytes/1048576).toFixed(1) + ' MB' : '‚Äî';
                        html += `<tr style="border-bottom:1px solid #eee"><td style="padding:8px">${row.month}</td><td style="padding:8px;text-align:right">${(row.total_transforms||0).toLocaleString()}</td><td style="padding:8px;text-align:right">${row.active_users||0}</td><td style="padding:8px;text-align:right">${mb}</td></tr>`;
                    }
                    html += '</tbody></table>';
                }

                document.getElementById('billingStatsBox').innerHTML = html || '<p style="color:#999">Nessun dato.</p>';
            } catch(e) {
                document.getElementById('billingStatsBox').innerHTML = `<p style="color:#e53935">Errore: ${e.message}</p>`;
            }
        }

        async function loadAllUsersUsage() {
            const t = localStorage.getItem('buddyliko_token');
            const month = document.getElementById('billingMonth')?.value || '';
            try {
                const r = await fetch(`${API}/billing/admin/usage-all${month ? '?month='+month : ''}`, { headers: {'Authorization': `Bearer ${t}`} });
                if (!r.ok) { document.getElementById('billingUsageTable').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:16px">Dati non disponibili</td></tr>'; return; }
                const d = await r.json();
                const rows = d.usage || [];
                if (!rows.length) {
                    document.getElementById('billingUsageTable').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:16px">Nessun utilizzo registrato per questo mese</td></tr>';
                    return;
                }
                const planBadge = plan => {
                    const colors = { FREE:'#78909c', PRO:'#1976d2', ENTERPRISE:'#6a1b9a', CUSTOM:'#2e7d32' };
                    return `<span style="background:${colors[plan]||'#607d8b'};color:white;padding:2px 8px;border-radius:10px;font-size:11px">${plan||'FREE'}</span>`;
                };
                document.getElementById('billingUsageTable').innerHTML = rows.map(row => {
                    const mb = row.bytes_processed > 0 ? (row.bytes_processed/1048576).toFixed(1)+' MB' : '‚Äî';
                    return `<tr>
                        <td style="padding:8px">${row.email||row.user_id||'‚Äî'}</td>
                        <td style="padding:8px">${row.name||'‚Äî'}</td>
                        <td style="padding:8px">${planBadge(row.plan)}</td>
                        <td style="padding:8px;text-align:right">${row.transforms_count||0}</td>
                        <td style="padding:8px;text-align:right">${mb}</td>
                        <td style="padding:8px;text-align:right">
                            <button onclick="openBillingOverride('${row.user_id}','${row.email||''}')" style="padding:4px 10px;background:#1976d2;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px">‚úèÔ∏è Override piano</button>
                        </td>
                    </tr>`;
                }).join('');
            } catch(e) {
                document.getElementById('billingUsageTable').innerHTML = `<tr><td colspan="6" style="color:#e53935;padding:8px">Errore: ${e.message}</td></tr>`;
            }
        }

        function openBillingOverride(userId, email) {
            const plan = prompt(`Assegna piano gratuito a ${email}:\nInserisci: FREE, PRO, ENTERPRISE, o CUSTOM`);
            if (!plan) return;
            const note = prompt('Nota opzionale (es. "Partner agreement"):') || '';
            const t = localStorage.getItem('buddyliko_token');
            fetch(`${API}/billing/admin/override`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, plan: plan.toUpperCase(), note })
            }).then(r => r.json()).then(d => {
                if (d.success) { alert(`‚úÖ Piano ${plan.toUpperCase()} assegnato a ${email}`); loadAllUsersUsage(); }
                else alert('‚ùå ' + (d.detail || 'Errore'));
            }).catch(e => alert(T('admin.error') + ': ' + e.message));
        }
    </script>

<script>
// i18n initialization
(async () => {
    await i18n.init();
    i18n.createSwitcher('lang-switcher');
    window.addEventListener('langchange', () => {
        // Re-apply data-i18n attributes on lang change
        i18n.applyAll();
    });
})();
// ‚îÄ‚îÄ AI BUDGET FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAIBudgetAdmin() {
    try {
        const r = await fetch(API + '/finance/ai-balance/estimated', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const d = await r.json();
        if (!d.available) {
            document.getElementById('ai-est-balance').textContent = 'N/A';
            document.getElementById('ai-balance-status').textContent = 'Token tracker non attivo';
            return;
        }
        // Saldo stimato
        const bal = d.estimated_balance_usd;
        const balEl = document.getElementById('ai-est-balance');
        if (bal !== null) {
            balEl.textContent = '$' + bal.toFixed(2);
            balEl.style.color = d.status === 'healthy' ? '#4ade80' : d.status === 'warning' ? '#fbbf24' : '#f87171';
        } else {
            balEl.textContent = 'Non calibrato';
            balEl.style.color = '#94a3b8';
        }
        // Status info
        const statusEl = document.getElementById('ai-balance-status');
        var statusText = '';
        if (d.last_calibration) {
            var cal = new Date(d.last_calibration);
            statusText = 'Calibrato: ' + cal.toLocaleDateString('it') + ' ' + cal.toLocaleTimeString('it', {hour:'2-digit',minute:'2-digit'});
            if (d.spend_since_calibration > 0) statusText += ' | Speso da allora: $' + d.spend_since_calibration.toFixed(4);
            if (d.recharges_estimated > 0) statusText += ' | Ricariche stimate: ' + d.recharges_estimated;
        } else {
            statusText = 'Nessuna calibrazione. Inserisci il saldo reale qui sotto.';
        }
        statusEl.textContent = statusText;
        // Spesa mese
        var ms = d.month_stats || {};
        document.getElementById('ai-month-spend').textContent = '$' + (ms.total_cost_usd || 0).toFixed(4);
        document.getElementById('ai-month-calls').textContent = (ms.total_calls || 0) + ' chiamate API';
        // Spesa oggi
        document.getElementById('ai-today-spend').textContent = '$' + (d.today_spend || 0).toFixed(4);
        // Tabella dettaglio
        var providers = (ms.providers || []);
        var tbody = document.getElementById('ai-usage-table');
        if (providers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty">Nessuna chiamata AI tracciata questo mese</td></tr>';
        } else {
            tbody.innerHTML = providers.map(function(p) {
                return '<tr>' +
                    '<td>' + (p.provider === 'anthropic' ? 'üü† ' : 'üü¢ ') + p.provider + '</td>' +
                    '<td style="text-align:right">' + (p.calls || 0) + '</td>' +
                    '<td style="text-align:right">' + Number(p.input_tokens || 0).toLocaleString() + '</td>' +
                    '<td style="text-align:right">' + Number(p.output_tokens || 0).toLocaleString() + '</td>' +
                    '<td style="text-align:right">$' + Number(p.total_cost_usd || 0).toFixed(4) + '</td>' +
                    '<td style="text-align:right">' + Math.round(p.avg_duration_ms || 0) + 'ms</td>' +
                '</tr>';
            }).join('');
        }
        // Config info
        var grid = document.getElementById('ai-config-grid');
        grid.innerHTML =
            '<div>üîÑ Auto-recharge: <strong>' + (d.auto_recharge ? 'S√¨' : 'No') + '</strong></div>' +
            '<div>üí∞ Importo ricarica: <strong>$' + (d.recharge_amount || 0).toFixed(2) + '</strong></div>' +
            '<div>üìâ Soglia ricarica: <strong>$' + (d.recharge_threshold || 0).toFixed(2) + '</strong></div>' +
            '<div>üìÖ Ultima calibrazione: <strong>' + (d.last_calibration ? new Date(d.last_calibration).toLocaleDateString('it') : 'Mai') + '</strong></div>';
        // Precompila form
        if (bal !== null) document.getElementById('ai-cal-balance').value = bal;
        if (d.auto_recharge !== undefined) document.getElementById('ai-cal-recharge').value = String(d.auto_recharge);
        if (d.recharge_amount) document.getElementById('ai-cal-amount').value = d.recharge_amount;
        if (d.recharge_threshold) document.getElementById('ai-cal-threshold').value = d.recharge_threshold;
    } catch(e) {
        console.error('AI Budget error:', e);
        document.getElementById('ai-est-balance').textContent = 'Errore';
        document.getElementById('ai-balance-status').textContent = e.message;
    }
}

async function calibrateBalance() {
    var balance = parseFloat(document.getElementById('ai-cal-balance').value);
    if (isNaN(balance) || balance < 0) {
        document.getElementById('ai-cal-result').innerHTML = '<span style="color:#f87171">Inserisci un valore valido</span>';
        return;
    }
    try {
        const r = await fetch(API + '/finance/ai-balance/calibrate', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                balance_usd: balance,
                auto_recharge: document.getElementById('ai-cal-recharge').value === 'true',
                recharge_amount: parseFloat(document.getElementById('ai-cal-amount').value) || 15,
                recharge_threshold: parseFloat(document.getElementById('ai-cal-threshold').value) || 5
            })
        });
        const d = await r.json();
        if (d.success) {
            document.getElementById('ai-cal-result').innerHTML = '<span style="color:#4ade80">‚úÖ ' + d.message + '</span>';
            loadAIBudgetAdmin();
        } else {
            document.getElementById('ai-cal-result').innerHTML = '<span style="color:#f87171">Errore</span>';
        }
    } catch(e) {
        document.getElementById('ai-cal-result').innerHTML = '<span style="color:#f87171">' + e.message + '</span>';
    }
}
// ‚îÄ‚îÄ FINE AI BUDGET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const T = (key, rep) => typeof i18n !== 'undefined' && i18n.isLoaded() ? i18n.t(key, rep) : key;
</script>
<script src="/assets/theme.js"></script>
</body>
</html>
